<Plugin name="ComplexPricingEngine">
  <UserExits>
    <UserExit name="UserExitSkipCurrentCalcStep" asynchronous="false">
      <Parameters>
        <Parameter name="OrderAttributes" description="Attributes of current Order" type="Object" />
        <Parameter name="UserExitId" description="Id of User Exit as defined in Calculation Schema" type="Object" />
        <Parameter name="VariantAttributes" description="V1-V6 Attributes" type="Object" />
        <Parameter name="ProductAttributes" description="Attributes of current item (If header step, dictionary of all items)" type="Object" />
      </Parameters>
      <Return name="SkipCalcStep" description="Boolean flag is step should be skipped" value="SkipCalcStep" />
    </UserExit>
    <UserExit name="UserExitAffectCurrentConditionBase" asynchronous="false">
      <Parameters>
        <Parameter name="OrderAttributes" description="Attributes of current Order" type="Object" />
        <Parameter name="UserExitId" description="Id of User Exit as defined in Calculation Schema" type="Object" />
        <Parameter name="CurrentCalcStepAttributes" description="Details of current calculation step" type="Object" />
        <Parameter name="VariantAttributes" description="V1-V6 Atrtibutes" type="Object" />
        <Parameter name="ModifiedBase" description="Object including calc- and scale-base" type="Object" />
        <Parameter name="CurrentTotal" description="CurrentTotal" type="Object" />
        <Parameter name="ProductAttributes" description="Attributes of current item (If header step, dictionary of all items)" type="Object" />
      </Parameters>
      <Return name="ModifiedBases" description="Object which includes modified CalculationBase and modfied ScaleBase" value="ModifiedBases" />
    </UserExit>
    <UserExit name="UserExitAffectCalculationResult" asynchronous="false">
      <Parameters>
        <Parameter name="OrderAttributes" description="Attributes of current Order" type="Object" />
        <Parameter name="UserExitId" description="Id of User Exit as defined in Calculation Schema" type="Object" />
        <Parameter name="CurrentCalcStepAttributes" description="Current Calc Step Data" type="Object" />
        <Parameter name="VariantAttributes" description="V1-V6 Attributes" type="Object" />
        <Parameter name="AffectableResults" description="Affectable calculation data" type="Object" />
        <Parameter name="ProductAttributes" description="Attributes of current item (If header step, dictionary of all items)" type="Object" />
      </Parameters>
      <Return name="AffectedResults" description="Object which contains affected results of calculation" value="AffectedResults" />
    </UserExit>
    <UserExit name="UserExitSkipCurrentSearchStrategyStep" asynchronous="false">
      <Parameters>
        <Parameter name="OrderAttributes" description="Attributes of current Order" type="Object" />
        <Parameter name="UserExitId" description="Id of User Exit as defined in Calculation Schema" type="Object" />
        <Parameter name="VariantAttributes" description="V1-V6 Attributes" type="Object" />
        <Parameter name="ProductAttributes" description="Attributes of current item (If header step, dictionary of all items)" type="Object" />
      </Parameters>
      <Return name="SkipSearchStep" description="Defines if current SearchStrategy Step should be skiped" value="SkipSearchStep" />
    </UserExit>
  </UserExits>
<Code language="text/javascript">
<![CDATA[var CP;(()=>{"use strict";var e={411:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ContextHandler=void 0;var n=r(346),i=function(){function e(){if(this.dicUoMs=new n.Dictionary,e._instance)throw new Error("Error: Instantiation failed: Use ContextHandler.getInstance() instead of new.");e._instance=this}return e.getInstance=function(){return void 0===e._instance&&(e._instance=new e),e._instance},e.prototype.initContext=function(e){this.contextJSON=e},e.prototype.getOrderInformation=function(){if(Utils.isDefined(this.contextJSON)&&Utils.isDefined(this.contextJSON.orderInformation))return this.contextJSON.orderInformation},e.prototype.getOrderItems=function(){if(Utils.isDefined(this.contextJSON)&&Utils.isDefined(this.contextJSON.orderItems)){for(var e=this.contextJSON.orderItems,t=[],r=0;r<e.length;r++)t.push({SdoItemPKey:e[r].pKey,VariantAttributes:e[r].VariantAttributes});return{OrderItems:e,VariantAttributes:t}}},e.prototype.getCalculationSteps=function(){var e=[];return Utils.isDefined(this.contextJSON)&&Utils.isDefined(this.contextJSON.calculationSteps)&&(e=this.contextJSON.calculationSteps),e},e.prototype.getKeyTypes=function(){var e=[];return Utils.isDefined(this.contextJSON)&&Utils.isDefined(this.contextJSON.keyTypes)&&(e=this.contextJSON.keyTypes),e},e.prototype.getItemMetaRules=function(){var e=[];return Utils.isDefined(this.contextJSON)&&Utils.isDefined(this.contextJSON.itemMetaRules)&&(e=this.contextJSON.itemMetaRules),e},e.prototype.getCustomerInformation=function(){var e={};return Utils.isDefined(this.contextJSON)&&Utils.isDefined(this.contextJSON.customerAttributes)&&(e=this.contextJSON.customerAttributes),[e]},e.prototype.getCustomerHierarchy=function(){var e={};return Utils.isDefined(this.contextJSON)&&Utils.isDefined(this.contextJSON.customerHierarchy)&&(e=this.contextJSON.customerHierarchy),[e]},e.prototype.getCustomerSets=function(){var e=[];return Utils.isDefined(this.contextJSON)&&Utils.isDefined(this.contextJSON.customerSets)&&(e=this.contextJSON.customerSets),e},e.prototype.getCustomerPromotions=function(){var e=[];return Utils.isDefined(this.contextJSON)&&Utils.isDefined(this.contextJSON.customerPromotions)&&(e=this.contextJSON.customerPromotions),e},e.prototype.getCustomerRewards=function(){var e=[];return Utils.isDefined(this.contextJSON)&&Utils.isDefined(this.contextJSON.customerRewards)&&(e=this.contextJSON.customerRewards),e},e.prototype.getProductInformation=function(e){var t=e.replaceAll("'","").split(","),r=[],n=this.contextJSON.productInformation;if(Utils.isDefined(e)&&e.length>0&&Utils.isDefined(n)&&n.length>0)for(var i=0;i<t.length;i++)for(var a=0;a<n.length;a++)if(t[i]===n[a].PKey){r.push(n[a]),this.dicUoMs.contains(n[a].PKey)||this.dicUoMs.add(n[a].PKey,n[a].UoM);break}return r},e.prototype.getProductUoM=function(e){var t=[];return Utils.isDefined(this.dicUoMs)&&Utils.isDefined(this.dicUoMs.getItem(e))&&(t=this.dicUoMs.getItem(e)),t},e}();t.ContextHandler=i},722:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.API=void 0;var n=r(121),i=r(346),a=r(601),o=r(503),s=r(575),c=r(503),u=r(744),l=r(237),d=r(778),p=function(){function e(){if(this.CACHE_DicSearchStrategy=new i.Dictionary,this.CACHE_DicCalculationSteps=new i.Dictionary,this.CACHE_DicCalcStepsOrder=new i.Dictionary,this.CACHE_UnitFactorCache=new a.UoMConversionFactorCache,this.CACHE_ProductData=new i.Dictionary,this.CACHE_ProductHierarchy=new i.Dictionary,this.CACHE_ProductSets=new i.Dictionary,this.CLASS_NAME="API",this.dbAccessCounter=0,this.listUsedSearchStrategies=new i.List,e._instance)throw new Error("Error: Instantiation failed: Use API.getInstance() instead of new.");e._instance=this,this.dConditionCache=new i.Dictionary}return e.getInstance=function(){return void 0===e._instance&&(e._instance=new e),e._instance},e.prototype.clearCaches=function(){this.CACHE_DicCalcStepsOrder.clear(),this.CACHE_DicCalculationSteps.clear(),this.CACHE_DicSearchStrategy.clear(),this.dConditionCache.clear(),AppLog.info("worked in tested enviorment")},e.prototype.readCalculationStepsForSchema=function(t){var r;l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("readCalculationStepsForSchema",e.getInstance().CLASS_NAME),this.currentCalcSchema=new c.CalculationSchema(t);var a,u=new i.List;if(this.bOverallRecalcRequired=!1,this.listUsedSearchStrategies.clear(),i.isDefined(this.CACHE_DicCalculationSteps.getItem(t)))a=this.CACHE_DicCalculationSteps.getItem(t),u=this.CACHE_DicCalcStepsOrder.getItem(t),this.currentCalcSchema.dicCalcSteps=a,this.currentCalcSchema.listCalcSteps=u,(a=e.getInstance().currentCalcSchema.dicCalcSteps).forEach((function(e){!this.bOverallRecalcRequired&&(e.IsHeaderCondition&&e.DistributeToItem||e.ItemGrouping)&&(this.bOverallRecalcRequired=!0)})),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Calculation steps read from cache: "+t),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readCalculationStepsForSchema",e.getInstance().CLASS_NAME),r=when.resolve(e.getInstance().currentCalcSchema);else{a=new i.Dictionary;var p=0,h=s.SQL.CndCpReadCalculationStepsView(t);r=(0,d.readData)(l.SETTINGS.PRICING_DATASOURCE,h[0],h[1]).then((function(r){for(var i,s=r,c=0;c<s.length;c++){i=s[c];var d=new o.CalculationStep(i,p);p+=d.NeededColumns,e.getInstance().currentCalcSchema.IsPDARelevant=d.IsPDARelevant,(d.IsHeaderCondition&&d.DistributeToItem||d.ItemGrouping)&&(e.getInstance().bOverallRecalcRequired=!0),u.add(d.StepNumber),a.add(d.StepNumber,d),e.getInstance().listUsedSearchStrategies.contains(d.CndCpSearchStrategyPKey)||e.getInstance().listUsedSearchStrategies.add(d.CndCpSearchStrategyPKey),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Calculation step created: "+d.StepNumber+"  "+d.CndCpMetaId)}return e.getInstance().CACHE_DicCalculationSteps.add(t,a),e.getInstance().CACHE_DicCalcStepsOrder.add(t,u),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Calculation Schema created: "+t),e.getInstance().currentCalcSchema.dicCalcSteps=a,e.getInstance().currentCalcSchema.listCalcSteps=u,e.getInstance().readSearchStrategySteps(e.getInstance().listUsedSearchStrategies)})).then((function(t){return e.getInstance().currentCalcSchema.dicCalcSteps.forEach((function(t){t.KeyTypes=e.getInstance().CACHE_DicSearchStrategy.getItem(t.CndCpSearchStrategyPKey)})),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Calculation steps updated with key types of search strategies."),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readCalculationStepsForSchema",e.getInstance().CLASS_NAME),e.getInstance().currentCalcSchema}))}return r},e.prototype.readSearchStrategySteps=function(t){l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("readSearchStrategySteps",e.getInstance().CLASS_NAME);for(var r=new i.List,a=when.resolve(r),o=new Array,u=0;u<t.length;u++)e.getInstance().CACHE_DicSearchStrategy.contains(t.getItem(u))||o.push(t.getItem(u));if(o.length>0){var p=s.SQL.CndCpReadKeyTypes(i.arrayToCommaSeperatedList(o));a=(0,d.readData)(l.SETTINGS.PRICING_DATASOURCE,p[0],p[1]).then((function(t){var a,o,s=t,u="";r=new i.List;for(var d=0;d<s.length;d++)u!==(a=s[d]).CndCpSearchStrategyPKey?(r.length>0&&(e.getInstance().CACHE_DicSearchStrategy.add(u,r),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Search Strategy created: "+u)),u=a.CndCpSearchStrategyPKey,r=new i.List,(o=new c.KeyType(a)).ConsiderBpaSet&&(e.getInstance().currentCalcSchema.hasBpaSets=!0),o.ConsiderPromotion&&(e.getInstance().currentCalcSchema.hasAutoGrantedPromotions=!0),o.ConsiderReward&&(e.getInstance().currentCalcSchema.hasRewards=!0),o.ConsiderPrdSet&&(e.getInstance().currentCalcSchema.hasPrdAssortments=!0),r.add(o),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("KeyType created: "+o.KeyTypeId)):(o=new c.KeyType(a),r.add(o),o.ConsiderBpaSet&&(e.getInstance().currentCalcSchema.hasBpaSets=!0),o.ConsiderPromotion&&(e.getInstance().currentCalcSchema.hasAutoGrantedPromotions=!0),o.ConsiderReward&&(e.getInstance().currentCalcSchema.hasRewards=!0),o.ConsiderPrdSet&&(e.getInstance().currentCalcSchema.hasPrdAssortments=!0),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("KeyType created: "+o.KeyTypeId));return r.length>0&&(e.getInstance().CACHE_DicSearchStrategy.add(u,r),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Search Strategy added: "+u)),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readSearchStrategySteps",e.getInstance().CLASS_NAME),r}))}return a},e.prototype.readItemMetaRules=function(t){l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("readItemMetaRules",e.getInstance().CLASS_NAME);for(var r=new i.Dictionary,a=new Array,o=0;o<t.length;o++)a.push(t.getItem(o));var c=s.SQL.CndCpReadItemMetaUsage(i.arrayToCommaSeperatedList(a)),u=(0,d.readData)(l.SETTINGS.PRICING_DATASOURCE,c[0],c[1]).then((function(t){for(var a,o=t,s="",c=0;c<o.length;c++)s=(a=o[c]).CndCpItemMetaRulePKey,r.contains(s)||r.add(s,new i.Dictionary),r.getItem(s).add(a.SdoItemMetaPKey,a.Effect);return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readItemMetaRules",e.getInstance().CLASS_NAME),r}));return u},e.prototype.readAutoGrantedPromotions=function(t,r){l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("readAutoGrantedPromotions",e.getInstance().CLASS_NAME);var i=[],a=s.SQL.CndCpReadPromotions(t,r,u.CalcMatrix.getInstance().CurrentPricingDate);return(0,d.readData)(l.SETTINGS.PRICING_DATASOURCE,a[0],a[1]).then((function(t){for(var r=t,a=0;a<r.length;a++)i.push(r[a].PromotionPrmMainPKey);return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readAutoGrantedPromotions",e.getInstance().CLASS_NAME),i}))},e.prototype.readRelevantPromotionRewards=function(t,r){l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("readRelevantPromotionRewards",e.getInstance().CLASS_NAME);var i=s.SQL.CndCpReadRewards(t,r);return(0,d.readData)(l.SETTINGS.PRICING_DATASOURCE,i[0],i[1]).then((function(t){return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readRelevantPromotionRewards",e.getInstance().CLASS_NAME),t}))},e.prototype.readCurrencyConversionFactor=function(t,r,i){var a;l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("readCurrencyConversionFactor",e.getInstance().CLASS_NAME),a={conversionFactor:-1,conversionFactorAmount:1,invertedCurrencyConversion:!0};var o=s.SQL.CndCpReadCurrencyConversionFactor(t,r,i);return(0,d.readData)(l.SETTINGS.PRICING_DATASOURCE,o[0],o[1]).then((function(o){var c=o;if(c.length>0&&(a.conversionFactor=c[0].Ratio,a.conversionFactorAmount=c[0].Amount,a.invertedCurrencyConversion=!1),a.invertedCurrencyConversion){var u=s.SQL.CndCpReadCurrencyConversionFactor(r,t,i);return(0,d.readData)(l.SETTINGS.PRICING_DATASOURCE,u[0],u[1]).then((function(t){var r=t;return r.length>0&&(a.conversionFactor=r[0].Ratio,a.conversionFactorAmount=r[0].Amount),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readCurrencyConversionFactor",e.getInstance().CLASS_NAME),a}))}return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readCurrencyConversionFactor",e.getInstance().CLASS_NAME),a}))},e.prototype.readUnitConversionFactors=function(t,r){l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("readUnitConversionFactors",e.getInstance().CLASS_NAME);var i=s.SQL.CndCpReadUnitConversion(t);return(0,d.readData)(l.SETTINGS.PRICING_DATASOURCE,i[0],i[1]).then((function(i){var a=i;0<a.length&&e.getInstance().CACHE_UnitFactorCache.addProduct(t,r,a),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readUnitConversionFactors",e.getInstance().CLASS_NAME)}))},e.prototype.readCustomerInformation=function(t){l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("readCustomerInformation",e.getInstance().CLASS_NAME);var r=s.SQL.CndCpReadCustomerAttributes(t);return(0,d.readData)(l.SETTINGS.PRICING_DATASOURCE,r[0],r[1]).then((function(t){var r=t;return 0<r.length?(l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readCustomerInformation",e.getInstance().CLASS_NAME),r[0]):(l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readCustomerInformation",e.getInstance().CLASS_NAME),null)}))},e.prototype.readCustomerHierarchy=function(t,r){l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("readCustomerHierarchy",e.getInstance().CLASS_NAME);var a=new i.Dictionary,o=s.SQL.CndCpReadCustomerHierarchy(t,Utils.convertDate2Ansi(r));return(0,d.readData)(l.SETTINGS.PRICING_DATASOURCE,o[0],o[1]).then((function(o){var c=o;if(c.length>0){var u=c[0];if(i.isDefined(u.Account_Level_01__c)&&i.isDefined(u.Account_Level_02__c)&&i.isDefined(u.Account_Level_03__c)&&i.isDefined(u.Account_Level_04__c)&&i.isDefined(u.Account_Level_05__c)&&i.isDefined(u.Account_Level_06__c)&&i.isDefined(u.Account_Level_07__c)&&i.isDefined(u.Account_Level_08__c))return!Utils.isEmptyString(u.Account_Level_01__c)&&u.Account_Level_01__c!==t&&Utils.isDefined(u.OrgLevel1)&&a.add(u.OrgLevel1,u.Account_Level_01__c),!Utils.isEmptyString(u.Account_Level_02__c)&&u.Account_Level_02__c!==t&&Utils.isDefined(u.OrgLevel2)&&a.add(u.OrgLevel2,u.Account_Level_02__c),!Utils.isEmptyString(u.Account_Level_03__c)&&u.Account_Level_03__c!==t&&Utils.isDefined(u.OrgLevel3)&&a.add(u.OrgLevel3,u.Account_Level_03__c),!Utils.isEmptyString(u.Account_Level_04__c)&&u.Account_Level_04__c!==t&&Utils.isDefined(u.OrgLevel4)&&a.add(u.OrgLevel4,u.Account_Level_04__c),!Utils.isEmptyString(u.Account_Level_05__c)&&u.Account_Level_05__c!==t&&Utils.isDefined(u.OrgLevel5)&&a.add(u.OrgLevel5,u.Account_Level_05__c),!Utils.isEmptyString(u.Account_Level_06__c)&&u.Account_Level_06__c!==t&&Utils.isDefined(u.OrgLevel6)&&a.add(u.OrgLevel6,u.Account_Level_06__c),!Utils.isEmptyString(u.Account_Level_07__c)&&u.Account_Level_07__c!==t&&Utils.isDefined(u.OrgLevel7)&&a.add(u.OrgLevel7,u.Account_Level_07__c),!Utils.isEmptyString(u.Account_Level_08__c)&&u.Account_Level_08__c!==t&&Utils.isDefined(u.OrgLevel8)&&a.add(u.OrgLevel8,u.Account_Level_08__c),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readCustomerHierarchy",e.getInstance().CLASS_NAME),a;if(c[0].FromPKey!==c[0].ToPKey){a.add(c[0].FromOrgLevel,c[0].FromPKey);var d=s.SQL.CndCpReadCustomerHierarchy(c[0].FromPKey,Utils.convertDate2Ansi(r));return Facade.selectSQL(l.SETTINGS.PRICING_DATASOURCE,d[0],d[1]).then((function(t){var i=t;if(0<i.length&&i[0].FromPKey!==i[0].ToPKey){a.add(i[0].FromOrgLevel,i[0].FromPKey);var o=s.SQL.CndCpReadCustomerHierarchy(i[0].FromPKey,Utils.convertDate2Ansi(r));return Facade.selectSQL(l.SETTINGS.PRICING_DATASOURCE,o[0],o[1]).then((function(t){var i=t;if(0<i.length&&i[0].FromPKey!==i[0].ToPKey){a.add(i[0].FromOrgLevel,i[0].FromPKey);var o=s.SQL.CndCpReadCustomerHierarchy(i[0].FromPKey,Utils.convertDate2Ansi(r));return Facade.selectSQL(l.SETTINGS.PRICING_DATASOURCE,o[0],o[1]).then((function(t){var i=t;if(0<i.length&&i[0].FromPKey!==i[0].ToPKey){a.add(i[0].FromOrgLevel,i[0].FromPKey);var o=s.SQL.CndCpReadCustomerHierarchy(i[0].FromPKey,Utils.convertDate2Ansi(r));return Facade.selectSQL(l.SETTINGS.PRICING_DATASOURCE,o[0],o[1]).then((function(t){var i=t;if(0<i.length&&i[0].FromPKey!==i[0].ToPKey){a.add(i[0].FromOrgLevel,i[0].FromPKey);var o=s.SQL.CndCpReadCustomerHierarchy(i[0].FromPKey,Utils.convertDate2Ansi(r));return Facade.selectSQL(l.SETTINGS.PRICING_DATASOURCE,o[0],o[1]).then((function(t){var i=t;if(0<i.length&&i[0].FromPKey!==i[0].ToPKey){a.add(i[0].FromOrgLevel,i[0].FromPKey);var o=s.SQL.CndCpReadCustomerHierarchy(i[0].FromPKey,Utils.convertDate2Ansi(r));return Facade.selectSQL(l.SETTINGS.PRICING_DATASOURCE,o[0],o[1]).then((function(t){var i=t;if(0<i.length&&i[0].FromPKey!==i[0].ToPKey){a.add(i[0].FromOrgLevel,i[0].FromPKey);var o=s.SQL.CndCpReadCustomerHierarchy(i[0].FromPKey,Utils.convertDate2Ansi(r));return Facade.selectSQL(l.SETTINGS.PRICING_DATASOURCE,o[0],o[1]).then((function(t){return 0<i.length&&i[0].FromPKey!==i[0].ToPKey&&a.add(i[0].FromOrgLevel,i[0].FromPKey),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readCustomerHierarchy",e.getInstance().CLASS_NAME),a}))}return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readCustomerHierarchy",e.getInstance().CLASS_NAME),a}))}return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readCustomerHierarchy",e.getInstance().CLASS_NAME),a}))}return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readCustomerHierarchy",e.getInstance().CLASS_NAME),a}))}return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readCustomerHierarchy",e.getInstance().CLASS_NAME),a}))}return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readCustomerHierarchy",e.getInstance().CLASS_NAME),a}))}return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readCustomerHierarchy",e.getInstance().CLASS_NAME),a}))}return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readCustomerHierarchy",e.getInstance().CLASS_NAME),a}return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readCustomerHierarchy",e.getInstance().CLASS_NAME),a}))},e.prototype.readBpaSets=function(t,r){l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("readBpaSets",e.getInstance().CLASS_NAME);var i=s.SQL.CndCpReadBpaSetsView(t,r);return(0,d.readData)(l.SETTINGS.PRICING_DATASOURCE,i[0],i[1]).then((function(t){for(var r=t,i=[],a=0;a<r.length;a++)i.push(r[a].BpaSetPKey);return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readBpaSets",e.getInstance().CLASS_NAME),i}))},e.prototype.readProductInformation=function(t,r,a,o){l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("readProductInformation",e.getInstance().CLASS_NAME);var c=s.SQL.CndCpReadProcuctAttributes(t);return(0,d.readData)(l.SETTINGS.PRICING_DATASOURCE,c[0],c[1]).then((function(t){var r=t;if(0<r.length)for(var a=0;a<r.length;a++){var o=new i.Dictionary,s=r[a];for(var c in s)o.add(c.toString(),s[c].toString());e.getInstance().CACHE_ProductData.add(o.getItem("PKey"),o),e.getInstance().CACHE_ProductHierarchy.add(o.getItem("PKey"),[o.getItem("Criterion1PKey"),o.getItem("Criterion2PKey"),o.getItem("Criterion3PKey"),o.getItem("Criterion4PKey"),o.getItem("Criterion5PKey"),o.getItem("Criterion6PKey")])}l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readProductInformation",e.getInstance().CLASS_NAME)}))},e.prototype.readConditions=function(t){var r;return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("readConditions",e.getInstance().CLASS_NAME),!Utils.isDefined(t)||t.length<1?(l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readConditions",e.getInstance().CLASS_NAME),r=when.resolve(!1)):r=Facade.conditionSearchAsync(t).then((function(t){if(Utils.isDefined(t)&&t instanceof Array)for(var r=0;r<t.length;r++){var i=t[r],a={};4===i.length?(a.runtime=i[3],e.getInstance().addCondition(i[0],i[1],i[2],a)):5===i.length&&(a.runtime=i[3],a.condition=i[4].con,e.getInstance().addCondition(i[0],i[1],i[2],a))}return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readConditions",e.getInstance().CLASS_NAME),!0})),r},e.prototype.addCondition=function(e,t,r,n){this.dConditionCache.contains(e+t+r)||(this.dConditionCache.add(e+t+r,n),this.dConditionCache.length%l.SETTINGS.LOG_CONDITION_CACHE_STEP_SIZE==0&&l.SETTINGS.LOG_ENABLED&&this.dumpConditionCacheSize())},e.prototype.getCondition=function(e,t,r){return this.dConditionCache.contains(e+t+r)?this.dConditionCache.getItem(e+t+r):null},e.prototype.hasCondition=function(e,t,r){return!(!this.dConditionCache.contains(e+t+r)||!Utils.isDefined(this.dConditionCache.getItem(e+t+r)))},e.prototype.dumpConditionCache=function(){n.LogHandler.getInstance().message("###################  --\x3e CONDITION CACHE (size: "+this.dConditionCache.length+") ###################"),Utils.isDefined(AppLog)&&Utils.isDefined(AppLog.info)&&AppLog.info(JSON.stringify(this.dConditionCache)),n.LogHandler.getInstance().message("###################  CONDITION CACHE  <-- ###################")},e.prototype.dumpConditionCacheSize=function(){n.LogHandler.getInstance().message("###################  --\x3e CONDITION CACHE (size: "+this.dConditionCache.length+")  <-- ################### ")},e.prototype.dumpSearchStrategyCache=function(){n.LogHandler.getInstance().message("###################  --\x3e SEARCH STRATEGY CACHE  ###################"),Utils.isDefined(AppLog)&&Utils.isDefined(AppLog.info)&&AppLog.info(JSON.stringify(this.CACHE_DicSearchStrategy)),n.LogHandler.getInstance().message("###################  SEARCH STRATEGY CACHE <--  ###################")},e.prototype.dumpCalculationStepsCache=function(){n.LogHandler.getInstance().message("###################  --\x3e CALCULATION STEPS CACHE  ###################"),Utils.isDefined(AppLog)&&Utils.isDefined(AppLog.info)&&AppLog.info(JSON.stringify(this.CACHE_DicCalculationSteps)),n.LogHandler.getInstance().message("###################  CALCULATION STEPS CACHE  <-- ###################")},e.prototype.dumpCalcStepsOrderCache=function(){n.LogHandler.getInstance().message("###################  --\x3e CALCULATION STEPS ORDER CACHE  ###################"),Utils.isDefined(AppLog)&&Utils.isDefined(AppLog.info)&&AppLog.info(JSON.stringify(this.CACHE_DicCalcStepsOrder)),n.LogHandler.getInstance().message("###################  CALCULATION STEPS ORDER CACHE <-- ###################")},e.prototype.dumpUnitFactorCache=function(){n.LogHandler.getInstance().message("###################  --\x3e UNIT FACTOR CACHE  ###################"),Utils.isDefined(AppLog)&&Utils.isDefined(AppLog.info)&&AppLog.info(JSON.stringify(this.CACHE_UnitFactorCache)),n.LogHandler.getInstance().message("###################   UNIT FACTOR CACHE <-- ###################")},e.prototype.dumpProductDataCache=function(){n.LogHandler.getInstance().message("###################  --\x3e PRODUCT DATA CACHE  ###################"),Utils.isDefined(AppLog)&&Utils.isDefined(AppLog.info)&&AppLog.info(JSON.stringify(this.CACHE_ProductData)),n.LogHandler.getInstance().message("###################   PRODUCT DATA CACHE <-- ###################")},e.prototype.dumpProductHierarchyCache=function(){n.LogHandler.getInstance().message("###################  --\x3e PRODUCT HIERARCHY CACHE  ###################"),Utils.isDefined(AppLog)&&Utils.isDefined(AppLog.info)&&AppLog.info(JSON.stringify(this.CACHE_ProductHierarchy)),n.LogHandler.getInstance().message("###################   PRODUCT HIERARCHY CACHE  <-- ###################")},e.prototype.dumpProductSetsCache=function(){n.LogHandler.getInstance().message("###################  --\x3e PRODUCT SETS CACHE  ###################"),Utils.isDefined(AppLog)&&Utils.isDefined(AppLog.info)&&AppLog.info(JSON.stringify(this.CACHE_ProductSets)),n.LogHandler.getInstance().message("###################   PRODUCT SETS CACHE <-- ###################")},e.prototype.dumpAllCaches=function(){this.dumpConditionCache(),this.dumpSearchStrategyCache(),this.dumpCalculationStepsCache(),this.dumpCalcStepsOrderCache(),this.dumpUnitFactorCache(),this.dumpProductDataCache(),this.dumpProductHierarchyCache(),this.dumpProductSetsCache()},e}();t.API=p},778:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.readData=void 0;var n=r(411),i=r(237),a=r(510),o=r(121);t.readData=function(e,t,r){var s;if(i.SETTINGS.LOG_ENABLED&&o.LogHandler.getInstance().start("readData","DataWrapper"),a.contextMode){var c=void 0;switch(t){case i.SETTINGS.QueryNames.CALCULATIONSTEPS:c=n.ContextHandler.getInstance().getCalculationSteps();break;case i.SETTINGS.QueryNames.KEYTYPES:c=n.ContextHandler.getInstance().getKeyTypes();break;case i.SETTINGS.QueryNames.ITEMMETARULES:c=n.ContextHandler.getInstance().getItemMetaRules();break;case i.SETTINGS.QueryNames.CUSTOMERATTRIBUTES:c=n.ContextHandler.getInstance().getCustomerInformation();break;case i.SETTINGS.QueryNames.CUSTOMERHIERARCHY:c=n.ContextHandler.getInstance().getCustomerHierarchy();break;case i.SETTINGS.QueryNames.CUSTOMERSETS:c=n.ContextHandler.getInstance().getCustomerSets();break;case i.SETTINGS.QueryNames.CUSTOMERPROMOTIONS:c=n.ContextHandler.getInstance().getCustomerPromotions();break;case i.SETTINGS.QueryNames.CUSTOMERREWARDS:c=n.ContextHandler.getInstance().getCustomerRewards();break;case i.SETTINGS.QueryNames.PRODUCTINFORMATION:c=n.ContextHandler.getInstance().getProductInformation(r.PrdMainPKey);break;case i.SETTINGS.QueryNames.PRODUCTUNITFACTORS:c=n.ContextHandler.getInstance().getProductUoM(r.ProductPKey);break;case i.SETTINGS.QueryNames.CURRENCYCONVERSION:c=[{Ratio:1,Amount:1}]}s=when.resolve(c)}else s=Facade.selectSQL(e,t,r);return i.SETTINGS.LOG_ENABLED&&o.LogHandler.getInstance().end("readData","DataWrapper"),s}},575:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SQL=void 0;var n,i=r(237);(n=t.SQL||(t.SQL={})).CndCpReadCalculationStepsView=function(e){var t=new Array;return t.push(i.SETTINGS.QueryNames.CALCULATIONSTEPS),t.push({CndCpCalculationSchemaPKey:e}),t},n.CndCpReadBpaSetsView=function(e,t){var r=new Array;return r.push(i.SETTINGS.QueryNames.CUSTOMERSETS),r.push({CustomerPKey:e,CalculationSchemaPKey:t}),r},n.CndCpReadKeyTypes=function(e){var t=new Array;return t.push(i.SETTINGS.QueryNames.KEYTYPES),t.push({SearchStrategyList:e}),t},n.CndCpReadItemMetaUsage=function(e){var t=new Array;return t.push(i.SETTINGS.QueryNames.ITEMMETARULES),t.push({CndCpItemMetaRulePKeyList:e}),t},n.CndCpReadCurrencyConversionFactor=function(e,t,r){var n=new Array;return n.push(i.SETTINGS.QueryNames.CURRENCYCONVERSION),n.push({FromCode:e,ToCode:t,PricingDate:Utils.convertDate2Ansi(r)}),n},n.CndCpReadPromotions=function(e,t,r){var n=new Array;return n.push(i.SETTINGS.QueryNames.CUSTOMERPROMOTIONS),n.push({CustomerPKey:e,pricingdate:Utils.convertDate2Ansi(r),CalculationSchemaPKey:t}),n},n.CndCpReadRewards=function(e,t){var r=new Array;return r.push(i.SETTINGS.QueryNames.CUSTOMERREWARDS),r.push({CustomerPKey:e,CalculationSchemaPKey:t}),r},n.CndCpReadCustomerHierarchy=function(e,t){var r=new Array;return r.push(i.SETTINGS.QueryNames.CUSTOMERHIERARCHY),r.push({CustomerPKey:e,pricingDate:t}),r},n.CndCpReadUnitConversion=function(e){var t=new Array;return t.push(i.SETTINGS.QueryNames.PRODUCTUNITFACTORS),t.push({ProductPKey:e}),t},n.CndCpReadCustomerAttributes=function(e){var t=new Array;return t.push(i.SETTINGS.QueryNames.CUSTOMERATTRIBUTES),t.push({BpaMainPKey:e}),t},n.CndCpReadProcuctAttributes=function(e){var t=new Array;return t.push(i.SETTINGS.QueryNames.PRODUCTINFORMATION),t.push({PrdMainPKey:e}),t},n.CndCpReadPrdAssortments=function(e,t,r){var n=new Array;return n.push(i.SETTINGS.QueryNames.PRODUCTASSORTMENTS),n.push({PrdMainPKey:e,PricingDate:Utils.convertDate2Ansi(t),CalculationSchemaPKey:r}),n}},510:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CalculationResult=t.PricingHandler=t.contextMode=void 0;var n=r(121),i=r(744),a=r(237),o=r(744),s=r(411),c=r(722),u=r(722),l=r(503),d=r(503),p=r(346),h=r(547),g=function(){function e(){if(this.o_CalcMatrix=null,this.o_CalculationResult=null,e._instance)throw new Error("Error: Instantiation failed: Use PricingHandler.getInstance() instead of new.");this.o_CalcMatrix=i.CalcMatrix.getInstance(),e._instance=this}return e.getInstance=function(){return void 0!==e._instance&&null!==e._instance||(e._instance=new e),e._instance},e.prototype.calculateOrderValueViaContext=function(e){a.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("calculateOrderValueViaContext","PricingHandler");var r=this;t.contextMode=!0;var i=s.ContextHandler.getInstance();i.initContext(e);var o=i.getOrderInformation();return r.initOrder(o.Id,o.Meta,o.Orderer,Utils.createDateNow(),o.Cur,o.SchemaId,o.Attributes,o.DiChnl,o.Division,o.VariantAttributes,o.Log).then((function(){var e=i.getOrderItems();return r.addProducts(e.OrderItems,e.VariantAttributes).then((function(){return r.updateOrder(o.PricingDate,o.Cur,o.Attributes),r.calculateOrderValue(void 0).then((function(e){return AppLog.info("result "+e),a.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("calculateOrderValueViaContext","PricingHandler"),e}))}))}))},e.prototype.initOrder=function(e,t,r,i,o,s,c,u,l,d,p){a.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("initOrder","PricingHandler");var h=this,g=this.o_CalcMatrix.init(e,t,r,i,o,s,c,u,l,p).then((function(){h.o_CalcMatrix.currentOrder.setVariantVariables(d),a.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("initOrder","PricingHandler")}));return h.OrderPKey=e,g},e.prototype.updateOrder=function(e,t,r){a.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("updateOrder","PricingHandler"),this.o_CalcMatrix.updateOrder(e,t,r),a.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("updateOrder","PricingHandler")},e.prototype.addProducts=function(e,t){a.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("addProducts","PricingHandler");var r=this;return r.o_CalcMatrix.addOrderItems(e),r.o_CalcMatrix.readProductAttributes().then((function(){i.CalcMatrix.getInstance().getConditionsSummedUpForCache();for(var e=0;e<t.length;e++)r.o_CalcMatrix.currentOrder.Items.getItem(t[e].SdoItemPKey).setVariantVariables(t[e].VariantAttributes);a.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("addProducts","PricingHandler")}))},e.prototype.updateProduct=function(e,t){return a.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("updateProduct","PricingHandler"),this.o_CalcMatrix.addOrUpdateOrderItem(e,t).then((function(){a.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("updateProduct","PricingHandler")}))},e.prototype.hasOrderItem=function(e){var t=!1;return i.CalcMatrix.getInstance().currentOrder&&(t=o.CalcMatrix.getInstance().currentOrder.Items.contains(e)),t},e.prototype.setVariantItemAttributes=function(e,t){this.o_CalcMatrix.currentOrder.Items.getItem(e).setVariantVariables(t)},e.prototype.calculateOrderValue=function(e){a.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("calculateOrderValue","PricingHandler");var t=this;return t.o_CalcMatrix.currentOrder.ItemFilterCallback=e,t.o_CalcMatrix.calculateOrderValue().then((function(e){return t.currentCalculationResult=e,a.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("calculateOrderValue","PricingHandler"),e}))},e.prototype.extractPriceValuesInList=function(e,t,r,n,i,a){for(var o=0;o++;o<e.length)e[o]=this.extractPriceValues(e[o],t,r,n,i,a);return e},e.prototype.extractPriceValues=function(e,t,r,n,i,a){try{var o=!1;if(e)for(var s=e[n],c=ConvertXmlToJson(e[t])[0],u=void 0,l=0;l<c.children.length;l++)if("cnd"===(u=c.children[l]).tagName&&Utils.convertAnsiDate2Date(u.attributes.f)<=i&&Utils.convertAnsiDate2Date(u.attributes.t)>=i&&u.attributes.u===s&&u.attributes.c===a)return e[r]=+u.attributes.v,o=!0,e;return o||(e[r]=0),e}catch(t){return e[r]=0,e}},e.prototype.updateRewardCache=function(e,t,r){this.o_CalcMatrix.currentOrder.updateRewardCache(e,t,"1"==r)},e}();t.PricingHandler=g;t.CalculationResult=function(){},e.exports={LogHandler:n.LogHandler,CalcMatrix:o.CalcMatrix,PricingHandler:g,Facade:c.Facade,API:u.API,CalculationSchema:l.CalculationSchema,CalculationStep:d.CalculationStep,CPUtils:p,Order:h.Order,ContextHandler:s.ContextHandler}},951:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DebugData=void 0;var n=r(346),i=r(237);!function(e){var t=function(){function e(){}return Object.defineProperty(e.prototype,"pCS",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pruntime",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pseeks",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pSdoMainPKey",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pGrossTotalVR",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pRCurr",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pTotalVR",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pMerchVR",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVString1",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVString2",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVString3",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVString4",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVString5",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal1",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal2",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal3",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal4",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal5",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pSdoMetaPKey",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pSdoMainId",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pOrdererBpaMainPKey",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pPayerBpaMainPKey",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pDeliBpaMainPKey",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pBillToBpaMainPKey",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pPricingDate",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pHCurr",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pConvRate",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCsPKey",{set:function(e){},enumerable:!1,configurable:!0}),e.prototype.addStepDebugData=function(e){},e.prototype.addVariantAttributesToJSON=function(e){},e}();e.EmptyHeaderDebugData=t;var r=function(){function e(e,t,r,n,i,a,o,s,c,u,l,d,p,h,g){this.SdoMetaPKey=t,this.SdoMainId=r,this.GrossTotalVR=n,this.OrdererBpaMainPKey=i,this.PayerBpaMainPKey=a,this.DeliBpaMainPKey=o,this.BillToBpaMainPKey=s,this.PricingDate=c,this.HCurr=u,this.ConvRate=d,this.CsPKey=p,this.TotalVR=h,this.MerchVR=g,this.SdoMainPKey=e,this.CS=[],this.RCurr=l,this.seeks=0,this.runtime=0}return Object.defineProperty(e.prototype,"pCS",{set:function(e){this.CS=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pruntime",{set:function(e){this.runtime=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pseeks",{set:function(e){this.seeks=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pSdoMainPKey",{set:function(e){this.SdoMainPKey=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pGrossTotalVR",{set:function(e){this.GrossTotalVR=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pRCurr",{set:function(e){this.RCurr=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pTotalVR",{set:function(e){this.TotalVR=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pMerchVR",{set:function(e){this.MerchVR=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVString1",{set:function(e){this.VString1=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVString2",{set:function(e){this.VString2=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVString3",{set:function(e){this.VString3=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVString4",{set:function(e){this.VString4=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVString5",{set:function(e){this.VString5=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal1",{set:function(e){this.VDecimal1=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal2",{set:function(e){this.VDecimal2=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal3",{set:function(e){this.VDecimal3=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal4",{set:function(e){this.VDecimal4=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal5",{set:function(e){this.VDecimal5=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pSdoMetaPKey",{set:function(e){this.SdoMetaPKey=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pSdoMainId",{set:function(e){this.SdoMainId=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pOrdererBpaMainPKey",{set:function(e){this.OrdererBpaMainPKey=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pPayerBpaMainPKey",{set:function(e){this.PayerBpaMainPKey=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pDeliBpaMainPKey",{set:function(e){this.DeliBpaMainPKey=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pBillToBpaMainPKey",{set:function(e){this.BillToBpaMainPKey=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pPricingDate",{set:function(e){this.PricingDate=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pHCurr",{set:function(e){this.HCurr=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pConvRate",{set:function(e){this.ConvRate=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCsPKey",{set:function(e){this.CsPKey=e},enumerable:!1,configurable:!0}),e.prototype.addStepDebugData=function(e){this.CS.push(e)},e.prototype.addVariantAttributesToJSON=function(e){this.VString1=e.getAttribute("VariantMainString1"),this.VString2=e.getAttribute("VariantMainString2"),this.VString3=e.getAttribute("VariantMainString3"),this.VString4=e.getAttribute("VariantMainString4"),this.VString5=e.getAttribute("VariantMainString5"),this.VDecimal1=e.getAttribute("VariantMainDecimal1"),this.VDecimal2=e.getAttribute("VariantMainDecimal2"),this.VDecimal3=e.getAttribute("VariantMainDecimal3"),this.VDecimal4=e.getAttribute("VariantMainDecimal4"),this.VDecimal5=e.getAttribute("VariantMainDecimal5")},e}();e.HeaderDebugData=r;var a=function(){function e(){}return Object.defineProperty(e.prototype,"pNo",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCT",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pMetaMetaID",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pTotal",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pResult",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pRef",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pstepType",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pScaleType",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pScaleBaseType",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pIsSubTotal",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pIsManual",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCndCpSearchStrategyPKey",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pStatistical",{set:function(e){},enumerable:!1,configurable:!0}),e}();e.EmptyHeaderItemStepDebugData=a;var o=function(){function e(e,t,r,n,i,a,o,s,c,u,l,d,p){this.No=e,this.CT=t,this.MetaMetaID=r,this.Total=n,this.Result=i,(Utils.isEmptyString(a)||"-1"===a)&&(this.Ref="None"),this.stepType=o,this.ScaleType=s,this.ScaleBaseType=c,this.IsSubTotal=u,this.IsManual=l,this.CndCpSearchStrategyPKey=d,this.Statistical=p}return Object.defineProperty(e.prototype,"pNo",{set:function(e){this.No=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCT",{set:function(e){this.CT=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pMetaMetaID",{set:function(e){this.MetaMetaID=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pTotal",{set:function(e){this.Total=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pResult",{set:function(e){this.Result=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pRef",{set:function(e){this.Ref=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pstepType",{set:function(e){this.stepType=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pScaleType",{set:function(e){this.ScaleType=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pScaleBaseType",{set:function(e){this.ScaleBaseType=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pIsSubTotal",{set:function(e){this.IsSubTotal=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pIsManual",{set:function(e){this.IsManual=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCndCpSearchStrategyPKey",{set:function(e){this.CndCpSearchStrategyPKey=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pStatistical",{set:function(e){this.Statistical=e},enumerable:!1,configurable:!0}),e}();e.HeaderItemStepDebugData=o;var s=function(){function e(){}return Object.defineProperty(e.prototype,"pSearchSteps",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pFound",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pSkippedByUserExit",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pStepSkipped",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pruntime",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCndCpSearchStrategyPKey",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pNo",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCT",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pMetaMetaID",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCndCpMetaPKey",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pRef",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCondition",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pScaleType",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pScaleBaseType",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCValue",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCResult",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pIsMandatory",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pMandatoryCndFound",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pMerchandiseValueReceipt",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pTotalValueReceipt",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pTotal",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pheaderConditionEffect",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pRoundingMode",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pDecimalPlaces",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pstepType",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pIsSubTotal",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pStatistical",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pIsManual",{set:function(e){},enumerable:!1,configurable:!0}),e.prototype.addSearchStep=function(e){},e}();e.EmptyHeaderStepDebugData=s;var c=function(){function e(e,t,r,n,i,a,o,s,c,u,l,d,p,h,g,C,f,I,S,m,y,b,P){this.Found=!1,this.SkippedByUserExit=!1,this.runtime=0,this.CndCpSearchStrategyPKey=e,this.No=t,this.CT=r,this.MetaMetaID=n,this.CndCpMetaPKey=i,this.Ref=a,this.Condition=o,this.ScaleType=s,this.ScaleBaseType=c,this.CValue=u,this.CResult=l,this.IsMandatory=d,this.MandatoryCndFound=p,this.MerchandiseValueReceipt=h,this.TotalValueReceipt=g,this.Total=C,this.headerConditionEffect=f,this.RoundingMode=I,this.DecimalPlaces=S,this.stepType=m,this.IsSubTotal=y,this.Statistical=b,this.IsManual=P,this.SearchSteps=[]}return Object.defineProperty(e.prototype,"pSearchSteps",{set:function(e){this.SearchSteps=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pFound",{set:function(e){this.Found=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pSkippedByUserExit",{set:function(e){this.SkippedByUserExit=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pStepSkipped",{set:function(e){this.StepSkipped=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pruntime",{set:function(e){this.runtime=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCndCpSearchStrategyPKey",{set:function(e){this.CndCpSearchStrategyPKey=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pNo",{set:function(e){this.No=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCT",{set:function(e){this.CT=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pMetaMetaID",{set:function(e){this.MetaMetaID=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCndCpMetaPKey",{set:function(e){this.CndCpMetaPKey=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pRef",{set:function(e){this.Ref=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCondition",{set:function(e){this.Condition=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pScaleType",{set:function(e){this.ScaleType=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pScaleBaseType",{set:function(e){this.ScaleBaseType=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCValue",{set:function(e){this.CValue=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCResult",{set:function(e){this.CResult=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pIsMandatory",{set:function(e){this.IsMandatory=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pMandatoryCndFound",{set:function(e){this.MandatoryCndFound=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pMerchandiseValueReceipt",{set:function(e){this.MerchandiseValueReceipt=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pTotalValueReceipt",{set:function(e){this.TotalValueReceipt=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pTotal",{set:function(e){this.Total=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pheaderConditionEffect",{set:function(e){this.headerConditionEffect=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pRoundingMode",{set:function(e){this.RoundingMode=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pDecimalPlaces",{set:function(e){this.DecimalPlaces=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pstepType",{set:function(e){this.stepType=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pIsSubTotal",{set:function(e){this.IsSubTotal=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pStatistical",{set:function(e){this.Statistical=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pIsManual",{set:function(e){this.IsManual=e},enumerable:!1,configurable:!0}),e.prototype.addSearchStep=function(e,t){if(void 0===t&&(t=!1),t){var r=this.SearchSteps.findIndex((function(t){return t.MKey==e.MKey}));r>-1?this.SearchSteps[r]=e.clone():this.SearchSteps.push(e.clone())}else this.SearchSteps.push(e.clone())},e}();e.HeaderStepDebugData=c;var u=function(){function e(){}return Object.defineProperty(e.prototype,"pVString1",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVString2",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVString3",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVString4",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVString5",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal1",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal2",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal3",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal4",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal5",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pseeks",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pSkippedByUserExit",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCS",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCurrencyConversionFactor",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pPKey",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pPrdMainPkey",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pSdoItemMetaPKey",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pProductId",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pName",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pUoM",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pQty",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pSplPrice",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pDiscount",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pTotal",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pItemType",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pBasePrice",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pItemPrice",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pItemValue",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pGrossValue",{set:function(e){},enumerable:!1,configurable:!0}),e.prototype.setQtyUoM=function(e,t){},e.prototype.addStep=function(e){},e.prototype.addVariantAttributesToJSON=function(e){},e}();e.EmptyItemDebugData=u;var l=function(){function e(e,t,r,n,i,a,o,s,c,u,l,d,p,h,g,C,f,I){this.PKey=e,this.PrdMainPkey=t,this.SdoItemMetaPKey=r,this.ProductId=n,this.Name=i,this.SelectablePromotionId=C,this.RewardId=f,this.ParentType=I,this.UoM=a,this.Qty=o,this.SplPrice=s,this.Discount=c,this.Total=u,this.ItemType=l,this.BasePrice=d,this.ItemPrice=p,this.ItemValue=h,this.GrossValue=g,this.CurrencyConversionFactor=0,this.seeks=0,this.CS=[]}return Object.defineProperty(e.prototype,"pVString1",{set:function(e){this.VString1=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVString2",{set:function(e){this.VString2=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVString3",{set:function(e){this.VString3=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVString4",{set:function(e){this.VString4=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVString5",{set:function(e){this.VString5=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal1",{set:function(e){this.VDecimal1=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal2",{set:function(e){this.VDecimal2=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal3",{set:function(e){this.VDecimal3=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal4",{set:function(e){this.VDecimal4=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pVDecimal5",{set:function(e){this.VDecimal5=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pseeks",{set:function(e){this.seeks=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pSkippedByUserExit",{set:function(e){this.SkippedByUserExit=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCS",{set:function(e){this.CS=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCurrencyConversionFactor",{set:function(e){this.CurrencyConversionFactor=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pPKey",{set:function(e){this.PKey=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pPrdMainPkey",{set:function(e){this.PrdMainPkey=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pSdoItemMetaPKey",{set:function(e){this.SdoItemMetaPKey=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pProductId",{set:function(e){this.ProductId=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pName",{set:function(e){this.Name=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pPromotionId",{set:function(e){this.ProductId=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pRewardId",{set:function(e){this.RewardId=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pParentType",{set:function(e){this.ParentType=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pUoM",{set:function(e){this.UoM=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pQty",{set:function(e){this.Qty=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pSplPrice",{set:function(e){this.SplPrice=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pDiscount",{set:function(e){this.Discount=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pTotal",{set:function(e){this.Total=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pItemType",{set:function(e){this.ItemType=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pBasePrice",{set:function(e){this.BasePrice=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pItemPrice",{set:function(e){this.ItemPrice=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pItemValue",{set:function(e){this.ItemValue=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pGrossValue",{set:function(e){this.GrossValue=e},enumerable:!1,configurable:!0}),e.prototype.setQtyUoM=function(e,t){this.Qty=e,this.UoM=t,this.Total=0,this.BasePrice=0,this.ItemPrice=0,this.GrossValue=0,this.ItemValue=0,this.CS=[]},e.prototype.addStep=function(e){this.CS.push(e)},e.prototype.addVariantAttributesToJSON=function(e){this.VString1=e.getAttribute("VariantMainString1"),this.VString2=e.getAttribute("VariantMainString2"),this.VString3=e.getAttribute("VariantMainString3"),this.VString4=e.getAttribute("VariantMainString4"),this.VString5=e.getAttribute("VariantMainString5"),this.VDecimal1=e.getAttribute("VariantMainDecimal1"),this.VDecimal2=e.getAttribute("VariantMainDecimal2"),this.VDecimal3=e.getAttribute("VariantMainDecimal3"),this.VDecimal4=e.getAttribute("VariantMainDecimal4"),this.VDecimal5=e.getAttribute("VariantMainDecimal5")},e}();e.ItemDebugData=l;var d=function(){function e(){}return Object.defineProperty(e.prototype,"pSearchSteps",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pFound",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pSkippedByUserExit",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pStepSkipped",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pruntime",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pV1",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pV2",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pV3",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pV4",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pV5",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pV6",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pNo",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCT",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pMetaMetaID",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCndCpMetaPKey",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pRef",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pValidForCalcGroup",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pstepType",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCondition",{get:function(){},set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pScaleType",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pScaleBaseType",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCValue",{get:function(){},set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCBase",{get:function(){},set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCResult",{get:function(){},set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pIsMandatory",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pMandatoryCndFound",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pPriceReceipt",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pBasePriceReceipt",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pValueReceipt",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pGrossValueReceipt",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pTotal",{get:function(){},set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pRoundingMode",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pDecimalPlaces",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pIsSubTotal",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pDistributeToItem",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pIsManual",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCndCpSearchStrategyPKey",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pRndDiff",{set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pStatistical",{set:function(e){},enumerable:!1,configurable:!0}),e.prototype.addSearchStep=function(e){},e}();e.EmptyStepDebugData=d;var p=function(){function e(e,t,r,n,i,a,o,s,c,u,l,d,p,h,g,C,f,I,S,m,y,b,P,E,T,O,L,A,M){void 0===M&&(M=" "),this.Found=!1,this.SkippedByUserExit=!1,this.StepSkipped=e,this.No=t,this.CT=r,this.MetaMetaID=n,this.CndCpMetaPKey=i,this.Ref=a,this.ValidForCalcGroup=o,this.stepType=s,this.Condition=c,this.ScaleType=u,this.ScaleBaseType=l,this.CValue=d,this.CBase=p,this.CResult=h,this.IsMandatory=g,this.MandatoryCndFound=C,this.PriceReceipt=f,this.BasePriceReceipt=I,this.ValueReceipt=S,this.GrossValueReceipt=m,this.Total=y,this.RoundingMode=b,this.DecimalPlaces=P,this.IsSubTotal=E,this.DistributeToItem=T,this.IsManual=O,this.CndCpSearchStrategyPKey=L,this.RndDiff=M,this.Statistical=A,this.runtime=0,this.V1=0,this.V2=0,this.V3=0,this.V4=0,this.V5=0,this.V6=0,this.SearchSteps=[]}return Object.defineProperty(e.prototype,"pSearchSteps",{set:function(e){this.SearchSteps=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pFound",{set:function(e){this.Found=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pSkippedByUserExit",{set:function(e){this.SkippedByUserExit=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pStepSkipped",{set:function(e){this.StepSkipped=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pruntime",{set:function(e){this.runtime=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pV1",{set:function(e){this.V1=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pV2",{set:function(e){this.V2=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pV3",{set:function(e){this.V3=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pV4",{set:function(e){this.V4=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pV5",{set:function(e){this.V5=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pV6",{set:function(e){this.V6=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pNo",{set:function(e){this.No=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCT",{set:function(e){this.CT=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pMetaMetaID",{set:function(e){this.MetaMetaID=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCndCpMetaPKey",{set:function(e){this.CndCpMetaPKey=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pRef",{set:function(e){this.Ref=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pValidForCalcGroup",{set:function(e){this.ValidForCalcGroup=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pstepType",{set:function(e){this.stepType=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCondition",{get:function(){return this.Condition},set:function(e){this.Condition=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pScaleType",{set:function(e){this.ScaleType=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pScaleBaseType",{set:function(e){this.ScaleBaseType=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCValue",{get:function(){return this.CValue},set:function(e){this.CValue=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCBase",{get:function(){return this.CBase},set:function(e){this.CBase=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCResult",{get:function(){return this.CResult},set:function(e){this.CResult=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pIsMandatory",{set:function(e){this.IsMandatory=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pMandatoryCndFound",{set:function(e){this.MandatoryCndFound=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pPriceReceipt",{set:function(e){this.PriceReceipt=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pBasePriceReceipt",{set:function(e){this.BasePriceReceipt=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pValueReceipt",{set:function(e){this.ValueReceipt=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pGrossValueReceipt",{set:function(e){this.GrossValueReceipt=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pTotal",{get:function(){return this.Total},set:function(e){this.Total=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pRoundingMode",{set:function(e){this.RoundingMode=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pDecimalPlaces",{set:function(e){this.DecimalPlaces=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pIsSubTotal",{set:function(e){this.IsSubTotal=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pDistributeToItem",{set:function(e){this.DistributeToItem=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pIsManual",{set:function(e){this.IsManual=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pCndCpSearchStrategyPKey",{set:function(e){this.CndCpSearchStrategyPKey=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pRndDiff",{set:function(e){this.RndDiff=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pStatistical",{set:function(e){this.Statistical=e},enumerable:!1,configurable:!0}),e.prototype.addSearchStep=function(e,t){if(void 0===t&&(t=!1),t){var r=this.SearchSteps.findIndex((function(t){return t.MKey==e.MKey}));r>-1?this.SearchSteps[r]=e.clone():this.SearchSteps.push(e.clone())}else this.SearchSteps.push(e.clone())},e}();e.StepDebugData=p;var h=function(){function e(e,t,r,n,i,a,o,s,c,u,l,d,p,h,g,C,f,I){this.KeyTypeId=e,this.KeyT=t,this.No=r,this.MKey=n,this.success=i,this.rslt=a,this.cTotal=o,this.UoMConversion=s,this.OrigCondition=c,this.Exclusive=u,this.CompareBase=l,this.ScaleValue=d,this.ScaleBase=p,this.OriginalUnit=h,this.OriginalCondition=g,this.UnitFactor=C,this.IsCurrencyConverted=f,this.OriginalCurrency=I,this.CBase=0,this.ItemGroupBucket=" ",this.graduatedResults=" ",this.runtime=0,this.MKey=""}return e.prototype.clone=function(){return JSON.parse(JSON.stringify(this))},e}();e.SearchStepData=h;e.SdoConditionRecord=function(){this.SdoItemPKey=" ",this.PrdMainPKey=" ",this.Text1="",this.Currency="",this.CurrencyConversionRate=-1,this.CndCpCalculationPosition="",this.CndCpSearchStrategyKTRelPos="",this.CndCpMetaPkey="",this.ConditionBaseValue=0,this.ConditionValue="0.0000",this.ConditionUnit="",this.UnitFactor=0,this.ConvertedConditionValue=0,this.ConditionResult=0,this.PrintRelevant=!1};var g=function(){function e(){}return e.createStepDebugDataInstance=function(e,t,r,n,a,o,s,c,u,l,h,g,C,f,I,S,m,y,b,P,E,T,O,L,A,M,R,D,N){return void 0===N&&(N=" "),"yes"===i.SETTINGS.GENERATE_PRICING_LOG.toLowerCase()?new p(e,t,r,n,a,o,s,c,u,l,h,g,C,f,I,S,m,y,b,P,E,T,O,L,A,M,R,D,N):new d},e.createHeaderDebugDataInstance=function(e,n,a,o,s,c,u,l,d,p,h,g,C,f,I){return"yes"===i.SETTINGS.GENERATE_PRICING_LOG.toLowerCase()?new r(e,n,a,o,s,c,u,l,d,p,h,g,C,f,I):new t},e.createHeaderItemStepDebugDataInstance=function(e,t,r,n,s,c,u,l,d,p,h,g,C){return"yes"===i.SETTINGS.GENERATE_PRICING_LOG.toLowerCase()?new o(e,t,r,n,s,c,u,l,d,p,h,g,C):new a},e.createHeaderStepDebugDataInstance=function(e,t,r,n,a,o,u,l,d,p,h,g,C,f,I,S,m,y,b,P,E,T,O){return"yes"===i.SETTINGS.GENERATE_PRICING_LOG.toLowerCase()?new c(e,t,r,n,a,o,u,l,d,p,h,g,C,f,I,S,m,y,b,P,E,T,O):new s},e.createItemDebugDataInstance=function(e,t,r,a,o,s,c,d,p,h,g,C,f,I,S,m){return"yes"===i.SETTINGS.GENERATE_PRICING_LOG.toLowerCase()?new l(e,t,r,a,o,s,c,d,p,h,g,C,f,I,S,n.isDefined(m.getItem("promotionPKey"))?m.getItem("promotionPKey"):" ",n.isDefined(m.getItem("rewardPKey"))?m.getItem("rewardPKey"):" ",n.isDefined(m.getItem("parentType"))?m.getItem("parentType"):" "):new u},e}();e.DebugDataFactory=g}(t.DebugData||(t.DebugData={}))},121:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.LogHandler=void 0;var n=r(237),i=r(346),a=function(){function e(){if(this.prefix="#CP# ",this._measures=new i.Dictionary,this.lLogMessages=new i.List,this.logContext={moduleName:"ComplexPricingEngine",className:"CP",methodName:"Log"},e._instance)throw new Error("Error: Instantiation failed: Use LogHandler.getInstance() instead of new.");e._instance=this,this.setLoggingSwitch()}return e.getInstance=function(){return null===e._instance&&(e._instance=new e),e._instance},e.prototype.setLoggingSwitch=function(){AppLog.on?n.SETTINGS.LOG_ENABLED=!0:n.SETTINGS.LOG_ENABLED=!1},e.prototype.start=function(e,t){var r=t+" -> "+e;this._measures.add(r,Utils.createDateNow().getTime()),n.SETTINGS.LOG_FLUSH?this.lLogMessages.add("|"+this.prefix+"| START | "+r+"|"):Utils.isDefined(AppLog)&&Utils.isDefined(AppLog.info)&&AppLog.info("#CP#  | START | "+r+"|")},e.prototype.end=function(e,t){var r=t+" -> "+e,i=Utils.createDateNow().getTime()-this._measures.getItem(r);this._measures.remove(r),n.SETTINGS.LOG_FLUSH?this.lLogMessages.add("|"+this.prefix+"| END | "+r+"| "+i+" ms |"):Utils.isDefined(AppLog)&&Utils.isDefined(AppLog.info)&&AppLog.info("#CP#  | END | "+r+"| "+i+" ms |")},e.prototype.endWithAlert=function(e,t){var r=t+" -> "+e,i=Utils.createDateNow().getTime()-this._measures.getItem(r);this._measures.remove(r),n.SETTINGS.LOG_FLUSH?this.lLogMessages.add("|"+this.prefix+"| END | "+r+"| "+i+" ms |"):console.log("|"+this.prefix+"| END | "+r+"| "+i+" ms |")},e.prototype.message=function(e){!0===n.SETTINGS.LOG_ENABLED&&(n.SETTINGS.LOG_FLUSH?this.lLogMessages.add("|"+this.prefix+"| MESSAGE | "+e+"|"):Utils.isDefined(AppLog)&&Utils.isDefined(AppLog.info)&&AppLog.info("#CP#  | MESSAGE | "+e+"|"))},e.prototype.warning=function(e){!0===n.SETTINGS.LOG_ENABLED&&(n.SETTINGS.LOG_FLUSH?this.lLogMessages.add("|"+this.prefix+"| WARNING | "+e+"|"):Utils.isDefined(AppLog)&&Utils.isDefined(AppLog.warn)&&AppLog.warn("#CP#  | WARNING | "+e+"|"))},e.prototype.error=function(e){!0===n.SETTINGS.LOG_ENABLED&&(n.SETTINGS.LOG_FLUSH?this.lLogMessages.add("|"+this.prefix+"|  ERROR  | "+e+"|"):Utils.isDefined(AppLog)&&Utils.isDefined(AppLog.error)&&AppLog.error("#CP#  |  ERROR  | "+e+"|"))},e.prototype.flush=function(){n.SETTINGS.LOG_FLUSH&&this.lLogMessages.forEach((function(e){console.log(e)})),this.clearMessages()},e.prototype.getMessagesAsString=function(){var e;return e=i.listToCommaSeperatedList(this.lLogMessages,"\r\n"),this.clearMessages(),e},e.prototype.clearMessages=function(){this.lLogMessages.clear()},e._instance=null,e}();t.LogHandler=a},744:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CalcMatrix=void 0;var n=r(121),i=r(346),a=r(601),o=r(951),s=r(366),c=r(426),u=r(503),l=r(237),d=r(547),p=r(722),h=function(){function e(t){if(this.CLASS_NAME="CalcMatrix",this.currentCalcSchema=null,this.API=p.API.getInstance(),this.isCalcSchemaReady=!1,this.bConditionsReady=!1,this.conditionSearches=[],this.iSeeks=0,this.customerSets=[],this.promotions=[],this.customerHierarchy=new i.Dictionary,this.uoMConversion=1,this.invalidCalcStep="",this.itemMetaUsageTokens=new i.Dictionary,this.headerConditionEffect=0,this.headerConditionEffectWithoutSelectablePromotionItems=0,e._instance)throw new Error("Error: Instantiation failed: Use API.getInstance() instead of new.");l.SETTINGS.UOMROUNDINGFACTOR=t,e._instance=this}return Object.defineProperty(e.prototype,"HeaderBuckets",{get:function(){return this.headerBuckets},enumerable:!1,configurable:!0}),e.getInstance=function(t){return void 0===t&&(t=3),null===e._instance&&(e._instance=new e(t)),e._instance},e.prototype.init=function(t,r,a,o,s,c,u,d,h,C,f,I){void 0===f&&(f="USD"),void 0===I&&(I="0001"),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("init","CalcMatrix"),this.iSeeks=0,this.customerSets=[],this.promotions=[],this.customerHierarchy=new i.Dictionary,Utils.isDefined(f)||(f=ApplicationContext.get("user").getCurrency()),l.SETTINGS.HOME_CURRENCY=f,l.SETTINGS.GENERATE_PRICING_LOG=C,l.SETTINGS.SALES_ORG=I;var S=ApplicationContext.get("user").getSalesOrg();return Utils.isDefined(S)&&!Utils.isEmptyString(S)&&(l.SETTINGS.SALES_ORG=S),Utils.isEmptyString(d)?l.SETTINGS.DISTRIBCHANNEL=ApplicationContext.get("user").getDistribChannel():l.SETTINGS.DISTRIBCHANNEL=d,Utils.isEmptyString(h)?l.SETTINGS.DIVISION=ApplicationContext.get("user").getDivision():l.SETTINGS.DIVISION=h,p.API.getInstance().clearCaches(),this.initOrder(t,r,a,o,s,c,u),this.oCalculationMatrix=new g,this.CurrentPricingDate=o,this.initSchema(c).then((function(t){return e.getInstance().loadCustomerData(a,c,o)})).then((function(){return f!==s?(l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Getting conversion factor to convert ReceiptCurrency to HomeCurrency"),p.API.getInstance().readCurrencyConversionFactor(f,s,o).then((function(t){return e.getInstance().currentOrder.conversionFactor=t.conversionFactor,e.getInstance().currentOrder.conversionFactorAmount=t.conversionFactorAmount,e.getInstance().currentOrder.isInvertedCurrencyConversion=t.invertedCurrencyConversion,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("init","CalcMatrix"),"loaded"}))):(l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("init","CalcMatrix"),"loaded")}))},e.prototype.initOrder=function(e,t,r,i,a,o,s){if(this.currentOrder=new d.Order(e,r,t,i,a,o),this.sdoMainPKey=e,this.invalidCalcStep="",Utils.isDefined(s)&&s.length>0)for(var c=0;c<s.length;c++)this.currentOrder.Attributes.add(s[c].key,s[c].value);l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Order initialized!")},e.prototype.updateOrder=function(e,t,r){l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("updateOrder","CalcMatrix");var i=!1;e!==this.currentOrder.PricingDate&&(this.currentOrder.PricingDate=e,this.CurrentPricingDate=Utils.convertAnsiDate2Date(e),i=!0),t!==this.currentOrder.getAttribute("Currency")&&(this.currentOrder.ReceiptCurrency=t,i=!0);for(var a=0;a<r.length;a++)this.currentOrder.Attributes.contains(r[a].key)&&this.currentOrder.getAttribute(r[a].key)!==r[a].value&&(this.currentOrder.Attributes.update(r[a].key,r[a].value),i=!0);i&&this.currentOrder.setOrderDirty(),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("updateOrder","CalcMatrix")},e.prototype.resetCalcMatrixForProduct=function(e){this.oCalculationMatrix.resetMatrixForProduct(e)},e.prototype.addOrderItems=function(e){l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("addOrderItems","CalcMatrix"),this.currentOrder.addOrderItems(e),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("addOrderItems","CalcMatrix")},e.prototype.readProductAttributes=function(){l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("readProductAttributes","CalcMatrix");for(var t=when.resolve(),r="",i="",a=0;a<this.currentOrder.lItems.length;a++)if(!this.currentOrder.getItem(this.currentOrder.lItems.getItem(a)).bInitialized){var o=this.currentOrder.getItem(this.currentOrder.lItems.getItem(a)).PrdMainPKey;!this.API.CACHE_ProductData.contains(o)&&r.indexOf(o)<0?r=r+"'"+o+"',":this.API.CACHE_ProductData.contains(o)&&i.indexOf(o)<0&&(i=i+"'"+o+"',")}return i.length>0&&(l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("PrdMainPKey(s) in API.CACHE_ProductData but not initialized: "+i),e.getInstance().currentOrder.setProductsInitialized(i),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("PrdMainPKey(s) in API.CACHE_ProductData but not initialized ---\x3e set to initialized: "+i)),r.length>0?(r=r.substring(0,r.length-1),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Read product informations for Products which are not yet in API.CACHE_ProductData: "+r),t=this.API.readProductInformation(r,this.CurrentPricingDate,this.currentCalcSchema.calcSchemaPkey,this.currentCalcSchema.hasPrdAssortments).then((function(){return e.getInstance().currentOrder.readUnitConversionFactors()})).then((function(){e.getInstance().currentOrder.Items.forEach((function(e){e.updateWeightAndVolume()})),e.getInstance().currentOrder.setProductsInitialized(r),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Read product information from DB ---\x3e set to initialized: "+r),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readProductAttributes","CalcMatrix")}))):l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("readProductAttributes","CalcMatrix"),t},e.prototype.createSearchRequests=function(){for(var t=[],r=[],n=[],a=[],o=new i.Dictionary,s=0;s<this.currentCalcSchema.listCalcSteps.length;s++)if(this.currentCalcStep=this.currentCalcSchema.getCalcStepByKey(this.currentCalcSchema.listCalcSteps.getItem(s)),this.currentCalcStep.IsSubtotal||this.currentCalcStep.IsHeaderCondition||this.currentCalcStep.IsManual){if(this.currentCalcStep.IsHeaderCondition&&!this.currentCalcStep.IsSubtotal&&!this.currentCalcStep.IsManual){for((n=[]).push(this.currentCalcStep.CndCpMetaPKey),r=[],u=0;u<this.currentCalcStep.KeyTypes.length;u++){for(a=[],l=this.currentCalcStep.KeyTypes.getItem(u),d=this.createMergedKeyList(l,this.currentCalcStep.CndCpMetaPKey),p=[],h=0;h<d.toArray().length;h++)this.API.hasCondition(this.currentCalcStep.CndCpMetaPKey,l.CndCpKeyTypePKey,d.getItem(h))||o.contains(this.currentCalcStep.CndCpMetaPKey+l.CndCpKeyTypePKey+d.getItem(h))||(p.push(d.getItem(h)),o.add(this.currentCalcStep.CndCpMetaPKey+l.CndCpKeyTypePKey+d.getItem(h),void 0));p.length>0&&(a.push(l.CndCpKeyTypePKey),l.Exclusive,a.push("0"),a.push(p)),a.length>0&&r.push(a)}r.length>0&&(n.push(r),t.push(n))}}else for(var c=0;c<this.currentOrder.lItems.length;c++)if((n=[]).push(this.currentCalcStep.CndCpMetaPKey),e.getInstance().currentItem=this.currentOrder.getItem(this.currentOrder.lItems.getItem(c)),e.getInstance().currentItem.bInitialized){r=[];for(var u=0;u<this.currentCalcStep.KeyTypes.length;u++){a=[];for(var l=this.currentCalcStep.KeyTypes.getItem(u),d=e.getInstance().createMergedKeyList(l,this.currentCalcStep.CndCpMetaPKey),p=[],h=0;h<d.toArray().length;h++)this.API.hasCondition(this.currentCalcStep.CndCpMetaPKey,l.CndCpKeyTypePKey,d.getItem(h))||o.contains(this.currentCalcStep.CndCpMetaPKey+l.CndCpKeyTypePKey+d.getItem(h))||(p.push(d.getItem(h)),o.add(this.currentCalcStep.CndCpMetaPKey+l.CndCpKeyTypePKey+d.getItem(h),void 0));p.length>0&&(a.push(l.CndCpKeyTypePKey),l.Exclusive,a.push("0"),a.push(p)),a.length>0&&r.push(a)}r.length>0&&(n.push(r),t.push(n))}return t},e.prototype.getConditionsSummedUpForCache=function(){this.conditionSearches=this.createSearchRequests();for(var t=0;t<this.currentCalcSchema.listCalcSteps.length;t++)if(this.currentCalcStep=this.currentCalcSchema.getCalcStepByKey(this.currentCalcSchema.listCalcSteps.getItem(t)),!this.currentCalcStep.IsSubtotal&&!this.currentCalcStep.IsManual)if(this.currentCalcStep.IsHeaderCondition)for(o=0;o<this.currentCalcStep.KeyTypes.length;o++){var r=this.currentCalcStep.KeyTypes.getItem(o),n=e.getInstance().createMergedKeyList(r,this.currentCalcStep.CndCpMetaPKey);e.getInstance().currentOrder.addMergedKey(e.getInstance().currentCalcStep.StepNumber,r.KeyTypeId,r.Position.toString(),e.getInstance().currentCalcStep.CndCpMetaPKey,r.CndCpKeyTypePKey,n)}else for(var i=function(t){var r=a.currentCalcStep.KeyTypes.getItem(t),n=a.currentCalcStep.CndCpMetaPKey;a.currentOrder.Items.forEach((function(t){if(t.bInitialized){e.getInstance().currentItem=t;var i=e.getInstance().createMergedKeyList(r,n);e.getInstance().currentItem.addMergedKey(e.getInstance().currentCalcStep.StepNumber,r.KeyTypeId,r.Position.toString(),e.getInstance().currentCalcStep.CndCpMetaPKey,r.CndCpKeyTypePKey,i)}}))},a=this,o=0;o<this.currentCalcStep.KeyTypes.length;o++)i(o)},e.prototype.initSchema=function(t){var r;return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("initSchema","CalcMatrix"),this.isCalcSchemaReady=!1,this.API.readCalculationStepsForSchema(t).then((function(t){r=t,e.getInstance().currentCalcSchema=r,e.getInstance().currentCalcSchema.parseReferenceSteps(),e.getInstance().isCalcSchemaReady=!0,Utils.isDefined(e.getInstance().currentOrder)&&e.getInstance().currentOrder.Items.length>0&&e.getInstance().getConditionsSummedUpForCache();var n=new i.List;return e.getInstance().currentCalcSchema.dicCalcSteps.forEach((function(e){" "===e.CndCpItemMetaRulePKey||n.contains(e.CndCpItemMetaRulePKey)||n.add(e.CndCpItemMetaRulePKey)})),e.getInstance().API.readItemMetaRules(n)})).then((function(t){return e.getInstance().itemMetaUsageTokens=t,e.getInstance().createHeaderBuckets(),l.SETTINGS.LOG_ENABLED&&(n.LogHandler.getInstance().message("#READY# Calculation schema loaded and ready!"),n.LogHandler.getInstance().end("initSchema","CalcMatrix")),r}))},e.prototype.loadCustomerData=function(t,r,i){return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("loadCustomerData","CalcMatrix"),this.API.readCustomerInformation(t).then((function(r){return Utils.isDefined(r)&&e.getInstance().currentOrder.setCustomerAttributes(r),p.API.getInstance().readCustomerHierarchy(t,i)})).then((function(n){return e.getInstance().customerHierarchy=n,e.getInstance().currentCalcSchema.hasBpaSets?p.API.getInstance().readBpaSets(t,r).then((function(t){e.getInstance().customerSets=t})):when.resolve(void 0)})).then((function(){return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("loadCustomerData","CalcMatrix"),e.getInstance().loadPromotionData(t,r)}))},e.prototype.loadPromotionData=function(t,r){l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("loadPromotionData","CalcMatrix");var i=when.resolve(void 0);return e.getInstance().currentCalcSchema.hasAutoGrantedPromotions&&(i=p.API.getInstance().readAutoGrantedPromotions(t,r).then((function(t){e.getInstance().promotions=t}))),i.then((function(){if(e.getInstance().currentCalcSchema.hasRewards)return e.getInstance().currentOrder.initRewardCache(t,r)}))},e.prototype.addOrUpdateOrderItem=function(t,r){var i=when.resolve(void 0);if(l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("addOrUpdateOrderItem","CalcMatrix"),Utils.isDefined(this.currentOrder)){var a=t.pKey;if(this.currentOrder.lItems.contains(a)){p.API.getInstance().bOverallRecalcRequired&&this.currentOrder.setOrderDirty();var o=r||"";if("QUANTITYLOGISTICUNIT"===o.toUpperCase())p.API.getInstance().CACHE_UnitFactorCache.containsFactor(t.PrdMainPKey,t.quantityLogisticUnit)?(this.currentOrder.getItem(a).updateQuantity(t.quantity,t.quantityLogisticUnit),l.SETTINGS.LOG_ENABLED&&(n.LogHandler.getInstance().message("Product: '"+t.text1+"' ("+t.prdMainPKey+") updated to UoM: "+t.quantityLogisticUnit),n.LogHandler.getInstance().end("addOrUpdateOrderItem","CalcMatrix"))):i=p.API.getInstance().readUnitConversionFactors(t.PrdMainPKey,t.quantityLogisticUnit).then((function(){e.getInstance().currentOrder.getItem(a).updateQuantity(t.quantity,t.quantityLogisticUnit),l.SETTINGS.LOG_ENABLED&&(n.LogHandler.getInstance().message("Product: '"+t.text1+"' ("+t.prdMainPKey+") updated to UoM: "+t.quantityLogisticUnit),n.LogHandler.getInstance().end("addOrUpdateOrderItem","CalcMatrix"))}));else{switch(o.toUpperCase()){case"QUANTITY":this.currentOrder.getItem(a).updateQuantity(t.quantity,t.quantityLogisticUnit),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Product: '"+t.text1+"' ("+t.prdMainPKey+") updated to quantity: "+t.quantity);break;case"DISCOUNT":this.currentOrder.getItem(a).updateDiscount(t.discount),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Product: '"+t.text1+"' ("+t.prdMainPKey+") updated to discount: "+t.discount);break;case"SPECIALPRICERECEIPT":this.currentOrder.getItem(a).updateSpecialPrice(t.specialPriceReceipt),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Product: '"+t.text1+"' ("+t.prdMainPKey+") updated to special price: "+t.specialPriceReceipt);break;case"SDOITEMMETAPKEY":this.currentOrder.getItem(a).updateItemTemplate(t),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Product: '"+t.text1+"' ("+t.prdMainPKey+") updated to item template: "+t.type);break;case"PRICINGINFO1":this.currentOrder.getItem(a).updatePricingInfo1(t.pricingInfo1),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Product: '"+t.text1+"' ("+t.prdMainPKey+") updated to pricing info 1: "+t.pricingInfo1);break;case"PRICINGINFO2":this.currentOrder.getItem(a).updatePricingInfo2(t.pricingInfo2),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Product: '"+t.text1+"' ("+t.prdMainPKey+") updated to pricing info 2: "+t.pricingInfo2);break;case"PRICINGINFO3":this.currentOrder.getItem(a).updatePricingInfo3(t.pricingInfo3),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Product: '"+t.text1+"' ("+t.prdMainPKey+") updated to pricing info 3: "+t.pricingInfo3);break;case"PRICINGINFO4":this.currentOrder.getItem(a).updatePricingInfo4(t.pricingInfo4),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Product: '"+t.text1+"' ("+t.prdMainPKey+") updated to pricing info 4: "+t.pricingInfo4);break;case"PRICINGINFO5":this.currentOrder.getItem(a).updatePricingInfo5(t.pricingInfo5),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Product: '"+t.text1+"' ("+t.prdMainPKey+") updated to pricing info 5: "+t.pricingInfo5);break;case"PRICINGINFO6":this.currentOrder.getItem(a).updatePricingInfo6(t.pricingInfo6),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Product: '"+t.text1+"' ("+t.prdMainPKey+") updated to pricing info 6: "+t.pricingInfo6);break;case"PRICINGINFO7":this.currentOrder.getItem(a).updatePricingInfo7(t.pricingInfo7),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Product: '"+t.text1+"' ("+t.prdMainPKey+") updated to pricing info 7: "+t.pricingInfo7);break;case"PRICINGINFO8":this.currentOrder.getItem(a).updatePricingInfo8(t.pricingInfo8),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Product: '"+t.text1+"' ("+t.prdMainPKey+") updated to pricing info 8: "+t.pricingInfo8);break;case"PRICINGINFO9":this.currentOrder.getItem(a).updatePricingInfo9(t.pricingInfo9),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Product: '"+t.text1+"' ("+t.prdMainPKey+") updated to pricing info 9: "+t.pricingInfo9);break;case"PRICINGINFO10":this.currentOrder.getItem(a).updatePricingInfo10(t.pricingInfo10),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Product: '"+t.text1+"' ("+t.prdMainPKey+") updated to pricing info 10: "+t.pricingInfo10);break;case l.SETTINGS.ADDITIONAL_PRICING_INFO_ATTRIBUTE.toUpperCase():this.currentOrder.getItem(a).updateAdditionalPricingInfo(t[l.SETTINGS.ADDITIONAL_PRICING_INFO_ATTRIBUTE]),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Product: '"+t.text1+"' ("+t.prdMainPKey+") updated to additional pricing info: "+JSON.stringify(t[l.SETTINGS.ADDITIONAL_PRICING_INFO_ATTRIBUTE]))}l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("addOrUpdateOrderItem","CalcMatrix")}}else this.currentOrder.addOrderItem(t),this.currentOrder.getItem(a).setDirty(),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("addOrUpdateOrderItem","CalcMatrix")}else l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("addOrUpdateOrderItem","CalcMatrix");return i},e.prototype.calculateItemGroupBucketValue=function(){for(var e,t,r=0,n=0;n<this.currentGroupBucket.Items.length;n++)if(t=(e=this.currentGroupBucket.Items.getItem(n)).nPriceEffect,this.currentCalcStep.HasReference){for(var i=0,a=0;a<this.currentCalcStep.ReferenceSteps.length;a++)i+=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.ReferenceSteps.getItem(a).toString(),e.SdoItemPKey);r+=i*t}else r+=e.TotalWithoutPriceEffect*t;return r},e.prototype.checkProductMasterDataAvailability=function(){return when.resolve(void 0)},e.prototype.calculateOrderValue=function(){var t;l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("calculateOrderValue","CalcMatrix");var r=this;return Utils.isEmptyString(this.invalidCalcStep)?(this.iSeeks=this.iSeeks+this.conditionSearches.length,this.overallRuntime=Utils.createDateNow().getTime(),t=this.readProductAttributes().then((function(){return e.getInstance().getConditionsSummedUpForCache(),r.API.readConditions(r.conditionSearches).then((function(){return p.API.getInstance().bOverallRecalcRequired&&e.getInstance().currentOrder.setOrderDirty(),e.getInstance().calculate()})).then((function(t){return e.getInstance().conditionSearches=[],l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("calculateOrderValue","CalcMatrix"),t}))}))):t=this.showInvalidStepError().then((function(e){return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("calculateOrderValue","CalcMatrix"),e})),t},e.prototype.showInvalidStepError=function(){return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("showInvalidStepError","CalcMatrix"),this.showErrorMessage("CasSdoCpInvalidKeyAttribue").then((function(){return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("showInvalidStepError","CalcMatrix"),{Total:0,CSTAT:!1,IsMandCondFnd:!0,Debug:[],PrdText:"",calcStepID:0}}))},e.prototype.createHeaderBuckets=function(){this.headerBuckets=new c.HeaderBucketCollection(this.itemMetaUsageTokens)},e.prototype.calculate=function(){var e,t={},r=0,c=!1;t.Total=0,t.CSTAT=!1,t.IsMandCondFnd=!0,t.Debug=[],t.PrdText="",t.calcStepID=0,t.SdoConditions=[];var u=0,d=0,h=!1;if(this.headerConditionEffect=0,this.headerConditionEffectWithoutSelectablePromotionItems=0,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("calculate","CalcMatrix"),0===this.currentOrder.filteredItems.toArray().length||this.currentOrder.hasNoOrderItems())return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("No order items to calculate (perhaps filtered out)"),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("calculate","CalcMatrix"),when.resolve(t);var g=[],C=[],f=0,I=o.DebugData.DebugDataFactory.createHeaderDebugDataInstance(this.currentOrder.sOrderMainPKey,this.currentOrder.getAttribute("SdoMetaPKey"),this.currentOrder.getAttribute("Id"),0,this.currentOrder.getAttribute("OrdererBpaMainPKey"),this.currentOrder.getAttribute("PayerCustomerPKey"),this.currentOrder.getAttribute("DeliveryRecipientPKey"),this.currentOrder.getAttribute("BillToCustomerPKey"),this.CurrentPricingDate,l.SETTINGS.HOME_CURRENCY,this.currentOrder.getAttribute("Currency"),this.currentOrder.conversionFactor,this.currentCalcSchema.calcSchemaPkey,0,0);I.addVariantAttributesToJSON(this.currentOrder);for(var S=0;S<this.currentCalcSchema.listCalcSteps.length;S++)if(h=!1,this.currentCalcStep=this.currentCalcSchema.getCalcStepByKey(this.currentCalcSchema.listCalcSteps.getItem(S)),this.currentCalcStep.IsHeaderCondition){var m=Utils.createDateNow().getTime(),y="No";if(a.ConditionContainer.getInstance().clear(),!Utils.isEmptyString(this.currentCalcStep.UserExitConstraintId)&&CustomPlugins.ComplexPricingEngine.UserExitSkipCurrentCalcStep){l.SETTINGS.LOG_ENABLED&&(n.LogHandler.getInstance().start("UserExitSkipCurrentCalcStep","CalcMatrix"),n.LogHandler.getInstance().message("UserExitID: "+this.currentCalcStep.UserExitConstraintId));for(var b=[],P=0;P<this.currentOrder.filteredItems.toArray().length;P++)b.push(this.currentOrder.getItem(this.currentOrder.filteredItems.getItem(P)).getAttributesForUserExit);var E=this.currentOrder.Attributes;h=CustomPlugins.ComplexPricingEngine.UserExitSkipCurrentCalcStep(E.data,this.currentCalcStep.UserExitConstraintId,{},b),Utils.isDefined(h)||(h=!1),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("UserExitSkipCurrentCalcStep","CalcMatrix")}var T=o.DebugData.DebugDataFactory.createHeaderStepDebugDataInstance(this.currentCalcStep.CndCpSearchStrategyPKey,this.currentCalcStep.StepNumber,this.currentCalcStep.CndCpMetaId,this.currentCalcStep.CndCpMetaMetaId,this.currentCalcStep.CndCpMetaPKey,this.currentCalcStep.HasReference?this.currentCalcStep.StepReference:"None",0,this.currentCalcStep.ScaleType,this.currentCalcStep.Base,0,0,!1,!1,0,0,0,0,this.currentCalcStep.Rounding,this.currentCalcStep.DecimalPlaces,"HeaderStep",this.currentCalcStep.IsSubtotal,this.currentCalcStep.IsStatistical,this.currentCalcStep.IsManual);if(h)y="By User Exit";else{u=0,d=0,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("calculate header step: "+this.currentCalcStep.StepNumber+" "+this.currentCalcStep.CndCpMetaId,"CalcMatrix");var O=new o.DebugData.SearchStepData("","","","",!1,0,0,1,"",!1,0,"",0,"","",0,!1,"");this.oCalculationMatrix.addCalcRow(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey);for(var L=0;L<this.currentOrder.filteredItems.length;L++)this.currentItem=this.currentOrder.getItem(this.currentOrder.filteredItems.getItem(L)),this.currentItem.Qty>0&&this.oCalculationMatrix.addCalcRow(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey);if(c=!1,this.currentCalcStep.IsManual)(c=this.findManualHeaderCondition())||(O.success=!1,T.addSearchStep(O));else if(this.currentCalcStep.IsSubtotal)a.ConditionContainer.getInstance().addCondition(new a.Condition),c=!0;else if(Utils.isDefined(this.currentCalcStep.KeyTypes))for(var A=0;A<this.currentCalcStep.KeyTypes.length;A++){var M=this.currentCalcStep.KeyTypes.getItem(A);if(!this.callSkipSearchStepUserExit(M,!1)){if((X=this.getMergedKeyListForOrder(this.currentOrder,this.currentCalcStep.StepNumber,M)).length>0)for(var R=0;R<X.length;R++){var D=p.API.getInstance().getCondition(this.currentCalcStep.CndCpMetaPKey,M.CndCpKeyTypePKey,X.getItem(R)),N=!1;Utils.isDefined(D)&&Utils.isDefined(D.condition)&&(N=this.parseConditionValue(D.condition,this.currentCalcStep.IsScale,M.Position.toString()),c=c||N,N&&a.ConditionContainer.getInstance().setStepInformation(M,M.CndCpKeyTypePKey,X.getItem(R),D)),O.success=!1,O.runtime=0,O.KeyT=M.CndCpKeyTypePKey,O.MKey=X.getItem(R),O.KeyTypeId=M.KeyTypeId,O.No=M.Position.toString(),O.Exclusive=M.Exclusive,T.addSearchStep(O),this.uoMConversion=1}if(c&&M.Exclusive)break}}for(this.currentCalcStep.IsScale&&(c=!1),r=0,A=0;A<a.ConditionContainer.getInstance().Condition.length;A++){this.currentOrder.dTotalValue=this.calculateHeaderStep(a.ConditionContainer.getInstance().Condition.getItem(A)),this.currentCalcStep.IsScale&&(c=c||a.ConditionContainer.getInstance().Condition.getItem(A).bConditionFound);var v=void 0;v=a.ConditionContainer.getInstance().Condition.getItem(A),(te=new o.DebugData.SdoConditionRecord).CndCpMetaPkey=this.currentCalcStep.CndCpMetaPKey,te.CndCpCalculationPosition=this.currentCalcStep.StepNumber,te.CurrencyConversionRate=this.currentOrder.conversionFactor,te.PrintRelevant=this.currentCalcStep.IsPrintRelevant,te.Text1=this.currentCalcStep.CndCpMetaText,te.SdoItemPKey=" ",this.currentCalcStep.IsSubtotal?(te.CndCpSearchStrategyKTRelPos="0",te.ConditionBaseValue=0,te.ConditionResult=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey),te.ConditionUnit=" ",te.ConditionValue=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey).toString(),te.ConvertedConditionValue=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey),te.Currency=this.currentOrder.ReceiptCurrency,te.UnitFactor=0):(te.CndCpSearchStrategyKTRelPos=v.sNo,te.ConditionBaseValue=v.CBase,te.ConditionResult=v.CResult,te.ConditionUnit=v.sOriginalUnit,te.ConditionValue=v.sOriginalConditionValue,te.ConvertedConditionValue=v.CValue,te.Currency=v.sOriginalCurrency,te.UnitFactor=v.UnitFactor),t.SdoConditions.push(te),r+=v.CValue,O.success=v.bConditionFound,O.cTotal=v.Total,O.rslt=v.CValue,O.CResult=v.CResult,O.CBase=v.CBase,O.CompareBase=v.ScaleCompareValue,O.ScaleValue=v.scale,O.runtime=v.runtime,O.KeyT=v.sKeyTypePKey,O.MKey=v.sMergedKey,O.ScaleBase=this.getScaleBase(this.currentCalcStep.IsScale,v),O.OriginalUnit=v.sOriginalUnit,O.OriginalCondition=v.sOriginalConditionValue,O.UnitFactor=v.UnitFactor,O.IsCurrencyConverted=v.IsCurrencyConverted,O.OriginalCurrency=v.sOriginalCurrency,Utils.isDefined(v.keyType)&&(O.KeyTypeId=v.keyType.KeyTypeId,O.No=v.keyType.Position.toString(),O.Exclusive=v.keyType.Exclusive,O.OrigCondition=this.convertConditionToArray(v.origCondition)),Utils.isDefined(v.graduatedSteps)&&(O.graduatedResults=v.graduatedSteps),T.addSearchStep(O,!0)}if(!c&&this.currentCalcStep.IsMandatory)return t.CSTAT=!1,t.IsMandCondFnd=!1,t.calcStepID=this.currentCalcStep.StepNumber,l.SETTINGS.LOG_ENABLED&&(n.LogHandler.getInstance().message("No mandatory condition found for header"),n.LogHandler.getInstance().message("ConditionValue: "+this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey)),n.LogHandler.getInstance().message("ConditionResult: "+this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey)),n.LogHandler.getInstance().end("calculate header step: "+this.currentCalcStep.StepNumber+" "+this.currentCalcStep.CndCpMetaId,"CalcMatrix"),n.LogHandler.getInstance().end("calculate","CalcMatrix")),T.pTotal=i.round(this.currentOrder.dTotalValue,this.currentCalcStep.DecimalPlaces,"1"),T.pCValue=i.round(r,6,"1"),T.pCResult=i.round(this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey),6,"1"),T.pIsMandatory=this.currentCalcStep.IsMandatory,T.pMandatoryCndFound=!1,T.pMerchandiseValueReceipt=this.currentOrder.MerchandiseValueReceipt,T.pTotalValueReceipt=this.currentOrder.TotalValueReceipt,T.pFound=c,I.addStepDebugData(T),I.pGrossTotalVR=this.currentOrder.dTotalValue,I.pseeks=this.iSeeks,I.pruntime=Utils.createDateNow().getTime()-this.overallRuntime,t.Debug.push(I),when.resolve(t);switch(this.currentCalcStep.TargetAttributeCondition){case"MerchandiseValueReceipt":this.currentOrder.MerchandiseValueReceipt=this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey);break;case"TotalValueReceipt":this.currentOrder.TotalValueReceipt=this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey);break;case"PricingInfo1":this.currentOrder.Attributes.update("PricingInfo1",this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey));break;case"PricingInfo2":this.currentOrder.Attributes.update("PricingInfo2",this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey));break;case"PricingInfo3":this.currentOrder.Attributes.update("PricingInfo3",this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey));break;case"PricingInfo4":this.currentOrder.Attributes.update("PricingInfo4",this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey));break;case"PricingInfo5":this.currentOrder.Attributes.update("PricingInfo5",this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey));break;case"PricingInfo6":this.currentOrder.Attributes.update("PricingInfo6",this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey));break;case"PricingInfo7":this.currentOrder.Attributes.update("PricingInfo7",this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey));break;case"PricingInfo8":this.currentOrder.Attributes.update("PricingInfo8",this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey));break;case"PricingInfo9":this.currentOrder.Attributes.update("PricingInfo9",this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey));break;case"PricingInfo10":this.currentOrder.Attributes.update("PricingInfo10",this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey))}switch(this.currentCalcStep.TargetAttributeResult){case"MerchandiseValueReceipt":this.currentOrder.MerchandiseValueReceipt=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey);break;case"TotalValueReceipt":this.currentOrder.TotalValueReceipt=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey);break;case"PricingInfo1":this.currentOrder.Attributes.update("PricingInfo1",this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey));break;case"PricingInfo2":this.currentOrder.Attributes.update("PricingInfo2",this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey));break;case"PricingInfo3":this.currentOrder.Attributes.update("PricingInfo3",this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey));break;case"PricingInfo4":this.currentOrder.Attributes.update("PricingInfo4",this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey));break;case"PricingInfo5":this.currentOrder.Attributes.update("PricingInfo5",this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey));break;case"PricingInfo6":this.currentOrder.Attributes.update("PricingInfo6",this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey));break;case"PricingInfo7":this.currentOrder.Attributes.update("PricingInfo7",this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey));break;case"PricingInfo8":this.currentOrder.Attributes.update("PricingInfo8",this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey));break;case"PricingInfo9":this.currentOrder.Attributes.update("PricingInfo9",this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey));break;case"PricingInfo10":this.currentOrder.Attributes.update("PricingInfo10",this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey))}}T.pCondition=r,T.pTotal=i.round(this.currentOrder.dTotalValue,6,"1"),T.pCValue=i.round(this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey),6,"1"),T.pCResult=i.round(this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey),6,"1"),T.pIsMandatory=this.currentCalcStep.IsMandatory,this.currentCalcStep.IsMandatory&&(T.pMandatoryCndFound=c),T.pMerchandiseValueReceipt=this.currentOrder.MerchandiseValueReceipt,T.pTotalValueReceipt=this.currentOrder.TotalValueReceipt,T.pFound=c,T.pruntime=Utils.createDateNow().getTime()-m,T.pheaderConditionEffect=this.getHeaderConditionEffect(this.currentCalcStep),T.pSkippedByUserExit=h,T.pStepSkipped=y,I.addStepDebugData(T),l.SETTINGS.LOG_ENABLED&&(n.LogHandler.getInstance().message("ConditionValue: "+this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey)),n.LogHandler.getInstance().message("ConditionResult: "+this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey)),n.LogHandler.getInstance().end("calculate header step: "+this.currentCalcStep.StepNumber+" "+this.currentCalcStep.CndCpMetaId,"CalcMatrix"))}else if(this.currentCalcStep.ItemGrouping){if(l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("calculate itemgrouping step: "+this.currentCalcStep.CndCpMetaId,"CalcMatrix"),!Utils.isEmptyString(this.currentCalcStep.UserExitConstraintId)&&CustomPlugins.ComplexPricingEngine.UserExitSkipCurrentCalcStep){for(l.SETTINGS.LOG_ENABLED&&(n.LogHandler.getInstance().start("UserExitSkipCurrentCalcStep","CalcMatrix"),n.LogHandler.getInstance().message("UserExitID: "+this.currentCalcStep.UserExitConstraintId)),b=[],P=0;P<this.currentOrder.filteredItems.length;P++)b.push(this.currentOrder.getItem(this.currentOrder.filteredItems.getItem(P)).getAttributesForUserExit);E=this.currentOrder.Attributes,h=CustomPlugins.ComplexPricingEngine.UserExitSkipCurrentCalcStep(E.data,this.currentCalcStep.UserExitConstraintId,{},b),Utils.isDefined(h)||(h=!1),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("UserExitSkipCurrentCalcStep","CalcMatrix")}var V=new i.Dictionary;if(O=void 0,h)for(L=0;L<this.currentOrder.lItems.length;L++)this.currentItem=this.currentOrder.getItem(this.currentOrder.lItems.getItem(L)),this.currentItem.Qty>0&&(this.currentItem.currentCalcStepDebugData=o.DebugData.DebugDataFactory.createStepDebugDataInstance("No",this.currentCalcStep.StepNumber,this.currentCalcStep.CndCpMetaId,this.currentCalcStep.CndCpMetaMetaId,this.currentCalcStep.CndCpMetaPKey,this.currentCalcStep.HasReference?this.currentCalcStep.StepReference:"None",!1,"ItemGrouping",0,this.currentCalcStep.ScaleType,this.currentCalcStep.Base,0,0,0,!1,!1,0,0,0,0,0,this.currentCalcStep.Rounding,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.IsSubtotal,this.currentCalcStep.DistributeToItem,this.currentCalcStep.IsManual,this.currentCalcStep.CndCpSearchStrategyPKey,this.currentCalcStep.IsStatistical));else for(L=0;L<this.currentOrder.filteredItems.length;L++)if(a.ConditionContainer.getInstance().clear(),this.currentItem.conditionFoundInGrouping=!1,this.currentItem=this.currentOrder.getItem(this.currentOrder.filteredItems.getItem(L)),this.currentItem.Qty>0){var U=this.currentCalcStep.isStepValidForGroup(this.currentItem);this.currentItem.currentCalcStepDebugData=o.DebugData.DebugDataFactory.createStepDebugDataInstance("No",this.currentCalcStep.StepNumber,this.currentCalcStep.CndCpMetaId,this.currentCalcStep.CndCpMetaMetaId,this.currentCalcStep.CndCpMetaPKey,this.currentCalcStep.HasReference?this.currentCalcStep.StepReference:"None",U,"ItemGrouping",0,this.currentCalcStep.ScaleType,this.currentCalcStep.Base,0,0,0,!1,!1,0,0,0,0,0,this.currentCalcStep.Rounding,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.IsSubtotal,this.currentCalcStep.DistributeToItem,this.currentCalcStep.IsManual,this.currentCalcStep.CndCpSearchStrategyPKey,this.currentCalcStep.IsStatistical),O=new o.DebugData.SearchStepData("","","","",!1,0,0,1,"",!1,0,"",0,"","",0,!1,""),this.oCalculationMatrix.addCalcRow(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey),Utils.createDateNow().getTime();var G=!1;if(this.currentItem.IsDirty&&U&&!this.currentCalcStep.isStepSkippedByPromotion(this.currentItem)&&Utils.isDefined(this.currentCalcStep.KeyTypes))for(A=0;A<this.currentCalcStep.KeyTypes.length;A++)if(M=this.currentCalcStep.KeyTypes.getItem(A),!this.callSkipSearchStepUserExit(M,!1)){if((X=this.getMergedKeyListForOrderItem(this.currentItem,this.currentCalcStep.StepNumber,M)).length>0)for(R=0;R<X.length;R++)if(V.contains(X.getItem(R))){var K=-9999;this.headerBuckets.contains(this.currentCalcStep.CndCpItemMetaRulePKey)&&(K=this.headerBuckets.getPriceEffect(this.currentCalcStep.CndCpItemMetaRulePKey,this.currentItem.sSdoItemMetaPKey)),V.getItem(X.getItem(R)).addItem(this.currentItem,K),G=!0}else{if(D=p.API.getInstance().getCondition(this.currentCalcStep.CndCpMetaPKey,M.CndCpKeyTypePKey,X.getItem(R)),N=!1,Utils.isDefined(D)&&Utils.isDefined(D.condition)&&(N=this.parseConditionValue(D.condition,this.currentCalcStep.IsScale,M.Position.toString()),G=G||N,N&&a.ConditionContainer.getInstance().setStepInformation(M,M.CndCpKeyTypePKey,X.getItem(R),D)),O.success=!1,O.KeyT=M.CndCpKeyTypePKey,O.MKey=X.getItem(R),O.KeyTypeId=M.KeyTypeId,O.No=M.Position.toString(),O.Exclusive=M.Exclusive,O.runtime=0,this.currentItem.currentCalcStepDebugData.addSearchStep(O),N){var _=new s.ItemGroupBucket(a.ConditionContainer.getInstance().Condition.getItem(0));K=-9999,this.headerBuckets.contains(this.currentCalcStep.CndCpItemMetaRulePKey)&&(K=this.headerBuckets.getPriceEffect(this.currentCalcStep.CndCpItemMetaRulePKey,this.currentItem.sSdoItemMetaPKey)),_.addItem(this.currentItem,K),_.Items.length>0&&V.add(X.getItem(R),_)}a.ConditionContainer.getInstance().clear()}if(G&&M.Exclusive)break}}for(var B=V.keyValuePairs,H=0;H<B.length;H++)if(this.currentGroupBucket=B[H].value,this.currentGroupBucket.Value=this.calculateItemGroupBucketValue(),this.currentCalcStep.IsFreeItem){l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Free Item Case");var x=this.parseFreeItemCondition(this.currentGroupBucket.Condition.origCondition,this.currentCalcStep.ScaleType);if(Utils.isDefined(x)&&0!==x.Rate&&x.bConditionFound)for((Z={}).FreeItemPKey=x.FreeItemPKey,Z.FreeQty=x.Rate,Z.FreeUoM=x.FreeUoM,Z.ParentItemPKey=this.currentOrder.sOrderMainPKey,Z.CreationStep=this.currentCalcStep.StepNumber+this.currentGroupBucket.Condition.sMergedKey,l.SETTINGS.LOG_ENABLED&&(n.LogHandler.getInstance().message("FreeItemPKey: "+Z.FreeItemPKey),n.LogHandler.getInstance().message("FreeQty: "+Z.FreeQty),n.LogHandler.getInstance().message("FreeUoM: "+Z.FreeUoM),n.LogHandler.getInstance().message("ParentItemPKey: "+Z.ParentItemPKey),n.LogHandler.getInstance().message("CreationStep: "+Z.CreationStep)),C.push(Z),L=0;L<this.currentGroupBucket.Items.toArray().length;L++)this.currentItem=this.currentGroupBucket.Items.getItem(L),v=this.currentGroupBucket.Condition,this.currentItem.conditionFoundInGrouping=!0,this.currentItem.currentCalcStepDebugData.pCondition+=v.CValue,this.currentItem.currentCalcStepDebugData.pCBase=v.CBase,O.success=v.bConditionFound,O.cTotal=v.Total,O.rslt=v.CValue,O.CResult=v.CResult,O.CBase=v.CBase,O.CompareBase=v.ScaleCompareValue,O.ScaleValue=v.scale,O.KeyT=v.sKeyTypePKey,O.MKey=v.sMergedKey,O.runtime=v.runtime,O.ScaleBase=this.getScaleBase(this.currentCalcStep.IsScale,v),O.UoMConversion=v.UnitFactor,O.ItemGroupBucket=this.currentGroupBucket.ItemNames,O.OriginalUnit=v.sOriginalUnit,O.OriginalCondition=v.sOriginalConditionValue,O.UnitFactor=v.UnitFactor,O.IsCurrencyConverted=v.IsCurrencyConverted,O.OriginalCurrency=v.sOriginalCurrency,O.UnitConverted=v.bUnitConverted,O.PrdMainPKey=Z.FreeItemPKey,O.FreeQty=Z.FreeQty,O.FreeUoM=Z.FreeUoM,O.ScaleMinQty=x.Value,Utils.isDefined(v.keyType)&&(O.KeyTypeId=v.keyType.KeyTypeId,O.No=v.keyType.Position.toString(),O.Exclusive=v.keyType.Exclusive,O.OrigCondition=this.convertConditionToArray(v.origCondition)),Utils.isDefined(v.graduatedSteps)&&(O.graduatedResults=v.graduatedSteps),this.currentItem.currentCalcStepDebugData.addSearchStep(O),(te=new o.DebugData.SdoConditionRecord).CndCpMetaPkey=this.currentCalcStep.CndCpMetaPKey,te.CndCpCalculationPosition=this.currentCalcStep.StepNumber,te.CndCpSearchStrategyKTRelPos=v.sNo,te.ConditionBaseValue=v.CBase,te.ConditionResult=v.CResult,te.ConditionUnit=v.sOriginalUnit,te.ConditionValue=v.CValue.toString(),te.ConvertedConditionValue=v.CValue,te.ConditionResult=Z.FreeQty,te.PrdMainPKey=Z.FreeItemPKey,te.ConditionUnit=Z.FreeUoM,te.ConditionValue=Z.FreeQty,te.ConvertedConditionValue=Z.FreeQty,te.Currency=" ",te.CurrencyConversionRate=this.currentOrder.conversionFactor,te.PrintRelevant=this.currentCalcStep.IsPrintRelevant,te.SdoItemPKey=this.currentItem.SdoItemPKey,te.Text1=this.currentCalcStep.CndCpMetaText,te.UnitFactor=1,this.currentCalcStep.IsSubtotal||t.SdoConditions.push(te)}else{var F=void 0,k=0,j=0;for(L=0;L<this.currentGroupBucket.Items.length;L++)if(this.currentItem=this.currentGroupBucket.Items.getItem(L),this.currentItem.Qty>0){v=this.currentGroupBucket.Condition;var w=this.calculateItemStep(v);j+=v.CResult*this.currentItem.nPriceEffect,Utils.isDefined(F)?w>k&&(k=w,F=this.currentItem):(F=this.currentItem,k=w),this.currentItem.conditionFoundInGrouping=this.currentItem.conditionFoundInGrouping||v.bConditionFound,(te=new o.DebugData.SdoConditionRecord).CndCpMetaPkey=this.currentCalcStep.CndCpMetaPKey,te.CndCpCalculationPosition=this.currentCalcStep.StepNumber,te.CndCpSearchStrategyKTRelPos=v.sNo,te.ConditionBaseValue=v.CBase,te.ConditionResult=v.CResult,te.ConditionUnit=v.sOriginalUnit,te.ConditionValue=v.CValue.toString(),te.ConvertedConditionValue=v.CValue,Utils.isEmptyString(v.sOriginalCurrency)?te.Currency=this.currentOrder.ReceiptCurrency:te.Currency=v.sOriginalCurrency,te.CurrencyConversionRate=this.currentOrder.conversionFactor,te.PrintRelevant=this.currentCalcStep.IsPrintRelevant,te.SdoItemPKey=this.currentItem.SdoItemPKey,te.Text1=this.currentCalcStep.CndCpMetaText,te.UnitFactor=v.UnitFactor,this.currentCalcStep.IsSubtotal||t.SdoConditions.push(te),this.currentItem.currentCalcStepDebugData.pCondition+=v.CValue,this.currentItem.currentCalcStepDebugData.pCBase=v.CBase,O.success=v.bConditionFound,O.cTotal=v.Total,O.rslt=v.CValue,O.CResult=v.CResult,O.CBase=v.CBase,O.CompareBase=v.ScaleCompareValue,O.ScaleValue=v.scale,O.KeyT=v.sKeyTypePKey,O.MKey=v.sMergedKey,O.runtime=v.runtime,O.ScaleBase=this.getScaleBase(this.currentCalcStep.IsScale,v),O.UoMConversion=v.UnitFactor,O.ItemGroupBucket=this.currentGroupBucket.ItemNames,O.OriginalUnit=v.sOriginalUnit,O.OriginalCondition=v.sOriginalConditionValue,O.UnitFactor=v.UnitFactor,O.IsCurrencyConverted=v.IsCurrencyConverted,O.OriginalCurrency=v.sOriginalCurrency,O.UnitConverted=v.bUnitConverted,Utils.isDefined(v.keyType)&&(O.KeyTypeId=v.keyType.KeyTypeId,O.No=v.keyType.Position.toString(),O.Exclusive=v.keyType.Exclusive,O.OrigCondition=this.convertConditionToArray(v.origCondition)),Utils.isDefined(v.graduatedSteps)&&(O.graduatedResults=v.graduatedSteps),this.currentItem.currentCalcStepDebugData.addSearchStep(O,!0)}"PERCENTAGE"!==this.currentCalcStep.CndCpMetaMetaId.toUpperCase()&&"FIXAMOUNT"!==this.currentCalcStep.CndCpMetaMetaId.toUpperCase()||this.adjustGroupLastCent(F,j)}for(u=0,d=0,L=0;L<this.currentOrder.filteredItems.length;L++)if(this.currentItem=this.currentOrder.getItem(this.currentOrder.filteredItems.getItem(L)),this.currentItem.Qty>0){if(!this.currentCalcStep.IsFreeItem){if(!this.currentItem.conditionFoundInGrouping||this.currentCalcStep.IsSubtotal||this.currentCalcStep.IsFreeItem||this.currentCalcStep.IsStatistical||("PRICE"===this.currentCalcStep.CndCpMetaMetaId.toUpperCase()?this.currentItem.updateTotalWithPriceEffect(this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey)):this.currentItem.updateTotalWithPriceEffect(this.currentItem.TotalWithoutPriceEffect+this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey))),!this.currentItem.conditionFoundInGrouping&&this.currentCalcStep.IsMandatory){t.CSTAT=!1,t.IsMandCondFnd=!1,t.PrdText=this.currentItem.sPrdText,t.calcStepID=this.currentCalcStep.StepNumber,l.SETTINGS.LOG_ENABLED&&(n.LogHandler.getInstance().message("No mandatory condition found for item (grouping step): '"+this.currentItem.sPrdText+"' ("+this.currentItem.PrdMainPKey+")"),n.LogHandler.getInstance().message("ConditionValue: "+this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey)*this.currentItem.nPriceEffect),n.LogHandler.getInstance().message("ConditionResult: "+this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey)*this.currentItem.nPriceEffect),n.LogHandler.getInstance().end("calculate item step: "+this.currentCalcStep.StepNumber+" "+this.currentCalcStep.CndCpMetaId,"CalcMatrix"),n.LogHandler.getInstance().end("calculate","CalcMatrix"));var Q=this.currentItem.currentCalcStepDebugData;return Q.pTotal=i.round(this.currentItem.Total,6,"1"),Q.pCValue=i.round(this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey),6,"1")*this.currentItem.nPriceEffect,Q.pCResult=i.round(this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey),6,"1")*this.currentItem.nPriceEffect,Q.pIsMandatory=!0,Q.pMandatoryCndFound=!1,Q.pPriceReceipt=this.currentItem.PriceReceipt,Q.pBasePriceReceipt=this.currentItem.BasePriceReceipt,Q.pValueReceipt=this.currentItem.ValueReceipt,Q.pGrossValueReceipt=this.currentItem.GrossValueReceipt,Q.pFound=!1,Q.pSkippedByUserExit=h,Q.pruntime=Utils.createDateNow().getTime()-e,this.currentItem.DebugData.addStep(Q),t.Debug.push(this.currentItem.DebugData),when.resolve(t)}if(this.currentItem.conditionFoundInGrouping){if(Utils.isDefined(this.currentCalcStep.TargetAttributeCondition)&&!Utils.isEmptyString(this.currentCalcStep.TargetAttributeCondition)){var W=this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey)*this.currentItem.nPriceEffect;switch(this.currentCalcStep.TargetAttributeCondition){case"PriceReceipt":this.currentItem.PriceReceipt=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level) filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"BasePriceReceipt":this.currentItem.BasePriceReceipt=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level) filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"ValueReceipt":this.currentItem.ValueReceipt=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level) filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"GrossValueReceipt":this.currentItem.GrossValueReceipt=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level) filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo1":this.currentItem.PricingInfo1=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level) filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo2":this.currentItem.PricingInfo2=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level) filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo3":this.currentItem.PricingInfo3=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level)  filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo4":this.currentItem.PricingInfo4=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level)  filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo5":this.currentItem.PricingInfo5=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level)  filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo6":this.currentItem.PricingInfo6=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level)  filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo7":this.currentItem.PricingInfo7=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level)  filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo8":this.currentItem.PricingInfo8=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level)  filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo9":this.currentItem.PricingInfo9=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level)  filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo10":this.currentItem.PricingInfo10=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level)  filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;default:this.currentItem.updateAdditionalPricingInfoAttribute(this.currentCalcStep.TargetAttributeCondition,W),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level)  filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W)}}if(Utils.isDefined(this.currentCalcStep.TargetAttributeResult)&&!Utils.isEmptyString(this.currentCalcStep.TargetAttributeResult)){var J=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey)*this.currentItem.nPriceEffect;switch(this.currentCalcStep.TargetAttributeResult){case"PriceReceipt":this.currentItem.PriceReceipt=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"BasePriceReceipt":this.currentItem.BasePriceReceipt=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"ValueReceipt":this.currentItem.ValueReceipt=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"GrossValueReceipt":this.currentItem.GrossValueReceipt=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo1":this.currentItem.PricingInfo1=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo2":this.currentItem.PricingInfo2=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo3":this.currentItem.PricingInfo3=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo4":this.currentItem.PricingInfo4=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo5":this.currentItem.PricingInfo5=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo6":this.currentItem.PricingInfo6=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo7":this.currentItem.PricingInfo7=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo8":this.currentItem.PricingInfo8=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo9":this.currentItem.PricingInfo9=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo10":this.currentItem.PricingInfo10=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;default:this.currentItem.updateAdditionalPricingInfoAttribute(this.currentCalcStep.TargetAttributeResult,J),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J)}}}}(Y=this.currentItem.currentCalcStepDebugData).pCondition=r,Y.pTotal=i.round(this.currentItem.Total,6,"1"),Y.pCValue=i.round(this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey),6,"1")*this.currentItem.nPriceEffect,Y.pCResult=i.round(this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey),6,"1")*this.currentItem.nPriceEffect,Y.pCBase=i.round(Y.pCBase,6,"1")*this.currentItem.nPriceEffect,Y.pIsMandatory=this.currentCalcStep.IsMandatory,this.currentCalcStep.IsMandatory&&(Y.pMandatoryCndFound=this.currentItem.conditionFoundInGrouping),Y.pPriceReceipt=this.currentItem.PriceReceipt,Y.pBasePriceReceipt=this.currentItem.BasePriceReceipt,Y.pValueReceipt=this.currentItem.ValueReceipt,Y.pGrossValueReceipt=this.currentItem.GrossValueReceipt,Y.pFound=this.currentItem.conditionFoundInGrouping,Y.pSkippedByUserExit=h,Y.pruntime=Utils.createDateNow().getTime()-e,this.currentItem.DebugData.addStep(Y),u+=i.round(this.currentItem.Total,6,"1"),d+=this.currentItem.nPriceEffect*i.round(this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey),6,"1")}I.addStepDebugData(o.DebugData.DebugDataFactory.createHeaderItemStepDebugDataInstance(this.currentCalcStep.StepNumber,this.currentCalcStep.CndCpMetaId,this.currentCalcStep.CndCpMetaMetaId,u+this.getHeaderConditionEffect(this.currentCalcStep),d,this.currentCalcStep.StepReference,"ItemGrouping",this.currentCalcStep.ScaleType,this.currentCalcStep.Base,this.currentCalcStep.IsSubtotal,this.currentCalcStep.IsManual,this.currentCalcStep.CndCpSearchStrategyPKey,this.currentCalcStep.IsStatistical)),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("calculate itemgrouping step: "+this.currentCalcStep.CndCpMetaId,"CalcMatrix")}else{for(u=0,d=0,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("calculate item step: "+this.currentCalcStep.StepNumber+" "+this.currentCalcStep.CndCpMetaId,"CalcMatrix"),L=0;L<this.currentOrder.filteredItems.length;L++)if(a.ConditionContainer.getInstance().clear(),this.currentItem=this.currentOrder.getItem(this.currentOrder.filteredItems.getItem(L)),this.currentItem.Qty>0){U=this.currentCalcStep.isStepValidForGroup(this.currentItem);var q=!1;y="No",this.currentCalcStep.isStepValidForGroup(this.currentItem)||(y="By Calc Group",q=!0),this.currentCalcStep.isStepSkippedByPromotion(this.currentItem)&&(y="By Promotion",q=!0),(h=this.isStepSkippedByUserExit(this.currentCalcStep,this.currentItem))&&(y="By User Exit",q=!0);var Y=o.DebugData.DebugDataFactory.createStepDebugDataInstance(y,this.currentCalcStep.StepNumber,this.currentCalcStep.CndCpMetaId,this.currentCalcStep.CndCpMetaMetaId,this.currentCalcStep.CndCpMetaPKey,this.currentCalcStep.HasReference?this.currentCalcStep.StepReference:"None",U,"ItemStep",0,this.currentCalcStep.ScaleType,this.currentCalcStep.Base,0,0,0,!1,!1,0,0,0,0,0,this.currentCalcStep.Rounding,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.IsSubtotal,this.currentCalcStep.DistributeToItem,this.currentCalcStep.IsManual,this.currentCalcStep.CndCpSearchStrategyPKey,this.currentCalcStep.IsStatistical);O=new o.DebugData.SearchStepData("","","","",!1,0,0,1,"",!1,0,"",0,"","",0,!1,""),e=Utils.createDateNow().getTime();var z=!1;if(this.currentItem.IsDirty&&!q){if(this.oCalculationMatrix.addCalcRow(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Processing item: '"+this.currentItem.sPrdText+"' ("+this.currentItem.PrdMainPKey+")"),this.currentCalcStep.IsManual)(z=this.findManualCondition())||(O.success=!1,Y.addSearchStep(O));else if(this.currentCalcStep.IsSubtotal)a.ConditionContainer.getInstance().addCondition(new a.Condition),z=!0;else if("FREEGOOD"===this.currentCalcStep.CndCpMetaMetaId.toUpperCase())a.ConditionContainer.getInstance().addCondition(new a.Condition),z=!0;else if(Utils.isDefined(this.currentCalcStep.KeyTypes))for(A=0;A<this.currentCalcStep.KeyTypes.length;A++)if(M=this.currentCalcStep.KeyTypes.getItem(A),!this.callSkipSearchStepUserExit(M,!0)){var X;if((X=this.getMergedKeyListForOrderItem(this.currentItem,this.currentCalcStep.StepNumber,M)).length>0)for(R=0;R<X.length;R++){var Z;if(D=p.API.getInstance().getCondition(this.currentCalcStep.CndCpMetaPKey,M.CndCpKeyTypePKey,X.getItem(R)),N=!1,Utils.isDefined(D)&&Utils.isDefined(D.condition))if(v=D.condition,this.currentCalcStep.IsFreeItem)l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Free Item Case"),x=this.parseFreeItemCondition(v,this.currentCalcStep.ScaleType),Utils.isDefined(x)&&0!==x.Rate&&x.bConditionFound&&(N=!0,z=x.bConditionFound,(Z={}).FreeItemPKey=x.FreeItemPKey,Z.FreeQty=x.Rate,Z.FreeUoM=x.FreeUoM,Z.ParentItemPKey=this.currentItem.SdoItemPKey,Z.CreationStep=this.currentCalcStep.StepNumber+X.getItem(R),C.push(Z),l.SETTINGS.LOG_ENABLED&&(n.LogHandler.getInstance().message("FreeItemPKey: "+Z.FreeItemPKey),n.LogHandler.getInstance().message("FreeQty: "+Z.FreeQty),n.LogHandler.getInstance().message("FreeUoM: "+Z.FreeUoM),n.LogHandler.getInstance().message("ParentItemPKey: "+Z.ParentItemPKey),n.LogHandler.getInstance().message("CreationStep: "+Z.CreationStep)),O.success=!0,O.No=M.Position.toString(),O.ScaleBase=x.Base,O.KeyT=M.CndCpKeyTypePKey,O.KeyTypeId=M.KeyTypeId,O.MKey=X.getItem(R),O.runtime=D.runtime,O.PrdMainPKey=Z.FreeItemPKey,O.FreeQty=Z.FreeQty,O.FreeUoM=Z.FreeUoM,O.ScaleMinQty=x.Value,O.OrigCondition=this.convertConditionToArray(v),O.CompareBase=x.Base,O.ScaleValue=v.cnd,O.cTotal=v.Total,O.rslt=v.CValue,O.CResult=v.CResult,O.CBase=v.CBase,O.UoMConversion=this.uoMConversion,O.UnitConverted=v.bUnitConverted,Y.addSearchStep(O),(te=new o.DebugData.SdoConditionRecord).CndCpMetaPkey=this.currentCalcStep.CndCpMetaPKey,te.CndCpCalculationPosition=this.currentCalcStep.StepNumber,te.CndCpSearchStrategyKTRelPos=M.Position.toString(),te.ConditionBaseValue=v.CBase,te.ConditionResult=Z.FreeQty,te.PrdMainPKey=Z.FreeItemPKey,te.ConditionUnit=Z.FreeUoM,te.ConditionValue=Z.FreeQty,te.ConvertedConditionValue=Z.FreeQty,te.Currency=" ",te.CurrencyConversionRate=this.currentOrder.conversionFactor,te.PrintRelevant=this.currentCalcStep.IsPrintRelevant,te.SdoItemPKey=this.currentItem.SdoItemPKey,te.Text1=this.currentCalcStep.CndCpMetaText,te.UnitFactor=1,this.currentCalcStep.IsSubtotal||this.currentItem.SdoConditions.push(te));else N=this.parseConditionValue(v,this.currentCalcStep.IsScale,M.Position.toString()),z=z||N,N&&a.ConditionContainer.getInstance().setStepInformation(M,M.CndCpKeyTypePKey,X.getItem(R),D);(O=new o.DebugData.SearchStepData("","","","",!1,0,0,1,"",!1,0,"",0,"","",0,!1,"")).success=!1,O.KeyT=M.CndCpKeyTypePKey,O.MKey=X.getItem(R),O.KeyTypeId=M.KeyTypeId,O.No=M.Position.toString(),O.runtime=0,O.Exclusive=M.Exclusive,Y.addSearchStep(O),l.SETTINGS.LOG_ENABLED&&this.currentItem.dicConditionSearchLogging.add({KeyType:O.KeyT,No:O.No,MKeys:O.MKey}),this.uoMConversion=1}if(z&&M.Exclusive)break}this.currentCalcStep.IsScale&&!this.currentCalcStep.IsFreeItem&&(z=!1);var $=0;if(!this.currentCalcStep.IsFreeItem){var ee=a.ConditionContainer.getInstance().Condition.length;for(A=0;A<ee;A++){var te;w=this.calculateItemStep(a.ConditionContainer.getInstance().Condition.getItem(A)),this.currentCalcStep.IsScale&&(z=z||a.ConditionContainer.getInstance().Condition.getItem(A).bConditionFound),v=void 0,v=a.ConditionContainer.getInstance().Condition.getItem(A),(te=new o.DebugData.SdoConditionRecord).CndCpMetaPkey=this.currentCalcStep.CndCpMetaPKey,te.CndCpCalculationPosition=this.currentCalcStep.StepNumber,te.CndCpSearchStrategyKTRelPos=v.sNo,te.ConditionBaseValue=v.CBase*this.currentItem.nPriceEffect,te.ConditionResult=v.CResult*this.currentItem.nPriceEffect,te.ConditionUnit=v.sOriginalUnit,te.ConditionValue=v.sOriginalConditionValue,te.ConvertedConditionValue=v.CValue,Utils.isEmptyString(v.sOriginalCurrency)?te.Currency=this.currentOrder.ReceiptCurrency:te.Currency=v.sOriginalCurrency,te.CurrencyConversionRate=this.currentOrder.conversionFactor,te.PrintRelevant=this.currentCalcStep.IsPrintRelevant,te.SdoItemPKey=this.currentItem.SdoItemPKey,te.Text1=this.currentCalcStep.CndCpMetaText,te.UnitFactor=v.UnitFactor,this.currentCalcStep.IsSubtotal||this.currentItem.SdoConditions.push(te),$+=v.CValue,O.success=v.bConditionFound,O.cTotal=v.Total*this.currentItem.nPriceEffect,O.rslt=v.CValue*this.currentItem.nPriceEffect,O.CResult=v.CResult*this.currentItem.nPriceEffect,O.CBase=v.CBase*this.currentItem.nPriceEffect,v.bConditionFound&&(Y.pCBase=v.CBase*this.currentItem.nPriceEffect),O.CompareBase=v.ScaleCompareValue,O.ScaleValue=v.scale,O.KeyT=v.sKeyTypePKey,O.MKey=v.sMergedKey,O.runtime=v.runtime,O.ScaleBase=this.getScaleBase(this.currentCalcStep.IsScale,v),O.UoMConversion=v.UnitFactor,O.UnitConverted=v.bUnitConverted,Utils.isDefined(v.graduatedSteps)&&(O.graduatedResults=v.graduatedSteps),O.OriginalCurrency=v.sOriginalCurrency,O.OriginalUnit=v.sOriginalUnit,O.OriginalCondition=v.sOriginalConditionValue,O.UnitFactor=v.UnitFactor,O.IsCurrencyConverted=v.IsCurrencyConverted,Utils.isDefined(v.keyType)&&(O.KeyTypeId=v.keyType.KeyTypeId,O.No=v.keyType.Position.toString(),O.Exclusive=v.keyType.Exclusive,O.OrigCondition=this.convertConditionToArray(v.origCondition)),Utils.isDefined(v.graduatedSteps)&&(O.graduatedResults=v.graduatedSteps),Y.addSearchStep(O,!0)}if(!(0<ee)||this.currentCalcStep.IsSubtotal&&"FREEGOOD"!==this.currentCalcStep.CndCpMetaMetaId.toUpperCase()||this.currentCalcStep.IsFreeItem||this.currentCalcStep.IsStatistical||("PRICE"===this.currentCalcStep.CndCpMetaMetaId.toUpperCase()?this.currentItem.updateTotalWithPriceEffect(this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey)):this.currentItem.updateTotalWithPriceEffect(this.currentItem.TotalWithoutPriceEffect+this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey))),!z&&this.currentCalcStep.IsMandatory)return t.CSTAT=!1,t.IsMandCondFnd=!1,t.PrdText=this.currentItem.sPrdText,t.calcStepID=this.currentCalcStep.StepNumber,l.SETTINGS.LOG_ENABLED&&(n.LogHandler.getInstance().message("No mandatory condition found for item: '"+this.currentItem.sPrdText+"' ("+this.currentItem.PrdMainPKey+") / "+this.currentCalcStep.CndCpMetaId+" (#"+this.currentCalcStep.StepNumber+")"),n.LogHandler.getInstance().message("merged keys:"),Utils.isDefined(AppLog)&&Utils.isDefined(AppLog.info)&&AppLog.info(JSON.stringify(this.currentItem.dicConditionSearchLogging)),this.currentItem.dicConditionSearchLogging.clear(),n.LogHandler.getInstance().message("customer attributes:"),Utils.isDefined(AppLog)&&Utils.isDefined(AppLog.info)&&AppLog.info(JSON.stringify(this.currentOrder.dicCustomerAttributes)),this.API.dumpConditionCacheSize(),n.LogHandler.getInstance().message("ConditionValue: "+this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey)*this.currentItem.nPriceEffect),n.LogHandler.getInstance().message("ConditionResult: "+this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey)*this.currentItem.nPriceEffect),n.LogHandler.getInstance().end("calculate item step: "+this.currentCalcStep.StepNumber+" "+this.currentCalcStep.CndCpMetaId,"CalcMatrix"),n.LogHandler.getInstance().end("calculate","CalcMatrix")),Y.pTotal=i.round(this.currentItem.Total,6,"1"),Y.pCValue=i.round(this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey),6,"1")*this.currentItem.nPriceEffect,Y.pCResult=i.round(this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey),6,"1")*this.currentItem.nPriceEffect,Y.pCBase=i.round(Y.pCBase,6,"1")*this.currentItem.nPriceEffect,Y.pIsMandatory=!0,Y.pMandatoryCndFound=!1,Y.pPriceReceipt=this.currentItem.PriceReceipt,Y.pBasePriceReceipt=this.currentItem.BasePriceReceipt,Y.pValueReceipt=this.currentItem.ValueReceipt,Y.pGrossValueReceipt=this.currentItem.GrossValueReceipt,Y.pFound=z,Y.pSkippedByUserExit=h,Y.pruntime=Utils.createDateNow().getTime()-e,this.currentItem.DebugData.addStep(Y),t.Debug.push(this.currentItem.DebugData),when.resolve(t);if(ee){if(Utils.isDefined(this.currentCalcStep.TargetAttributeCondition)&&!Utils.isEmptyString(this.currentCalcStep.TargetAttributeCondition))switch(W=this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey)*this.currentItem.nPriceEffect,this.currentCalcStep.TargetAttributeCondition){case"PriceReceipt":this.currentItem.PriceReceipt=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level) filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"BasePriceReceipt":this.currentItem.BasePriceReceipt=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level) filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"ValueReceipt":this.currentItem.ValueReceipt=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level) filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"GrossValueReceipt":this.currentItem.GrossValueReceipt=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level) filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo1":this.currentItem.PricingInfo1=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level) filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo2":this.currentItem.PricingInfo2=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level) filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo3":this.currentItem.PricingInfo3=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level)  filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo4":this.currentItem.PricingInfo4=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level)  filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo5":this.currentItem.PricingInfo5=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level)  filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo6":this.currentItem.PricingInfo6=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level)  filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo7":this.currentItem.PricingInfo7=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level)  filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo8":this.currentItem.PricingInfo8=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level)  filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo9":this.currentItem.PricingInfo9=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level)  filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;case"PricingInfo10":this.currentItem.PricingInfo10=W,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level)  filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W);break;default:this.currentItem.updateAdditionalPricingInfoAttribute(this.currentCalcStep.TargetAttributeCondition,W),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeCondition (Item Level)  filled: "+this.currentCalcStep.TargetAttributeCondition+" <-- "+W)}if(Utils.isDefined(this.currentCalcStep.TargetAttributeResult)&&!Utils.isEmptyString(this.currentCalcStep.TargetAttributeResult))switch(J=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey)*this.currentItem.nPriceEffect,this.currentCalcStep.TargetAttributeResult){case"PriceReceipt":this.currentItem.PriceReceipt=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"BasePriceReceipt":this.currentItem.BasePriceReceipt=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"ValueReceipt":this.currentItem.ValueReceipt=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"GrossValueReceipt":this.currentItem.GrossValueReceipt=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo1":this.currentItem.PricingInfo1=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo2":this.currentItem.PricingInfo2=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo3":this.currentItem.PricingInfo3=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo4":this.currentItem.PricingInfo4=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo5":this.currentItem.PricingInfo5=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo6":this.currentItem.PricingInfo6=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo7":this.currentItem.PricingInfo7=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo8":this.currentItem.PricingInfo8=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo9":this.currentItem.PricingInfo9=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;case"PricingInfo10":this.currentItem.PricingInfo10=J,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J);break;default:this.currentItem.updateAdditionalPricingInfoAttribute(this.currentCalcStep.TargetAttributeResult,J),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("TargetAttributeResult (Item Level)  filled: "+this.currentCalcStep.TargetAttributeResult+" <-- "+J)}}}Y.pCondition=$,Y.pTotal=i.round(this.currentItem.Total,6,"1"),Y.pCValue=i.round(this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey),6,"1")*this.currentItem.nPriceEffect,Y.pCResult=i.round(this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey),6,"1")*this.currentItem.nPriceEffect,Y.pIsMandatory=this.currentCalcStep.IsMandatory,this.currentCalcStep.IsMandatory&&(Y.pMandatoryCndFound=z),Y.pPriceReceipt=this.currentItem.PriceReceipt,Y.pBasePriceReceipt=this.currentItem.BasePriceReceipt,Y.pValueReceipt=this.currentItem.ValueReceipt,Y.pGrossValueReceipt=this.currentItem.GrossValueReceipt,Y.pFound=z,Y.pSkippedByUserExit=h,Y.pruntime=Utils.createDateNow().getTime()-e,this.currentItem.DebugData.addStep(Y)}else this.currentItem.IsDirty&&q&&(Y.pSkippedByUserExit=h,this.currentItem.DebugData.addStep(Y));u+=i.round(this.currentItem.Total,6,"1"),d+=this.currentItem.nPriceEffect*i.round(this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey),6,"1")}I.addStepDebugData(o.DebugData.DebugDataFactory.createHeaderItemStepDebugDataInstance(this.currentCalcStep.StepNumber,this.currentCalcStep.CndCpMetaId,this.currentCalcStep.CndCpMetaMetaId,u+this.getHeaderConditionEffect(this.currentCalcStep),d,this.currentCalcStep.StepReference,"ItemStep",this.currentCalcStep.ScaleType,this.currentCalcStep.Base,this.currentCalcStep.IsSubtotal,this.currentCalcStep.IsManual,this.currentCalcStep.CndCpSearchStrategyPKey,this.currentCalcStep.IsStatistical)),l.SETTINGS.LOG_ENABLED&&(n.LogHandler.getInstance().message("ConditionValue: "+this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey)*this.currentItem.nPriceEffect),n.LogHandler.getInstance().message("ConditionResult: "+this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey)*this.currentItem.nPriceEffect),n.LogHandler.getInstance().end("calculate item step: "+this.currentCalcStep.StepNumber+" "+this.currentCalcStep.CndCpMetaId,"CalcMatrix"))}for(l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Writing back item results"),L=0;L<this.currentOrder.filteredItems.length;L++)this.currentItem=this.currentOrder.getItem(this.currentOrder.filteredItems.getItem(L)),this.currentItem.Dirty=!1,g[f]={},g[f].PKey=this.currentItem.SdoItemPKey,g[f].PriceReceipt=this.currentItem.PriceReceipt,g[f].ValueReceipt=this.currentItem.ValueReceipt,g[f].BasePriceReceipt=this.currentItem.BasePriceReceipt,g[f].GrossValueReceipt=this.currentItem.GrossValueReceipt,g[f].SpecialPriceReceipt=this.currentItem.SplPrice,g[f].PricingInfo1=this.currentItem.PricingInfo1,g[f].PricingInfo2=this.currentItem.PricingInfo2,g[f].PricingInfo3=this.currentItem.PricingInfo3,g[f].PricingInfo4=this.currentItem.PricingInfo4,g[f].PricingInfo5=this.currentItem.PricingInfo5,g[f].PricingInfo6=this.currentItem.PricingInfo6,g[f].PricingInfo7=this.currentItem.PricingInfo7,g[f].PricingInfo8=this.currentItem.PricingInfo8,g[f].PricingInfo9=this.currentItem.PricingInfo9,g[f].PricingInfo10=this.currentItem.PricingInfo10,g[f][l.SETTINGS.ADDITIONAL_PRICING_INFO_ATTRIBUTE]=this.currentItem.AdditionalPricingInfo,l.SETTINGS.HOME_CURRENCY!==this.currentOrder.ReceiptCurrency?(g[f].Price=this.convertCurrency(this.currentItem.PriceReceipt,!0),g[f].Value=this.convertCurrency(this.currentItem.ValueReceipt,!0),g[f].BasePrice=this.convertCurrency(this.currentItem.BasePriceReceipt,!0),g[f].GrossValue=this.convertCurrency(this.currentItem.GrossValueReceipt,!0),g[f].SpecialPrice=this.convertCurrency(this.currentItem.SplPrice,!0)):(g[f].Price=this.currentItem.PriceReceipt,g[f].Value=this.currentItem.ValueReceipt,g[f].BasePrice=this.currentItem.BasePriceReceipt,g[f].GrossValue=this.currentItem.GrossValueReceipt,g[f].SpecialPrice=this.currentItem.SplPrice),f++,t.Total=t.Total+this.currentItem.Total,this.currentItem.DebugData.pTotal=i.round(this.currentItem.Total,6,"1"),this.currentItem.DebugData.pItemPrice=i.round(this.currentItem.PriceReceipt,6,"1"),this.currentItem.DebugData.pItemValue=i.round(this.currentItem.ValueReceipt,6,"1"),this.currentItem.DebugData.pGrossValue=i.round(this.currentItem.GrossValueReceipt,6,"1"),this.currentItem.DebugData.pBasePrice=i.round(this.currentItem.BasePriceReceipt,6,"1"),this.currentItem.DebugData.pCurrencyConversionFactor=this.currentOrder.conversionFactor;for(t.Total=t.Total+this.getHeaderConditionEffect(this.currentCalcStep),t.GrossTotalValueReceipt=t.Total,l.SETTINGS.HOME_CURRENCY!==this.currentOrder.ReceiptCurrency?t.GrossTotalValue=this.convertCurrency(t.Total,!0):t.GrossTotalValue=t.Total,t.TotalValueReceipt=this.currentOrder.TotalValueReceipt,l.SETTINGS.HOME_CURRENCY!==this.currentOrder.ReceiptCurrency?t.TotalValue=this.convertCurrency(this.currentOrder.TotalValueReceipt,!0):t.TotalValue=this.currentOrder.TotalValueReceipt,t.MerchandiseValueReceipt=this.currentOrder.MerchandiseValueReceipt,l.SETTINGS.HOME_CURRENCY!==this.currentOrder.ReceiptCurrency?t.MerchandiseValue=this.convertCurrency(this.currentOrder.MerchandiseValueReceipt,!0):t.MerchandiseValue=this.currentOrder.MerchandiseValueReceipt,t.PricingInfo1=this.currentOrder.Attributes.getItem("PricingInfo1"),t.PricingInfo2=this.currentOrder.Attributes.getItem("PricingInfo2"),t.PricingInfo3=this.currentOrder.Attributes.getItem("PricingInfo3"),t.PricingInfo4=this.currentOrder.Attributes.getItem("PricingInfo4"),t.PricingInfo5=this.currentOrder.Attributes.getItem("PricingInfo5"),t.PricingInfo6=this.currentOrder.Attributes.getItem("PricingInfo6"),t.PricingInfo7=this.currentOrder.Attributes.getItem("PricingInfo7"),t.PricingInfo8=this.currentOrder.Attributes.getItem("PricingInfo8"),t.PricingInfo9=this.currentOrder.Attributes.getItem("PricingInfo9"),t.PricingInfo10=this.currentOrder.Attributes.getItem("PricingInfo10"),t.CSTAT=!0,t.Items=g,t.FreeItems=C,this.currentOrder.dTotalValue=t.Total,I.pseeks=this.iSeeks,I.pruntime=Utils.createDateNow().getTime()-this.overallRuntime,I.pGrossTotalVR=this.currentOrder.dTotalValue,I.pTotalVR=t.TotalValueReceipt,I.pMerchVR=t.MerchandiseValueReceipt,t.Debug.push(I),L=0;L<this.currentOrder.filteredItems.length;L++)this.currentItem=this.currentOrder.getItem(this.currentOrder.filteredItems.getItem(L)),this.currentItem.Qty>0&&t.Debug.push(this.currentItem.DebugData),t.SdoConditions=t.SdoConditions.concat(this.currentItem.SdoConditions);return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("calculate","CalcMatrix"),when.resolve(t)},e.prototype.getMergedKeyListForOrder=function(e,t,r){var n=e.getMergedKeyList(t,r.KeyTypeId,r.Position.toString());return this.filterMergedKeyListBySelectedRewards(n,r,null)},e.prototype.getMergedKeyListForOrderItem=function(e,t,r){var n=e.getMergedKeyList(t,r.KeyTypeId,r.Position.toString());return this.filterMergedKeyListBySelectedRewards(n,r,e.PromotionPKey)},e.prototype.filterMergedKeyListBySelectedRewards=function(e,t,r){var n=e;if(t.ConsiderReward){n=new i.List;for(var a=this.currentOrder.getSelectedRewards(r),o=0;o<a.length;o++)for(var s=a[o],c=0;c<e.length;c++)0==e.getItem(c).indexOf(s.rewardPKey+"+"+s.promotionPKey)&&n.add(e.getItem(c))}return n},e.prototype.isStepSkippedByUserExit=function(e,t){var r=!1;if(!Utils.isEmptyString(e.UserExitConstraintId)&&CustomPlugins.ComplexPricingEngine.UserExitSkipCurrentCalcStep){l.SETTINGS.LOG_ENABLED&&(n.LogHandler.getInstance().start("UserExitSkipCurrentCalcStep","CalcMatrix"),n.LogHandler.getInstance().message("UserExitID: "+e.UserExitConstraintId));var i=t.getVAttributesForUserExit(),a=this.currentOrder.Attributes;r=CustomPlugins.ComplexPricingEngine.UserExitSkipCurrentCalcStep(a.data,e.UserExitConstraintId,i,[t.getAttributesForUserExit()]),this.currentItem.setVariantAttributesAfterUserExit(i),Utils.isDefined(r)||(r=!1),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("UserExitSkipCurrentCalcStep","CalcMatrix")}return r},e.prototype.findManualCondition=function(){var e=0;if(Utils.isEmptyString(this.currentCalcStep.manualSourceAttribute))switch(this.currentCalcStep.CndCpMetaMetaId.toUpperCase()){case"PRICE":e=this.currentItem.SplPrice;break;case"PERCENTAGE":case"FIXAMOUNT":case"FLATRATE":e=-1*this.currentItem.Discount}else switch(this.currentCalcStep.manualSourceAttribute){case"PricingInfo1":e=this.currentItem.PricingInfo1,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Read Manual Condition Value: "+this.currentCalcStep.manualSourceAttribute+" <-- "+e);break;case"PricingInfo2":e=this.currentItem.PricingInfo2,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Read Manual Condition Value: "+this.currentCalcStep.manualSourceAttribute+" <-- "+e);break;case"PricingInfo3":e=this.currentItem.PricingInfo3,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Read Manual Condition Value: "+this.currentCalcStep.manualSourceAttribute+" <-- "+e);break;case"PricingInfo4":e=this.currentItem.PricingInfo4,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Read Manual Condition Value: "+this.currentCalcStep.manualSourceAttribute+" <-- "+e);break;case"PricingInfo5":e=this.currentItem.PricingInfo5,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Read Manual Condition Value: "+this.currentCalcStep.manualSourceAttribute+" <-- "+e);break;case"PricingInfo6":e=this.currentItem.PricingInfo6,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Read Manual Condition Value: "+this.currentCalcStep.manualSourceAttribute+" <-- "+e);break;case"PricingInfo7":e=this.currentItem.PricingInfo7,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Read Manual Condition Value: "+this.currentCalcStep.manualSourceAttribute+" <-- "+e);break;case"PricingInfo8":e=this.currentItem.PricingInfo8,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Read Manual Condition Value: "+this.currentCalcStep.manualSourceAttribute+" <-- "+e);break;case"PricingInfo9":e=this.currentItem.PricingInfo9,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Read Manual Condition Value: "+this.currentCalcStep.manualSourceAttribute+" <-- "+e);break;case"PricingInfo10":e=this.currentItem.PricingInfo10,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Read Manual Condition Value: "+this.currentCalcStep.manualSourceAttribute+" <-- "+e);break;default:var t=this.currentItem.getAdditionalPricingInfoAttribute(this.currentCalcStep.manualSourceAttribute);Utils.isDefined(t)?(e=t,l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Read Manual Condition Value: "+this.currentCalcStep.manualSourceAttribute+" <-- "+e)):l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Not possible to read manual source attribute: "+this.currentCalcStep.manualSourceAttribute)}if(0===e)return!1;var r=new a.Condition;return r.Manual=!0,r.CValue=e,r.bCurrencyConverted=!1,r.bFreeItem=!1,r.bUnitConverted=!1,r.Denominator=1,r.sOriginalConditionValue=e.toString(),r.sOriginalUnit=this.currentItem.UoM,a.ConditionContainer.getInstance().addCondition(r),!0},e.prototype.findManualHeaderCondition=function(){var e=0;if(Utils.isEmptyString(this.currentCalcStep.manualSourceAttribute))switch(this.currentCalcStep.CndCpMetaMetaId.toUpperCase()){case"PERCENTAGE":case"FLATRATE":e=-1*parseFloat(this.currentOrder.getAttribute("HeaderDiscount"))}else switch(this.currentCalcStep.manualSourceAttribute){case"PricingInfo1":e=this.currentOrder.Attributes.getItem("PricingInfo1");break;case"PricingInfo2":e=this.currentOrder.Attributes.getItem("PricingInfo2");break;case"PricingInfo3":e=this.currentOrder.Attributes.getItem("PricingInfo3");break;case"PricingInfo4":e=this.currentOrder.Attributes.getItem("PricingInfo4");break;case"PricingInfo5":e=this.currentOrder.Attributes.getItem("PricingInfo5");break;case"PricingInfo6":e=this.currentOrder.Attributes.getItem("PricingInfo6");break;case"PricingInfo7":e=this.currentOrder.Attributes.getItem("PricingInfo7");break;case"PricingInfo8":e=this.currentOrder.Attributes.getItem("PricingInfo8");break;case"PricingInfo9":e=this.currentOrder.Attributes.getItem("PricingInfo9");break;case"PricingInfo10":e=this.currentOrder.Attributes.getItem("PricingInfo10")}if(0===e)return!1;var t=new a.Condition;return t.Manual=!0,t.CValue=e,t.bCurrencyConverted=!1,t.bFreeItem=!1,t.bUnitConverted=!1,t.Denominator=1,t.sOriginalConditionValue=e.toString(),a.ConditionContainer.getInstance().addCondition(t),!0},e.prototype.calculateHeaderStep=function(e){if(" "===this.currentCalcStep.CndCpItemMetaRulePKey&&"SUMMATION"!==this.currentCalcStep.CndCpMetaMetaId.toUpperCase()&&"Value"!==this.currentCalcStep.Base)return l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Invalid Header Step!"),0;var t=0,r=0,a=0,s=0;if(this.currentCalcStep.HasReference)for(var c=0;c<this.currentOrder.filteredItems.length;c++){this.currentItem=this.currentOrder.getItem(this.currentOrder.filteredItems.getItem(c));var u=0,d=0,p=this.currentItem.nPriceEffect,h=1;Utils.isDefined(this.currentCalcStep.CndCpItemMetaRulePKey)&&" "!==this.currentCalcStep.CndCpItemMetaRulePKey&&(h=this.headerBuckets.getPriceEffect(this.currentCalcStep.CndCpItemMetaRulePKey,this.currentItem.sSdoItemMetaPKey));for(var g=0;g<this.currentCalcStep.ReferenceSteps.length;g++){var C=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.ReferenceSteps.getItem(g).toString(),this.currentItem.SdoItemPKey)*p;u+=C,this.currentCalcStep.isStepSkippedByPromotion(this.currentItem)||(d+=C)}r+=d,"SUMMATION"===this.currentCalcStep.CndCpMetaMetaId.toUpperCase()&&(s+=d*h,a+=d*h,t+=u*h)}else r=this.HeaderBuckets.getAmount(this.currentCalcStep.CndCpItemMetaRulePKey,this.currentCalcStep.SkipSelectablePromotionItems),"SUMMATION"===this.currentCalcStep.CndCpMetaMetaId.toUpperCase()&&(s=r,a=r,t=this.HeaderBuckets.getAmount(this.currentCalcStep.CndCpItemMetaRulePKey,!1));s=i.round(s,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding),a=i.round(a,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding),t=i.round(t,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding);var f=0,I=this.getHeaderConditionEffect(this.currentCalcStep);switch(r+=I,this.currentCalcStep.CndCpMetaMetaId.toUpperCase()){case"SUMMATION":this.oCalculationMatrix.setConditionValue(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey,a),this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey,s+I),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Summation (Header) for: '"+this.currentOrder.sOrderMainPKey+"'. condition result: "+f);break;case"PERCENTAGE":if(this.currentCalcStep.IsScale){var S=r;if("Value"!==this.currentCalcStep.Base&&(S=this.getScaleBase(!0,e)),!(m=this.parseScaleCondition(e,this.currentCalcStep.ScaleType,S,this.currentCalcStep.CndCpMetaMetaId,this.currentItem.Total)).bConditionFound)return e.bConditionFound=!1,t;"Graduated"===this.currentCalcStep.ScaleType?(0===m.Base?e.CValue=0:e.CValue=m.graduatedResult.Result/m.Base,e.graduatedSteps=m.graduatedResultSteps):(e.CValue=m.Rate,e.ScaleCompareValue=m.Value)}this.oCalculationMatrix.updateConditionValue(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey,e.CValue),s+=f=i.round(e.CValue/100*r,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding),a+=f,this.oCalculationMatrix.updateConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey,f),e.CResult=f,this.updateHeaderConditionEffect(this.currentCalcStep,f),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Percentage Discount (Header) for: '"+this.currentOrder.sOrderMainPKey+"'. condition value: "+e.CValue+", condition result: "+f+", total: "+a);break;case"FLATRATE":if(s=r,this.currentCalcStep.IsScale){var m;if(S=r,"Value"!==this.currentCalcStep.Base&&(S=this.getScaleBase(!0,e)),!(m=this.parseScaleCondition(e,this.currentCalcStep.ScaleType,S,this.currentCalcStep.CndCpMetaMetaId,this.currentItem.Total)).bConditionFound)return e.bConditionFound=!1,t;"Graduated"===this.currentCalcStep.ScaleType?(e.CValue=m.graduatedResult.Result/this.HeaderBuckets.getItem(this.currentCalcStep.CndCpItemMetaRulePKey).Quantity,e.graduatedSteps=m.graduatedResultSteps):(e.CValue=m.Rate,e.ScaleCompareValue=m.Value)}this.oCalculationMatrix.updateConditionValue(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey,e.CValue),s+e.CValue<0?(f=-1*s,a-=s,s=0):(f=e.CValue,a+=e.CValue,s+=e.CValue),f=i.round(f,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding),this.oCalculationMatrix.updateConditionResult(this.currentCalcStep.StepNumber,this.currentOrder.sOrderMainPKey,f),e.CResult=f,this.updateHeaderConditionEffect(this.currentCalcStep,a),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("FlatRate Discount (Header) for: '"+this.currentOrder.sOrderMainPKey+"'. condition value: "+e.CValue+", condition result: "+f+", total: "+a)}if(!Utils.isEmptyString(this.currentCalcStep.UserExitId)&&CustomPlugins.ComplexPricingEngine.UserExitAffectCalculationResult){l.SETTINGS.LOG_ENABLED&&(n.LogHandler.getInstance().start("UserExitAffectCalculationResult","CalcMatrix"),n.LogHandler.getInstance().message("UserExitID: "+this.currentCalcStep.UserExitId));var y=[];for(c=0;c<this.currentOrder.filteredItems.length;c++)y.push(this.currentOrder.getItem(this.currentOrder.filteredItems.getItem(c)).getAttributesForUserExit);var b=this.currentOrder.Attributes,P={currentTotal:0,currentCalculationResult:f,currentConditionValue:this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey),currentCalculationBase:e.CBase};P=CustomPlugins.ComplexPricingEngine.UserExitAffectCalculationResult(b.data,this.currentCalcStep.UserExitId,this.currentCalcStep.AttributesForUserExit,null,P,y),Utils.isDefined(P)&&(Utils.isDefined(P.currentCalculationResult)&&P.currentCalculationResult!==f&&(this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,P.currentCalculationResult),f=P.currentCalculationResult),Utils.isDefined(P.currentConditionValue)&&P.currentConditionValue!==this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey)&&this.oCalculationMatrix.setConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,P.currentConditionValue),Utils.isDefined(P.currentCalculationBase)&&P.currentCalculationBase!==e.CBase&&(e.CBase=P.currentCalculationBase)),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("UserExitAffectCalculationResult","CalcMatrix")}var E=0,T=0,O=new i.Dictionary,L=" ",A=0,M=0,R=0,D=new i.Dictionary;for(c=0;c<this.currentOrder.filteredItems.length;c++){this.currentItem=this.currentOrder.getItem(this.currentOrder.filteredItems.getItem(c));var N=this.currentItem.nPriceEffect;if(Utils.isDefined(this.currentCalcStep.CndCpItemMetaRulePKey)&&" "!==this.currentCalcStep.CndCpItemMetaRulePKey&&(N=this.headerBuckets.getPriceEffect(this.currentCalcStep.CndCpItemMetaRulePKey,this.currentItem.sSdoItemMetaPKey)),this.oCalculationMatrix.setConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,a*N),this.currentCalcStep.DistributeToItem&&" "!==this.currentCalcStep.CndCpItemMetaRulePKey){var v="Value";Utils.isDefined(this.currentCalcStep.Base)&&(v=this.currentCalcStep.Base);var V=this.currentCalcStep.isStepSkippedByPromotion(this.currentItem);switch(v){case"Quantity":R=a/this.headerBuckets.getQuantity(this.currentCalcStep.CndCpItemMetaRulePKey,V)*this.currentItem.Qty*N,R=i.round(R,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding),this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,R),(this.currentItem.Qty>A||" "===L)&&(L=this.currentItem.SdoItemPKey,A=this.currentItem.Qty),O.add(this.currentItem.SdoItemPKey,this.currentItem.Qty);break;case"Weight":0===this.headerBuckets.getWeight(this.currentCalcStep.CndCpItemMetaRulePKey,V)?(R=a*this.currentItem.Weight*N,R=i.round(R,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding),this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,R)):(R=a/this.headerBuckets.getWeight(this.currentCalcStep.CndCpItemMetaRulePKey,V)*this.currentItem.Weight*N,R=i.round(R,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding),this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,R)),(this.currentItem.Weight>A||" "===L)&&(L=this.currentItem.SdoItemPKey,A=this.currentItem.Weight),O.add(this.currentItem.SdoItemPKey,this.currentItem.Weight);break;case"Volume":0===this.headerBuckets.getVolume(this.currentCalcStep.CndCpItemMetaRulePKey,V)?(R=a*this.currentItem.Volume*N,R=i.round(R,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding),this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,R)):(R=a/this.headerBuckets.getVolume(this.currentCalcStep.CndCpItemMetaRulePKey,V)*this.currentItem.Volume*N,R=i.round(R,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding),this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,R)),(this.currentItem.Volume>A||" "===L)&&(L=this.currentItem.SdoItemPKey,A=this.currentItem.Volume),O.add(this.currentItem.SdoItemPKey,this.currentItem.Volume);break;case"Value":var U=0;if(this.currentCalcStep.HasReference)for(g=0;g<this.currentCalcStep.ReferenceSteps.length;g++)U+=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.ReferenceSteps.getItem(g).toString(),this.currentItem.SdoItemPKey)*N;else U=this.currentItem.Total;0===r?(R=a*U*N,R=i.round(R,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding),this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,R)):(R=a/r*U*N,R=i.round(R,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding),this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,R)),(U>A||" "===L)&&(L=this.currentItem.SdoItemPKey,A=U),O.add(this.currentItem.SdoItemPKey,U)}M=i.round(R,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding),"FLATRATE"===this.currentCalcStep.CndCpMetaMetaId.toUpperCase()&&M<0&&this.currentItem.Total+M<0?(E=M+this.currentItem.Total,this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,-1*this.currentItem.Total),T+=-1*this.currentItem.Total):(E=R-M,this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,M),T+=M),this.currentCalcStep.IsStatistical||this.currentItem.updateTotalWithPriceEffect(this.currentItem.TotalWithoutPriceEffect+i.round(this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey),this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding));var G=o.DebugData.DebugDataFactory.createStepDebugDataInstance("No",this.currentCalcStep.StepNumber,this.currentCalcStep.CndCpMetaId,this.currentCalcStep.CndCpMetaMetaId,this.currentCalcStep.CndCpMetaPKey,this.currentCalcStep.HasReference?this.currentCalcStep.StepReference:"None",!0,"HeaderStep",e.CValue*N,this.currentCalcStep.ScaleType,this.currentCalcStep.Base,this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey)*N,0,this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey)*N,!1,!1,this.currentItem.PriceReceipt,this.currentItem.BasePriceReceipt,this.currentItem.ValueReceipt,this.currentItem.GrossValueReceipt,this.currentItem.Total*this.currentItem.nPriceEffect,this.currentCalcStep.Rounding,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.IsSubtotal,this.currentCalcStep.DistributeToItem,this.currentCalcStep.IsManual,this.currentCalcStep.CndCpSearchStrategyPKey,this.currentCalcStep.IsStatistical);D.add(this.currentItem.SdoItemPKey,G),t+=this.currentItem.Total*N}else this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,s),"SUMMATION"!==this.currentCalcStep.CndCpMetaMetaId.toUpperCase()&&(t+=this.currentItem.Total*N)}if(t+=this.getHeaderConditionEffect(this.currentCalcStep),E=a-T," "!==L&&0!==E)if("FLATRATE"===this.currentCalcStep.CndCpMetaMetaId.toUpperCase()){var K=O.getKeysSortedByValueDesc();for(g=0;g<K.length;g++){var _,B=this.currentOrder.getItem(K[g]),H=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,K[g]);E=i.round(H+E,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding)-H,_=this.currentOrder.getItem(K[g]).Total+E<0?-1*B.Total:E,this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,K[g],this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,K[g])+_),T+=_,N=B.nPriceEffect,Utils.isDefined(this.currentCalcStep.CndCpItemMetaRulePKey)&&" "!==this.currentCalcStep.CndCpItemMetaRulePKey&&(N=this.headerBuckets.getPriceEffect(this.currentCalcStep.CndCpItemMetaRulePKey,B.sSdoItemMetaPKey)),this.currentCalcStep.IsStatistical||(this.currentOrder.getItem(K[g]).Total=B.Total+_*N,t+=_),D.contains(K[g])&&(D.getItem(K[g]).pCValue=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,K[g]),D.getItem(K[g]).pCResult=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,K[g]),D.getItem(K[g]).pTotal=this.currentOrder.getItem(K[g]).Total);var x=i.round(_,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding);if(D.getItem(K[g]).pRndDiff=String(x),0==(E-=_))break}}else H=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,L),this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,L,i.round(H+E,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding)),T+=E=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,L)-H,N=this.currentOrder.getItem(L).nPriceEffect,Utils.isDefined(this.currentCalcStep.CndCpItemMetaRulePKey)&&" "!==this.currentCalcStep.CndCpItemMetaRulePKey&&(N=this.headerBuckets.getPriceEffect(this.currentCalcStep.CndCpItemMetaRulePKey,this.currentOrder.getItem(L).sSdoItemMetaPKey)),this.currentCalcStep.IsStatistical||(this.currentOrder.getItem(L).Total=this.currentOrder.getItem(L).Total+E*N,t+=E),D.contains(L)&&(D.getItem(L).pCValue=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,L),D.getItem(L).pCResult=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,L),D.getItem(L).pTotal=this.currentOrder.getItem(L).Total);for(c=0;c<this.currentOrder.filteredItems.length;c++)if(this.currentItem=this.currentOrder.getItem(this.currentOrder.filteredItems.getItem(c)),D.contains(this.currentItem.SdoItemPKey)){var F=D.getItem(this.currentItem.SdoItemPKey);F.pCValue=i.round(F.pCValue,6,"1"),F.pCResult=i.round(F.pCResult,6,"1"),F.pTotal=i.round(F.pTotal,6,"1"),this.currentItem.DebugData.addStep(F)}return t},e.prototype.callBaseUserExit=function(e,t){if(!Utils.isEmptyString(this.currentCalcStep.BaseUserExitId)&&CustomPlugins.ComplexPricingEngine.UserExitAffectCurrentConditionBase){l.SETTINGS.LOG_ENABLED&&(n.LogHandler.getInstance().start("callBaseUserExit","CalcMatrix"),n.LogHandler.getInstance().message("UserExitID: "+this.currentCalcStep.BaseUserExitId));var r=[],i=this.currentOrder.Attributes,a={cBase:e,scaleBase:t};if(this.currentCalcStep.IsHeaderCondition||this.currentCalcStep.ItemGrouping){for(var o=0;o<this.currentOrder.filteredItems.length;o++)r.push(this.currentOrder.getItem(this.currentOrder.filteredItems.getItem(o)).getAttributesForUserExit());a=CustomPlugins.ComplexPricingEngine.UserExitAffectCurrentConditionBase(i.data,this.currentCalcStep.BaseUserExitId,this.currentCalcStep.AttributesForUserExit,null,a,this.currentOrder.dTotalValue,r)}else r.push(this.currentItem.getAttributesForUserExit()),a=CustomPlugins.ComplexPricingEngine.UserExitAffectCurrentConditionBase(i.data,this.currentCalcStep.BaseUserExitId,this.currentCalcStep.AttributesForUserExit,this.currentItem.getAttributesForUserExit(),a,this.currentItem.Total,r);Utils.isDefined(a)&&Utils.isDefined(a.cBase)&&(e=a.cBase),Utils.isDefined(a)&&Utils.isDefined(a.scaleBase)&&(t=a.scaleBase),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("callBaseUserExit","CalcMatrix")}return{calcBase:e,scaleBase:t}},e.prototype.callSkipSearchStepUserExit=function(e,t){var r=!1;if(!Utils.isEmptyString(e.ConstraintUserExitId)&&CustomPlugins.ComplexPricingEngine.UserExitSkipCurrentSearchStrategyStep){l.SETTINGS.LOG_ENABLED&&(n.LogHandler.getInstance().start("callSkipSearchStepUserExit","CalcMatrix"),n.LogHandler.getInstance().message("UserExitID: "+e.ConstraintUserExitId));var i=this.currentOrder.Attributes,a=[],o={};if(t)a.push(this.currentItem.getAttributesForUserExit()),o=this.currentItem.getVAttributesForUserExit();else for(var s=0;s<this.currentOrder.filteredItems.length;s++)a.push(this.currentOrder.getItem(this.currentOrder.filteredItems.getItem(s)).getAttributesForUserExit());r=CustomPlugins.ComplexPricingEngine.UserExitSkipCurrentSearchStrategyStep(i.data,e.ConstraintUserExitId,o,a),Utils.isDefined(r)||(r=!1),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("callSkipSearchStepUserExit","CalcMatrix")}return r},e.prototype.updateHeaderConditionEffect=function(e,t){!e.IsHeaderCondition||e.DistributeToItem||e.IsStatistical||(this.headerConditionEffect+=t,e.SkipSelectablePromotionItems&&(this.headerConditionEffectWithoutSelectablePromotionItems+=t))},e.prototype.getHeaderConditionEffect=function(e){return this.currentCalcStep.SkipSelectablePromotionItems?this.headerConditionEffectWithoutSelectablePromotionItems:this.headerConditionEffect},e.prototype.calculateItemStep=function(e){var t,r=0,a=0,o=0,s=0,c=0;switch(this.currentCalcStep.CndCpMetaMetaId.toUpperCase()){case"PRICE":var u;if(u=this.getProductQtyInOtherUoM(this.currentItem.PrdMainPKey,this.currentItem.UoM,e.OriginalUnit,1,!1),e.CBase=this.getProductQtyInOtherUoM(this.currentItem.PrdMainPKey,this.currentItem.UoM,e.OriginalUnit,this.currentItem.Qty,!1),o=0,this.currentCalcStep.IsScale&&(o=this.getScaleBase(!0,e)),t=this.callBaseUserExit(e.CBase,o),e.CBase=t.calcBase,o=t.scaleBase,this.currentCalcStep.IsScale){if(!(h=this.parseScaleCondition(e,this.currentCalcStep.ScaleType,o,this.currentCalcStep.CndCpMetaMetaId,this.currentItem.Total)).bConditionFound)return e.bConditionFound=!1,this.currentItem.LastTotal=r,r;"Graduated"===this.currentCalcStep.ScaleType?(0===e.CBase?e.CValue=0:e.CValue=h.graduatedResult.Total/e.CBase,e.graduatedSteps=h.graduatedResultSteps):(e.CValue=h.Rate,e.ScaleCompareValue=h.Value)}else e.CValue=e.CValue;this.currentCalcStep.IsScale&&"Graduated"===this.currentCalcStep.ScaleType||(e.CBase=e.CBase/e.Denominator),this.currentItem.BasePrice=e.CValue,this.oCalculationMatrix.setConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,e.CValue*p.API.getInstance().CACHE_UnitFactorCache.getUnitFactor(this.currentItem.PrdMainPKey,this.currentItem.UoM,e.OriginalUnit)),r=i.round(e.CBase*e.CValue,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding),e.CResult=r,e.dTotal=r,e.UnitFactor=u,this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,r),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Found price for: '"+this.currentItem.sPrdText+"'. condition value: "+e.CValue+", condition result: "+r+", total: "+r);break;case"PERCENTAGE":if(r=this.currentItem.TotalWithoutPriceEffect,s=0,a=0,this.currentCalcStep.HasReference)for(var d=0;d<this.currentCalcStep.ReferenceSteps.length;d++)a+=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.ReferenceSteps.getItem(d).toString(),this.currentItem.SdoItemPKey);else a=r;if(o=0,this.currentCalcStep.IsScale&&(o=this.getScaleBase(!0,e)),a=(t=this.callBaseUserExit(a,o)).calcBase,o=t.scaleBase,this.currentCalcStep.IsScale){var h=this.parseScaleCondition(e,this.currentCalcStep.ScaleType,o,this.currentCalcStep.CndCpMetaMetaId,this.currentItem.Total);if(e.UnitFactor=this.uoMConversion,this.uoMConversion=1,!h.bConditionFound)return e.bConditionFound=!1,this.currentItem.LastTotal=r,r;"Graduated"===this.currentCalcStep.ScaleType?(e.CValue=0===a?0:h.graduatedResult.Result/a*100,e.graduatedSteps=h.graduatedResultSteps):(e.CValue=h.Rate,e.ScaleCompareValue=h.Value)}this.oCalculationMatrix.updateConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,e.CValue),r+=s=i.round(e.CValue/100*a,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding),e.CResult=s,e.CBase=a,e.dTotal=r,this.oCalculationMatrix.updateConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,s),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Percentage Discount for: '"+this.currentItem.sPrdText+"'. condition value: "+e.CValue+", condition result: "+s+", total: "+r);break;case"FIXAMOUNT":r=this.currentItem.Total;var g=this.currentItem.Qty;if(s=0,u=this.getProductQtyInOtherUoM(this.currentItem.PrdMainPKey,this.currentItem.UoM,e.OriginalUnit,1,!1),e.CBase=this.getProductQtyInOtherUoM(this.currentItem.PrdMainPKey,this.currentItem.UoM,e.OriginalUnit,g,!1),o=0,this.currentCalcStep.IsScale&&(o=this.getScaleBase(!0,e)),t=this.callBaseUserExit(e.CBase,o),e.CBase=t.calcBase,o=t.scaleBase,this.currentCalcStep.IsScale){if(!(h=this.parseScaleCondition(e,this.currentCalcStep.ScaleType,o,this.currentCalcStep.CndCpMetaMetaId,this.currentItem.Total)).bConditionFound)return e.bConditionFound=!1,this.currentItem.LastTotal=r,r;"Graduated"===this.currentCalcStep.ScaleType?(0===e.CBase?e.CValue=0:e.CValue=h.graduatedResult.Result/e.CBase,e.graduatedSteps=h.graduatedResultSteps):(e.CValue=h.Rate,e.ScaleCompareValue=h.Value)}else e.CValue=e.CValue;this.currentCalcStep.IsScale&&"Graduated"===this.currentCalcStep.ScaleType||(e.CBase=e.CBase/e.Denominator),this.oCalculationMatrix.updateConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,e.CValue),r+=s=i.round(e.CValue*e.CBase,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding),e.CResult=s,e.dTotal=r,e.UnitFactor=u,this.oCalculationMatrix.updateConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,s),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Fix Amount Discount for: '"+this.currentItem.sPrdText+"'. condition value: "+e+", condition result: "+s+", total: "+r);break;case"FLATRATE":if(r=this.currentItem.Total,s=0,o=0,this.currentCalcStep.IsScale&&(o=this.getScaleBase(!0,e)),o=(t=this.callBaseUserExit(0,o)).scaleBase,this.currentCalcStep.IsScale){if(h=this.parseScaleCondition(e,this.currentCalcStep.ScaleType,o,this.currentCalcStep.CndCpMetaMetaId,this.currentItem.Total),e.UnitFactor=this.uoMConversion,this.uoMConversion=1,!h.bConditionFound)return e.bConditionFound=!1,this.currentItem.LastTotal=r,r;e.CValue=h.Rate,e.ScaleCompareValue=h.Value}this.oCalculationMatrix.updateConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,e.CValue),r+(s=i.round(e.CValue,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding))<0&&(s=-1*r),e.CBase=r,r+=s,e.CResult=s,e.dTotal=r,this.oCalculationMatrix.updateConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,s),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("FlatRate Discount for: '"+this.currentItem.sPrdText+"'. condition value: "+e.CValue+", condition result: "+s+", total: "+r);break;case"LASTVLDVAL":r=this.currentItem.Total,this.oCalculationMatrix.setConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,e.CValue),s=i.round(r,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding)*this.currentItem.nPriceEffect,this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,s),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Last Valid Value for: '"+this.currentItem.sPrdText+"'. condition result: "+s);break;case"MAXIMUM":if(r=this.currentItem.Total,s=0,a=0,c=0,this.oCalculationMatrix.setConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,e.CValue),this.currentCalcStep.HasReference){for(d=0;d<this.currentCalcStep.ReferenceSteps.length;d++)c=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.ReferenceSteps.getItem(d).toString(),this.currentItem.SdoItemPKey),(0===d||a<c)&&(a=c);s=a}this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,s),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Maximum for: '"+this.currentItem.sPrdText+"'. condition result: "+s);break;case"MINIMUM":if(r=this.currentItem.Total,s=0,a=0,c=0,this.oCalculationMatrix.setConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,e.CValue),this.currentCalcStep.HasReference){for(d=0;d<this.currentCalcStep.ReferenceSteps.length;d++)c=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.ReferenceSteps.getItem(d).toString(),this.currentItem.SdoItemPKey),(0===d||a>c)&&(a=c);s=a}this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,s),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Minimum for: '"+this.currentItem.sPrdText+"'. condition result: "+s);break;case"SUMMATION":if(r=this.currentItem.Total,s=0,a=0,this.oCalculationMatrix.setConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,e.CValue),this.currentCalcStep.HasReference){for(d=0;d<this.currentCalcStep.ReferenceSteps.length;d++)a+=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.ReferenceSteps.getItem(d).toString(),this.currentItem.SdoItemPKey);s=a}this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,s),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Summation for: '"+this.currentItem.sPrdText+"'. condition result: "+s);break;case"FREEGOOD":r=this.currentItem.Total,s=0,this.oCalculationMatrix.setConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,e.CValue),s=-1*r,r=0,this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,s),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Free item discount for: '"+this.currentItem.sPrdText+"'. condition result: "+s)}if(!Utils.isEmptyString(this.currentCalcStep.CalcVariable))if(this.currentCalcStep.CalcVariable.indexOf("Copy")>-1)this.currentItem.setAttribute(this.currentCalcStep.CalcVariable,this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey)),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Copy Variable (Item Level) filled: "+this.currentCalcStep.CalcVariable+" <-- "+this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey));else if(this.currentCalcStep.CalcVariable.indexOf("Carry")>-1){var C=this.currentItem.getAttribute(this.currentCalcStep.CalcVariable);Utils.isEmptyString(C),this.currentItem.setAttribute(this.currentCalcStep.CalcVariable,C+this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey)),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Carry Over Variable (Item Level) filled: "+this.currentCalcStep.CalcVariable+" <-- "+C+this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey))}if(!Utils.isEmptyString(this.currentCalcStep.UserExitId)&&CustomPlugins.ComplexPricingEngine.UserExitAffectCalculationResult){l.SETTINGS.LOG_ENABLED&&(n.LogHandler.getInstance().start("UserExitAffectCalculationResult","CalcMatrix"),n.LogHandler.getInstance().message("UserExitID: "+this.currentCalcStep.UserExitId));var f=[],I=this.currentOrder.Attributes;f.push(this.currentItem.getAttributesForUserExit());var S={currentTotal:r,currentCalculationResult:this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey),currentConditionValue:this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey),currentCalculationBase:e.CBase};S=CustomPlugins.ComplexPricingEngine.UserExitAffectCalculationResult(I.data,this.currentCalcStep.UserExitId,this.currentCalcStep.AttributesForUserExit,this.currentItem.getVAttributesForUserExit(),S,f),Utils.isDefined(S)&&(Utils.isDefined(S.currentCalculationResult)&&S.currentCalculationResult!==s&&this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,S.currentCalculationResult),Utils.isDefined(S.currentConditionValue)&&S.currentConditionValue!==this.oCalculationMatrix.getConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey)&&this.oCalculationMatrix.setConditionValue(this.currentCalcStep.StepNumber,this.currentItem.SdoItemPKey,S.currentConditionValue),Utils.isDefined(S.currentCalculationBase)&&S.currentCalculationBase!==e.CBase&&(e.CBase=S.currentCalculationBase),Utils.isDefined(S.currentTotal)&&S.currentTotal!==r&&(r=S.currentTotal,this.currentItem.updateTotalWithPriceEffect(r))),l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("UserExitAffectCalculationResult","CalcMatrix")}return this.currentItem.LastTotal=r,r},e.prototype.calculateGroup=function(e){var t,r=0,n=0,a=0;switch(this.currentCalcStep.CndCpMetaMetaId.toUpperCase()){case"PERCENTAGE":var o=r=this.currentGroupBucket.Value;if(n=0,this.currentCalcStep.IsScale&&(n=this.getScaleBase(!0,e)),this.currentCalcStep.IsScale&&!(t=this.parseScaleCondition(e,this.currentCalcStep.ScaleType,n,this.currentCalcStep.CndCpMetaMetaId,r)).bConditionFound)return a;r+=a=i.round(t.Rate/100*o,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding);break;case"FIXAMOUNT":r=this.currentGroupBucket.Value;var s=this.calculateGroupBucketQuantity();if(this.currentCalcStep.IsScale&&(n=this.getScaleBase(!0,e),!(t=this.parseScaleCondition(e,this.currentCalcStep.ScaleType,n,this.currentCalcStep.CndCpMetaMetaId,this.currentItem.Total)).bConditionFound))return a;r+=a=i.round(t.Rate*(s/e.Denominator),this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding)}return a},e.prototype.adjustGroupLastCent=function(e,t){var r=this.calculateGroup(this.currentGroupBucket.Condition);r=i.round(r,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding),t=i.round(t,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding);var n=i.round(r-t,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding),a=0;0!==n&&i.round(t+n,this.currentCalcStep.DecimalPlaces,this.currentCalcStep.Rounding)===r&&(a=n*e.nPriceEffect,this.oCalculationMatrix.setConditionResult(this.currentCalcStep.StepNumber,e.SdoItemPKey,this.oCalculationMatrix.getConditionResult(this.currentCalcStep.StepNumber,e.SdoItemPKey)+a),this.currentItem.currentCalcStepDebugData.pRndDiff=String(a))},e.prototype.createMergedKeyList=function(e,t){var r=new i.List,a=new i.List;if(a.add("INVALID"),e.ConsiderReward){var o=this.currentOrder.getRewardCache().getItem(t);Utils.isDefined(o)&&o.forEach((function(e){r.add(e.rewardPKey+"+"+e.promotionPKey)}))}if(e.ConsiderBpaMain){var s=new i.List;if(e.BpaHierarchySearch!==u.BpaHierachy.NONE)switch(e.BpaHierarchySearch){case u.BpaHierachy.ALL:this.customerHierarchy.forEach((function(e){s.add(e)}));break;case u.BpaHierachy.LEVEL1:this.customerHierarchy.contains("CustLevel01")?s.add(this.customerHierarchy.getItem("CustLevel01")):r.add("NOKeyFound");break;case u.BpaHierachy.LEVEL2:this.customerHierarchy.contains("CustLevel02")?s.add(this.customerHierarchy.getItem("CustLevel02")):r.add("NOKeyFound");break;case u.BpaHierachy.LEVEL3:this.customerHierarchy.contains("CustLevel03")?s.add(this.customerHierarchy.getItem("CustLevel03")):r.add("NOKeyFound");break;case u.BpaHierachy.LEVEL4:this.customerHierarchy.contains("CustLevel04")?s.add(this.customerHierarchy.getItem("CustLevel04")):r.add("NOKeyFound");break;case u.BpaHierachy.LEVEL5:this.customerHierarchy.contains("CustLevel05")?s.add(this.customerHierarchy.getItem("CustLevel05")):r.add("NOKeyFound");break;case u.BpaHierachy.LEVEL6:this.customerHierarchy.contains("CustLevel06")?s.add(this.customerHierarchy.getItem("CustLevel06")):r.add("NOKeyFound");break;case u.BpaHierachy.LEVEL7:this.customerHierarchy.contains("CustLevel07")?s.add(this.customerHierarchy.getItem("CustLevel07")):r.add("NOKeyFound")}else this.populateCustomerRoleForMergedKey(e,s);if(r.length<1)r=s;else{for(var c=new i.List,d=0;d<r.length;d++)for(var p=0;p<s.length;p++)c.add(r.getItem(d)+"+"+this.customerSets[p]);r=c}}if(e.ConsiderBpaSet)if(r.length<1)r.addRange(this.customerSets);else{var h=new i.List;for(d=0;d<r.length;d++)for(p=0;p<this.customerSets.length;p++)h.add(r.getItem(d)+"+"+this.customerSets[p]);r=h}if(e.ConsiderPrdMain&&e.PrdHierarchySearch===u.PrdHierachy.NONE)if(this.currentCalcStep.IsHeaderCondition)this.currentCalcStep.IsManual||(this.invalidCalcStep=this.currentCalcStep.StepNumber),r=a;else if(r.length<1)r.add(this.currentItem.PrdMainPKey);else{var g=new i.List;for(d=0;d<r.length;d++)g.add(r.getItem(d)+"+"+this.currentItem.PrdMainPKey);r=g}if(e.PrdHierarchySearch!==u.PrdHierachy.NONE)if(this.currentCalcStep.IsHeaderCondition)this.currentCalcStep.IsManual||(this.invalidCalcStep=this.currentCalcStep.StepNumber),r=a;else{var C=new i.List,f=void 0;switch(e.PrdHierarchySearch){case u.PrdHierachy.ALL:var I=this.API.CACHE_ProductHierarchy.getItem(this.currentItem.PrdMainPKey);if(!Utils.isDefined(I))break;for(var S=[],m=0;m<I.length;m++)Utils.isEmptyString(I[m])||S.push(I[m]);if(0===r.length)C.addRange(S);else for(var y=0;y<r.length;y++)for(var b=0;b<S.length;b++)C.add(r.getItem(y)+"+"+S[b]);break;case u.PrdHierachy.LEVEL1:if(f=this.API.CACHE_ProductHierarchy.getItem(this.currentItem.PrdMainPKey)[0],!Utils.isEmptyString(f))for(0===r.length&&C.add(f),d=0;d<r.length;d++)C.add(r.getItem(d)+"+"+f);break;case u.PrdHierachy.LEVEL2:if(f=this.API.CACHE_ProductHierarchy.getItem(this.currentItem.PrdMainPKey)[1],!Utils.isEmptyString(f))for(0===r.length&&C.add(f),d=0;d<r.length;d++)C.add(r.getItem(d)+"+"+f);break;case u.PrdHierachy.LEVEL3:if(f=this.API.CACHE_ProductHierarchy.getItem(this.currentItem.PrdMainPKey)[2],!Utils.isEmptyString(f))for(0===r.length&&C.add(f),d=0;d<r.length;d++)C.add(r.getItem(d)+"+"+f);break;case u.PrdHierachy.LEVEL4:if(f=this.API.CACHE_ProductHierarchy.getItem(this.currentItem.PrdMainPKey)[3],!Utils.isEmptyString(f))for(0===r.length&&C.add(f),d=0;d<r.length;d++)C.add(r.getItem(d)+"+"+f);break;case u.PrdHierachy.LEVEL5:if(f=this.API.CACHE_ProductHierarchy.getItem(this.currentItem.PrdMainPKey)[4],!Utils.isEmptyString(f))for(0===r.length&&C.add(f),d=0;d<r.length;d++)C.add(r.getItem(d)+"+"+f)}r=C}if(e.ConsiderPrdSet)if(this.currentCalcStep.IsHeaderCondition)this.currentCalcStep.IsManual||(this.invalidCalcStep=this.currentCalcStep.StepNumber),r=a;else if(0===r.length)this.API.CACHE_ProductSets.contains(this.currentItem.PrdMainPKey)&&r.addRange(this.API.CACHE_ProductSets.getItem(this.currentItem.PrdMainPKey));else{var P=new i.List;for(d=0;d<r.length;d++){var E=this.API.CACHE_ProductSets.getItem(this.currentItem.PrdMainPKey);if(Utils.isDefined(E))for(p=0;p<E.length;p++)P.add(r.getItem(d)+"+"+E[p])}r=P}if(e.ConsiderPromotion)if(0===r.length)r.addRange(this.promotions);else{var T=new i.List;for(d=0;d<r.length;d++)for(p=0;p<this.promotions.length;p++)T.add(r.getItem(d)+"+"+this.promotions[p]);r=T}var O=new i.List,L=[];for(p=0;p<e.KeyInfo.length;p++){var A=e.KeyInfo[p];switch(A.entity){case"Customer":var M=this.currentOrder.getCustomerAttribute(A.attribute);i.isEmptyString(M)&&n.LogHandler.getInstance().warning("Invalid customer attribute '"+A.attribute+"' defined in key type '"+e.CndCpKeyTypePKey+"'."),L.push(M);break;case"Product":if(this.currentCalcStep.IsHeaderCondition)this.currentCalcStep.IsManual||(this.invalidCalcStep=this.currentCalcStep.StepNumber),r=a;else if(this.API.CACHE_ProductData.contains(this.currentItem.PrdMainPKey)){var R=this.API.CACHE_ProductData.getItem(this.currentItem.PrdMainPKey);R.contains(A.attribute)?L.push(R.getItem(A.attribute)):(n.LogHandler.getInstance().warning("Invalid product attribute '"+A.attribute+"' defined in key type '"+e.CndCpKeyTypePKey+"'."),L.push(" "))}break;case"Order":var D=this.currentOrder.getAttribute(A.attribute);i.isEmptyString(D)&&n.LogHandler.getInstance().warning("Invalid order attribute '"+A.attribute+"' defined in key type '"+e.CndCpKeyTypePKey+"'."),L.push(D);break;case"OrderItem":if(this.currentCalcStep.IsHeaderCondition)this.currentCalcStep.IsManual||(this.invalidCalcStep=this.currentCalcStep.StepNumber),r=a;else{var N=this.currentItem.getAttribute(A.attribute);i.isEmptyString(N)&&n.LogHandler.getInstance().warning("Invalid order item attribute '"+A.attribute+"' defined in key type '"+e.CndCpKeyTypePKey+"'."),L.push(N)}break;case"Item":switch(A.attribute){case"String1":L.push(this.currentItem.getAttribute("VariantMainString1"));break;case"String2":L.push(this.currentItem.getAttribute("VariantMainString2"));break;case"String3":L.push(this.currentItem.getAttribute("VariantMainString3"));break;case"String4":L.push(this.currentItem.getAttribute("VariantMainString4"));break;case"String5":L.push(this.currentItem.getAttribute("VariantMainString5"));break;case"Decimal1":L.push(this.currentItem.getAttribute("VariantMainDecimal1"));break;case"Decimal2":L.push(this.currentItem.getAttribute("VariantMainDecimal2"));break;case"Decimal3":L.push(this.currentItem.getAttribute("VariantMainDecimal3"));break;case"Decimal4":L.push(this.currentItem.getAttribute("VariantMainDecimal4"));break;case"Decimal5":L.push(this.currentItem.getAttribute("VariantMainDecimal5"))}break;case"Main":switch(A.attribute){case"String1":L.push(this.currentOrder.getAttribute("VariantMainString1"));break;case"String2":L.push(this.currentOrder.getAttribute("VariantMainString2"));break;case"String3":L.push(this.currentOrder.getAttribute("VariantMainString3"));break;case"String4":L.push(this.currentOrder.getAttribute("VariantMainString4"));break;case"String5":L.push(this.currentOrder.getAttribute("VariantMainString5"));break;case"Decimal1":L.push(this.currentOrder.getAttribute("VariantMainDecimal1"));break;case"Decimal2":L.push(this.currentOrder.getAttribute("VariantMainDecimal2"));break;case"Decimal3":L.push(this.currentOrder.getAttribute("VariantMainDecimal3"));break;case"Decimal4":L.push(this.currentOrder.getAttribute("VariantMainDecimal4"));break;case"Decimal5":L.push(this.currentOrder.getAttribute("VariantMainDecimal5"))}}}if(e.ConsiderSalesOrg&&L.push(l.SETTINGS.SALES_ORG),e.ConsiderDistribChannel&&L.push(l.SETTINGS.DISTRIBCHANNEL),e.ConsiderDivision&&L.push(l.SETTINGS.DIVISION),L.length>0){if(r.length>0)for(d=0;d<r.length;d++)O.add(r.getItem(d)+"+"+L.join("+"));else O.add(L.join("+"));O.length>0&&(r=O)}return r},e.prototype.showErrorMessage=function(e){l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("showErrorMessage","CalcMatrix");var t={};t[Locale.translate("OK")]="ok";var r=Locale.translate(e);return Utils.isDefined(r)&&"CasSdoCpInvalidKeyAttribue"===e&&(r=r.replace("#Stepnumber#",this.invalidCalcStep)),MessageBox.displayMessage(Locale.translate("MessageBox_Title_Notification"),r,t).then((function(){l.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("showErrorMessage","CalcMatrix")}))},e.prototype.populateCustomerRoleForMergedKey=function(e,t){e.CustomerRole===u.CustomerRole.Orderer?t.add(this.currentOrder.getAttribute("OrdererBpaMainPKey")):e.CustomerRole===u.CustomerRole.Deliv?t.add(this.currentOrder.getAttribute("DeliveryRecipientPKey")):e.CustomerRole===u.CustomerRole.Payer?t.add(this.currentOrder.getAttribute("PayerCustomerPKey")):e.CustomerRole===u.CustomerRole.BillTo&&t.add(this.currentOrder.getAttribute("BillToCustomerPKey"))},e.prototype.convertConditionToArray=function(e){return!i.isDefined(e)||e.cnd instanceof Array||(e.cnd=[e.cnd]),e},e.prototype.parseConditionValue=function(e,t,r){if(!Utils.isDefined(e))return!1;if(e.cnd instanceof Array){for(var n=!1,i=0;i<e.cnd.length;i++)n=n||this.validateAndConvertConditionValue(e.cnd[i],t,r);return n}return this.validateAndConvertConditionValue(e.cnd,t,r)},e.prototype.checkIfUoMConversionIsPossible=function(e,t){return!!p.API.getInstance().CACHE_UnitFactorCache.containsFactor(e,t)},e.prototype.parseFreeItemCondition=function(e,t){var r;r=e.cnd instanceof Array?this.getFreeItemForTimeFrame(e.cnd):this.getFreeItemForTimeFrame([e.cnd]);var n=new a.Condition;if(n.origCondition=e,Utils.isDefined(r)){n.ThresholdUnit=r.tu,n.OriginalUnit=r.u,n.scale=r;var i=this.getScaleBase(!0,n);return"MULTIBUY"===this.currentCalcStep.CndCpMetaMetaId.toUpperCase()?this.parseMultiBuyScaleCondition(r,i):this.parseScaleCondition(n,t,i,"FREEGOOD",0)}return{FreeItemPKey:"",Rate:0,Base:0,Value:0,FreeUoM:"",bConditionFound:!1,graduatedResult:{Value:0,Result:0,Base:0,Total:0},graduatedResultSteps:[]}},e.prototype.parseMultiBuyScaleCondition=function(e,t){var r;if(r={FreeItemPKey:"",Rate:0,Base:t,Value:0,FreeUoM:"",bConditionFound:!1,graduatedResult:{Value:0,Result:0,Base:0,Total:0},graduatedResultSteps:[]},Utils.isDefined(e)&&Utils.isDefined(e.scl)){var n=this.currentCalcStep.IsFreeItem;(e=e.scl)instanceof Array||(e=[e]),r.bConditionFound=!0,r.FreeItemPKey=n?e[0].prd:"";var i=t/parseInt(e[0].sv);return r.Rate=Math.floor(i)*e[0].r,r.Value=e[0].sv,r.FreeUoM=n?e[0].u:"",r}return null},e.prototype.parseScaleCondition=function(e,t,r,n,a){var o,s=e.scale,c=!1,u=l.SETTINGS.HOME_CURRENCY;if(o={FreeItemPKey:"",Rate:0,Base:r,Value:0,FreeUoM:"",bConditionFound:!1,graduatedResult:{Value:0,Result:0,Base:0,Total:0},graduatedResultSteps:[]},Utils.isDefined(s.c)&&"Percentage"!==this.currentCalcStep.CndCpMetaMetaId&&s.c!==this.currentOrder.ReceiptCurrency&&(c=!0,u=s.c),Utils.isDefined(s)){var d=this.currentCalcStep.IsFreeItem,p=null;switch((s=s.scl)instanceof Array||(s=[s]),t){case"From":if(p=null,s.length>1){for(var h=0;h<s.length;h++){if(s[h].sv=parseFloat(s[h].sv),s[h].r=parseFloat(s[h].r),Utils.isDefined(p)&&s[h].sv>r&&p.sv<=r){o.bConditionFound=!0,o.FreeItemPKey=d?p.prd:"",o.Value=p.sv,o.Rate=p.r,o.FreeUoM=d?p.u:"";break}if(s[h].sv<=r&&h+1===s.length){o.bConditionFound=!0,o.FreeItemPKey=d?s[h].prd:"",o.Rate=s[h].r,o.Value=s[h].sv,o.FreeUoM=d?s[h].u:"";break}p=s[h]}!o.bConditionFound&&Utils.isDefined(p)&&p.sv}else s[0].sv=parseFloat(s[0].sv),s[0].r=parseFloat(s[0].r),s[0].sv<=r&&(o.FreeItemPKey=d?s[0].prd:"",o.bConditionFound=!0,o.Value=s[0].sv,o.Rate=s[0].r,o.FreeUoM=d?s[0].u:"");break;case"To":for(p=null,h=0;h<s.length;h++){if(s[h].sv=parseFloat(s[h].sv),s[h].r=parseFloat(s[h].r),!Utils.isDefined(p)&&s[h].sv>=r||Utils.isDefined(p)&&p.sv<r&&s[h].sv>=r){o.bConditionFound=!0,o.FreeItemPKey=d?s[h].prd:"",o.Rate=s[h].r,o.Value=s[h].sv,o.FreeUoM=d?s[h].u:"";break}p=s[h]}break;case"Graduated":p=null;var g=0;for(h=0;h<s.length;h++){s[h].sv=parseFloat(s[h].sv),s[h].r=parseFloat(s[h].r);var C;(C=Utils.isDefined(p)?r-s[h].sv>0?s[h].sv-p.sv:r-g:s[h].sv<r?parseFloat(s[h].sv):r)>0&&(o.bConditionFound=!0);var f=C;switch(f=e.ThresholdUnit!==e.OriginalUnit&&"PERCENTAGE"!==n.toUpperCase()?this.getProductQtyInOtherUoM(this.currentItem.PrdMainPKey,e.ThresholdUnit,e.OriginalUnit,C,!1):i.round(f,l.SETTINGS.UOMROUNDINGFACTOR,"1"),n.toUpperCase()){case"PRICE":o.graduatedResult.Total=o.graduatedResult.Total+f/e.Denominator*s[h].r,o.graduatedResultSteps.push({Base:f/e.Denominator,Value:s[h].r,Result:f*s[h].r,Total:o.graduatedResult.Total});break;case"PERCENTAGE":if(f=C,"Quantity"===this.currentCalcStep.Base){var I=C;e.ThresholdUnit!==e.OriginalUnit&&(I=this.getProductQtyInOtherUoM(this.currentItem.PrdMainPKey,this.currentItem.UoM,e.ThresholdUnit,this.currentItem.Qty,!0)),f=a/r*C*(C/I)}o.graduatedResult.Result=o.graduatedResult.Result+f*s[h].r/100,o.graduatedResultSteps.push({Base:f,Value:s[h].r,Result:f*s[h].r/100,Total:o.graduatedResult.Result+a});break;case"FIXAMOUNT":o.graduatedResult.Total=o.graduatedResult.Total+f/e.Denominator*s[h].r,o.graduatedResult.Result=o.graduatedResult.Result+f/e.Denominator*s[h].r,o.graduatedResult.Value=o.graduatedResult.Value+s[h].r,o.graduatedResult.Base=o.graduatedResult.Base+f,o.graduatedResultSteps.push({Base:f/e.Denominator,Value:s[h].r,Result:f/e.Denominator*s[h].r,Total:o.graduatedResult.Total})}if(s[h].sv>=r)break;g+=C,p=s[h]}}}return c&&o.bConditionFound&&(e.sOriginalConditionValue=o.Rate.toString(),o.Rate=this.convertCurrency(o.Rate),e.sOriginalCurrency=u,e.IsCurrencyConverted=!0),o},e.prototype.getFreeItemForTimeFrame=function(e){for(var t=0;t<e.length;t++)if(Utils.convertAnsiDate2Date(e[t].f)<=this.CurrentPricingDate&&Utils.convertAnsiDate2Date(e[t].t)>=this.CurrentPricingDate)return this.currentCalcSchema.IsPDARelevant&&!p.API.getInstance().CACHE_UnitFactorCache.getPDARelevanceOfUnit(this.currentItem.PrdMainPKey,this.currentItem.UoM,e[t].u)?null:e[t];return null},e.prototype.validateAndConvertConditionValue=function(e,t,r){if(!Utils.isEmptyString(e.u)&&e.u!==this.currentItem.UoM&&!this.checkIfUoMConversionIsPossible(this.currentItem.PrdMainPKey,e.u))return!1;var n=new a.Condition;if(n.sNo=r,n.sOriginalCurrency=e.c,n.sOriginalUnit=e.u,Utils.convertAnsiDate2Date(e.f)<=this.CurrentPricingDate&&Utils.convertAnsiDate2Date(e.t)>=this.CurrentPricingDate){if(e.c!==l.SETTINGS.HOME_CURRENCY&&e.c!==this.currentOrder.getAttribute("Currency")&&"PERCENTAGE"!==this.currentCalcStep.CndCpMetaMetaId.toUpperCase()||t){if(!t)return!1;if(!e.scl||!e.scl.length)return!1;n.Denominator=e.d||1,n.ThresholdUnit=e.tu,n.OriginalUnit=e.u,n.scale=e,n.SortOn=e.s||""}else{if(n.sOriginalConditionValue=e.v,n.CValue=parseFloat(e.v),n.Denominator=e.d||1,n.ThresholdUnit=e.tu,n.OriginalUnit=e.u,n.SortOn=e.s||"","PERCENTAGE"!==this.currentCalcStep.CndCpMetaMetaId.toUpperCase()&&this.currentCalcSchema.IsPDARelevant&&!p.API.getInstance().CACHE_UnitFactorCache.getPDARelevanceOfUnit(this.currentItem.PrdMainPKey,this.currentItem.UoM,e.u))return!1;if(e.c!==this.currentOrder.getAttribute("Currency")&&"PERCENTAGE"!==this.currentCalcStep.CndCpMetaMetaId.toUpperCase()){if(!(this.currentOrder.conversionFactor>-1))return!1;n.bCurrencyConverted=!0,n.CValue=this.convertCurrency(n.CValue)}}return a.ConditionContainer.getInstance().addCondition(n),!0}return!1},e.prototype.getScaleBase=function(e,t){var r,n;if(n=this.currentCalcStep.IsHeaderCondition?this.currentCalcStep.SkipSelectablePromotionItems:this.currentCalcStep.isStepSkippedByPromotion(this.currentItem),this.currentCalcStep.IsHeaderCondition)switch(this.currentCalcStep.Base){case"Volume":r=this.headerBuckets.getVolume(this.currentCalcStep.CndCpItemMetaRulePKey,n);break;case"Weight":r=this.headerBuckets.getWeight(this.currentCalcStep.CndCpItemMetaRulePKey,n);break;case"Value":r=this.headerBuckets.getAmount(this.currentCalcStep.CndCpItemMetaRulePKey,n)}else if(this.currentCalcStep.ItemGrouping)switch(this.currentCalcStep.Base){case"Volume":r=this.currentGroupBucket.Volume;break;case"Weight":r=this.currentGroupBucket.Weight;break;case"Value":r=this.currentGroupBucket.Value;break;case"Quantity":r=this.calculateGroupBucketQuantity()}else switch(this.currentCalcStep.Base){case"Volume":r=this.currentItem.Volume;break;case"Weight":r=this.currentItem.Weight;break;case"Value":if(r=0,this.currentCalcStep.HasReference)for(var i=0;i<this.currentCalcStep.ReferenceSteps.length;i++)r+=this.oCalculationMatrix.getConditionResult(this.currentCalcStep.ReferenceSteps.getItem(i).toString(),this.currentItem.SdoItemPKey);else r=this.currentItem.LastTotal;break;case"Quantity":if(r=this.currentItem.Qty,Utils.isDefined(e)&&Utils.isDefined(t)){var a=e?t.ThresholdUnit:t.OriginalUnit;r=this.getProductQtyInOtherUoM(this.currentItem.PrdMainPKey,this.currentItem.UoM,a,r,e)}}return r},e.prototype.getProductQtyInOtherUoM=function(e,t,r,n,a){if(this.currentCalcStep.IsManual)return n;if(t===r)return n;if(p.API.getInstance().CACHE_UnitFactorCache.containsFactor(e,t)){var o=p.API.getInstance().CACHE_UnitFactorCache.getUnitFactor(e,t,r);return o>-1?(this.uoMConversion=o,i.round(n*o,l.SETTINGS.UOMROUNDINGFACTOR,"1")):0}},e.prototype.calculateGroupBucketQuantity=function(){for(var e,t=0,r=0;r<this.currentGroupBucket.Items.length;r++){var n=this.currentGroupBucket.Items.getItem(r);e=this.headerBuckets.contains(this.currentCalcStep.CndCpItemMetaRulePKey)?this.headerBuckets.getPriceEffect(this.currentCalcStep.CndCpItemMetaRulePKey,n.sSdoItemMetaPKey):n.nPriceEffect,n.UoM!==this.currentGroupBucket.Condition.ThresholdUnit?t+=this.getProductQtyInOtherUoM(n.PrdMainPKey,n.UoM,this.currentGroupBucket.Condition.ThresholdUnit,n.Qty,!0)*e:t+=n.Qty*e}return i.round(t,8,"1")},e.prototype.convertCurrency=function(t,r){void 0===r&&(r=!1);var n=e.getInstance().currentOrder.conversionFactor,i=e.getInstance().currentOrder.conversionFactorAmount,a=e.getInstance().currentOrder.isInvertedCurrencyConversion;if(r&&(a=!a),-1===n)throw new Error("No conversion found between ReceiptCurrency and HomeCurrency");return a?t/(n/i):t*(n/i)},e._instance=null,e}();t.CalcMatrix=h;var g=function(){function e(){this.calcStepMatrix=new i.Dictionary}return e.prototype.getConditionValue=function(e,t){var r=0;return this.calcStepMatrix.contains(e)&&this.calcStepMatrix.getItem(e).getItem(t)&&(r=this.calcStepMatrix.getItem(e).getItem(t).getConditionValue()),r},e.prototype.getConditionResult=function(e,t){var r=0;return this.calcStepMatrix.contains(e)&&this.calcStepMatrix.getItem(e).getItem(t)&&(r=this.calcStepMatrix.getItem(e).getItem(t).getConditionResult()),r},e.prototype.getCalculationSteps=function(){return this.calcStepMatrix},e.prototype.addCalcRow=function(e,t){if(this.calcStepMatrix.contains(e))this.calcStepMatrix.getItem(e).contains(t)?this.calcStepMatrix.getItem(e).update(t,new C):this.calcStepMatrix.getItem(e).add(t,new C);else{var r=new i.Dictionary;r.add(t,new C),this.calcStepMatrix.add(e,r)}},e.prototype.setConditionValue=function(e,t,r){this.calcStepMatrix.contains(e)&&this.calcStepMatrix.getItem(e).contains(t)&&this.calcStepMatrix.getItem(e).getItem(t).setConditionValue(r)},e.prototype.setConditionResult=function(e,t,r){this.calcStepMatrix.contains(e)&&this.calcStepMatrix.getItem(e).contains(t)&&this.calcStepMatrix.getItem(e).getItem(t).setConditionResult(r)},e.prototype.updateConditionValue=function(e,t,r){this.calcStepMatrix.contains(e)&&this.calcStepMatrix.getItem(e).contains(t)&&this.calcStepMatrix.getItem(e).getItem(t).updateConditionValue(r)},e.prototype.updateConditionResult=function(e,t,r){this.calcStepMatrix.contains(e)&&this.calcStepMatrix.getItem(e).contains(t)&&this.calcStepMatrix.getItem(e).getItem(t).updateConditionResult(r)},e.prototype.resetMatrixForProduct=function(e){for(var t=this.calcStepMatrix.getSortedKeys(),r=0;r<t.length;r++)this.calcStepMatrix.getItem(t[r]).contains(e)&&(this.calcStepMatrix.getItem(t[r]).getItem(e).setConditionResult(0),this.calcStepMatrix.getItem(t[r]).getItem(e).setConditionValue(0))},e}(),C=function(){function e(){this.dConditionResult=0,this.dConditionValue=0}return e.prototype.getConditionValue=function(){return this.dConditionValue},e.prototype.setConditionValue=function(e){this.dConditionValue=e},e.prototype.setConditionResult=function(e){this.dConditionResult=e},e.prototype.updateConditionValue=function(e){this.dConditionValue=e+this.dConditionValue},e.prototype.updateConditionResult=function(e){this.dConditionResult=this.dConditionResult+e},e.prototype.getConditionResult=function(){return this.dConditionResult},e}()},503:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PrdHierachy=t.CustomerRole=t.BpaHierachy=t.KeyType=t.CalculationStep=t.CalculationSchema=void 0;var n=r(346),i=r(237),a=function(){function e(e){this.listCalcSteps=new n.List,this.dicCalcSteps=new n.Dictionary,this.IsPDARelevant=!1,this.hasBpaSets=!1,this.hasAutoGrantedPromotions=!1,this.hasRewards=!1,this.hasPrdAssortments=!1,this.calcSchemaPkey=e}return e.prototype.getCalcStepByIndex=function(e){var t=this.listCalcSteps.getItem(e);return this.dicCalcSteps.getItem(t)},e.prototype.getCalcStepByKey=function(e){return this.dicCalcSteps.getItem(e)},e.prototype.clear=function(){this.calcSchemaPkey="",this.listCalcSteps.clear(),this.dicCalcSteps.clear()},e.prototype.parseReferenceSteps=function(){var e=this.dicCalcSteps;e.forEach((function(t){t.parseReferenceSteps(e)}))},e}();t.CalculationSchema=a;var o=function(){function e(e,t){if(this.sStepReference="-1",this.bHasReference=!1,this.bIsFreeItem=!1,this.bSkipSelectablePromotion=!1,this.listKeyTypes=new n.List,this.listReferenceSteps=new n.List,this.NeededColumns=i.SETTINGS.DIC_META_META_COLUMNS.getItem(e.CndCpMetaMetaId),this.sPosition=e.Position,this.sCndCpMetaPKey=e.CndCpMetaPKey,this.sCndCpMetaMetaId=e.CndCpMetaMetaId,this.bIsFreeItem="ADDFREEITM"===e.CndCpMetaMetaId.toUpperCase()||"MULTIBUY"===e.CndCpMetaMetaId.toUpperCase(),this.sCndCpMetaId=e.ConditionMetaId,this.CndCpMetaText=e.CndCpMetaText,Utils.isEmptyString(e.StepReference)||(this.sStepReference=e.StepReference,this.bHasReference=!0),this.sTargetAttributeCondition=e.TargetAttributeCondition,this.sTargetAttributeResult=e.TargetAttributeResult,this.bPrintRelevant="1"==e.PrintRelevant,this.sConstraintUserExitId=e.ConstraintUserExitId,this.sBaseUserExitId=e.BaseUserExitId,this.sCndCpSearchStrategyPKey=e.CndCpSearchStrategyPKey,this.sConditionLevel=e.ConditionLevel,this.bMandatory="1"==e.Mandatory,this.bManual="1"==e.Manual,this._manualSourceAttribute=e.ManualSourceAttribute,this.sRounding=e.Rounding,this.iDecimalPlaces=parseInt(e.DecimalPlaces,10),this.sUserExitId=e.UserExitId,this.iStartIndex=t,this.iEndIndex=this.NeededColumns-1+t,this.bSubTotal="1"==e.Subtotal,this.sCalculationGroups=e.CalculationGroups,this.sCalcVariable=e.CalcVariable,this.bStatistical="1"==e.Statistical,this.sScaleType=e.ScaleType,this.sBase=e.Base,this.bDistributeToItem="1"==e.DistributeToItem,this.bItemGrouping="1"==e.ItemGrouping,this.sCndCpItemMetaRulePKey=e.CndCpItemMetaRulePKey,this.Accrual="1"==e.Accrual,this.bPDARelevant="1"==e.PDARelevant,this.bIsHeaderCondition="OrderHeader"===this.sConditionLevel,this.bSkipSelectablePromotion="1"==e.SkipSelectablePromotion,this.dicAttributesForUserExit=new n.Dictionary,this.dicAttributesForUserExit.add("StepNumber",e.Position),this.dicAttributesForUserExit.add("ConditionMetaMetaId",e.CndCpMetaMetaId),this.dicAttributesForUserExit.add("ConditionLevel",e.ConditionLevel),this.dicAttributesForUserExit.add("Mandatory",e.Mandatory),this.dicAttributesForUserExit.add("Rounding",e.Rounding),this.dicAttributesForUserExit.add("DecimalPlaces",e.DecimalPlaces),this.dicAttributesForUserExit.add("TargetAttributeCondition",e.TargetAttributeCondition),this.dicAttributesForUserExit.add("TargetAttributeResult",e.TargetAttributeResult),this.dicAttributesForUserExit.add("CalculationGroups",e.CalculationGroups),!Utils.isEmptyString(this.sCalcVariable)&&0===this.sCalcVariable.indexOf("Copy"))switch(this.sCalcVariable){case"Copy1":this.sCalcVariable="CopyD";break;case"Copy2":this.sCalcVariable="CopyE";break;case"Copy3":this.sCalcVariable="CopyF";break;case"Copy4":this.sCalcVariable="CopyG";break;case"Copy5":this.sCalcVariable="CopyH";break;case"Copy6":this.sCalcVariable="CopyI"}Utils.isEmptyString(this.sScaleType)&&"MULTIBUY"!==this.sCndCpMetaMetaId.toUpperCase()||(this.bIsScale=!0,this.sBase=e.Base,this.sScaleType=e.ScaleType),"OrderHeader"===this.sConditionLevel&&(this.sBase=e.Base)}return e.prototype.isStepValidForGroup=function(e){return!!(Utils.isEmptyString(this.sCalculationGroups)||this.sCalculationGroups.indexOf(e.CalculationGroup)>-1)},e.prototype.isStepSkippedByPromotion=function(e){return this.bSkipSelectablePromotion&&e.HasSelectablePromotionReference},e.prototype.parseReferenceSteps=function(e){this.bHasReference&&(this.listReferenceSteps=n.parseReference(this.sStepReference,e))},Object.defineProperty(e.prototype,"StartIndex",{get:function(){return this.iStartIndex},set:function(e){this.iStartIndex=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"IsScale",{get:function(){return this.bIsScale},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"IsFreeItem",{get:function(){return this.bIsFreeItem},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ScaleType",{get:function(){return this.sScaleType},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"CndCpItemMetaRulePKey",{get:function(){return this.sCndCpItemMetaRulePKey},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"DistributeToItem",{get:function(){return this.bDistributeToItem},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ItemGrouping",{get:function(){return this.bItemGrouping},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Base",{get:function(){return this.sBase},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"EndIndex",{get:function(){return this.iEndIndex},set:function(e){this.iEndIndex=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"CndCpMetaId",{get:function(){return this.sCndCpMetaId},set:function(e){this.sCndCpMetaId=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"CndCpMetaText",{get:function(){return this.sCndCpMetaText},set:function(e){this.sCndCpMetaText=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"CndCpSearchStrategyPKey",{get:function(){return this.sCndCpSearchStrategyPKey},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"StepNumber",{get:function(){return this.sPosition},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"IsHeaderCondition",{get:function(){return this.bIsHeaderCondition},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"HasReference",{get:function(){return this.bHasReference},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"StepReference",{get:function(){return this.sStepReference},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"IsStatistical",{get:function(){return this.bStatistical},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"StepReferenceFrom",{get:function(){return this.iStepReferenceFrom},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"StepReferenceThru",{get:function(){return this.iStepReferenceThru},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"IsManual",{get:function(){return this.bManual},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"manualSourceAttribute",{get:function(){return this._manualSourceAttribute},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"TargetAttributeCondition",{get:function(){return this.sTargetAttributeCondition},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"TargetAttributeResult",{get:function(){return this.sTargetAttributeResult},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"CndCpMetaPKey",{get:function(){return this.sCndCpMetaPKey},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"KeyTypes",{get:function(){return this.listKeyTypes},set:function(e){this.listKeyTypes=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"IsSubtotal",{get:function(){return this.bSubTotal},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"CndCpMetaMetaId",{get:function(){return this.sCndCpMetaMetaId},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"IsMandatory",{get:function(){return this.bMandatory},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Rounding",{get:function(){return this.sRounding},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"DecimalPlaces",{get:function(){return this.iDecimalPlaces},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"IsPrintRelevant",{get:function(){return this.bPrintRelevant},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"UserExitId",{get:function(){return this.sUserExitId},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"UserExitConstraintId",{get:function(){return this.sConstraintUserExitId},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"BaseUserExitId",{get:function(){return this.sBaseUserExitId},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"AttributesForUserExit",{get:function(){return JSON.parse(JSON.stringify(this.dicAttributesForUserExit)).data},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"CalcVariable",{get:function(){return this.sCalcVariable},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"IsPDARelevant",{get:function(){return this.bPDARelevant},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ReferenceSteps",{get:function(){return this.listReferenceSteps},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"SkipSelectablePromotionItems",{get:function(){return this.bSkipSelectablePromotion},enumerable:!1,configurable:!0}),e}();t.CalculationStep=o;var s,c,u,l=function(){function e(e){this.KeyInfo=new Array,this.Position=parseInt(e.Position,10),this.KeyTypeId=e.KeyTypeId,this.CndCpKeyTypePKey=e.CndCpKeyTypePKey,this.ConsiderBpaMain="1"==e.ConsiderBpaMain||"1"==e.ConsiderBpaHierarchy,this.ConsiderBpaSet="1"==e.ConsiderBpaSet,this.ConsiderPrdMain="1"==e.ConsiderPrdMain||"1"==e.ConsiderPrdHierarchy,this.ConsiderPrdSet="1"==e.ConsiderPrdSet,this.ConsiderSalesOrg="1"==e.ConsiderSalesOrg,this.ConsiderDistribChannel="1"==e.ConsiderDistribChannel,this.ConsiderDivision="1"==e.ConsiderDivision,this.ConsiderPromotion="1"==e.ConsiderPromotion,this.ConsiderReward="1"==e.ConsiderReward,this.BpaHierarchySearch=this.getBpaHierarchy(e.BpaHierarchySearch),this.PrdHierarchySearch=this.getPrdHierachy(e.PrdHierarchySearch),this.Exclusive="1"==e.StepExclusive,this.ConstraintUserExitId=e.ConstraintUserExitId,this.CustomerRole=this.getCustomerRole(e.CustomerRole),this.KeyInfo=new Array,this.KeyInfo.push({entity:e.Key1MobilityEntity,attribute:e.Key1MobilityAttribute}),this.KeyInfo.push({entity:e.Key2MobilityEntity,attribute:e.Key2MobilityAttribute}),this.KeyInfo.push({entity:e.Key3MobilityEntity,attribute:e.Key3MobilityAttribute}),this.KeyInfo.push({entity:e.Key4MobilityEntity,attribute:e.Key4MobilityAttribute}),this.KeyInfo.push({entity:e.Key5MobilityEntity,attribute:e.Key5MobilityAttribute}),this.KeyInfo.push({entity:e.Key6MobilityEntity,attribute:e.Key6MobilityAttribute}),this.KeyInfo.push({entity:e.Key7MobilityEntity,attribute:e.Key7MobilityAttribute}),this.KeyInfo.push({entity:e.Key8MobilityEntity,attribute:e.Key8MobilityAttribute}),this.KeyInfo.push({entity:e.Key9MobilityEntity,attribute:e.Key9MobilityAttribute}),this.KeyInfo.push({entity:e.Key10MobilityEntity,attribute:e.Key10MobilityAttribute})}return e.prototype.getBpaHierarchy=function(e){switch(e){case"Complete":return s.ALL;case"CustLevel1":return s.LEVEL1;case"CustLevel2":return s.LEVEL2;case"CustLevel3":return s.LEVEL3;case"CustLevel4":return s.LEVEL4;case"CustLevel5":return s.LEVEL5;case"CustLevel6":return s.LEVEL6;case"CustLevel7":return s.LEVEL7;default:return s.NONE}},e.prototype.getCustomerRole=function(e){switch(e){case"":case" ":return c.No;case"DeliveryRecipient":return c.Deliv;case"Payer":return c.Payer;case"BillTo":return c.BillTo;default:return c.Orderer}},e.prototype.getPrdHierachy=function(e){switch(e){case"Complete":return u.ALL;case"ProdLevel1":return u.LEVEL1;case"ProdLevel2":return u.LEVEL2;case"ProdLevel3":return u.LEVEL3;case"ProdLevel4":return u.LEVEL4;case"ProdLevel5":return u.LEVEL5;default:return u.NONE}},e}();t.KeyType=l,function(e){e[e.NONE=0]="NONE",e[e.LEVEL1=1]="LEVEL1",e[e.LEVEL2=2]="LEVEL2",e[e.LEVEL3=3]="LEVEL3",e[e.LEVEL4=4]="LEVEL4",e[e.LEVEL5=5]="LEVEL5",e[e.LEVEL6=6]="LEVEL6",e[e.LEVEL7=7]="LEVEL7",e[e.ALL=8]="ALL"}(s=t.BpaHierachy||(t.BpaHierachy={})),function(e){e[e.No=0]="No",e[e.Orderer=1]="Orderer",e[e.Deliv=2]="Deliv",e[e.Payer=3]="Payer",e[e.BillTo=4]="BillTo"}(c=t.CustomerRole||(t.CustomerRole={})),function(e){e[e.NONE=0]="NONE",e[e.ALL=1]="ALL",e[e.LEVEL1=2]="LEVEL1",e[e.LEVEL2=3]="LEVEL2",e[e.LEVEL3=4]="LEVEL3",e[e.LEVEL4=5]="LEVEL4",e[e.LEVEL5=6]="LEVEL5"}(u=t.PrdHierachy||(t.PrdHierachy={}))},426:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.HeaderBucketCollection=t.HeaderBucket=void 0;var n=r(346),i=function(){function e(e){this.RulePKey=e,this.mValidSdoItemMetas=new n.Dictionary,this.weight=0,this.quantity=0,this.volume=0,this.amount=0}return e.prototype.reset=function(){this.weight=0,this.quantity=0,this.volume=0,this.amount=0},e.prototype.addSdoItemMeta=function(e,t){this.mValidSdoItemMetas.contains(e)||this.mValidSdoItemMetas.add(e,t)},e.prototype.addProduct=function(e,t,r,n){this.mValidSdoItemMetas.contains(e)&&(this.quantity=this.quantity+t*this.mValidSdoItemMetas.getItem(e),this.weight=this.weight+r*this.mValidSdoItemMetas.getItem(e),this.volume=this.volume+n*this.mValidSdoItemMetas.getItem(e))},e.prototype.updateProduct=function(e,t,r,n,i,a,o){this.mValidSdoItemMetas.contains(e)&&(this.quantity=this.quantity-r*this.mValidSdoItemMetas.getItem(e),this.weight=this.weight-i*this.mValidSdoItemMetas.getItem(e),this.volume=this.volume-o*this.mValidSdoItemMetas.getItem(e),this.quantity=this.quantity+t*this.mValidSdoItemMetas.getItem(e),this.weight=this.weight+n*this.mValidSdoItemMetas.getItem(e),this.volume=this.volume+a*this.mValidSdoItemMetas.getItem(e))},e.prototype.updateProductAmount=function(e,t,r){this.mValidSdoItemMetas.contains(e)&&(this.amount=this.amount-r*this.mValidSdoItemMetas.getItem(e),this.amount=this.amount+t*this.mValidSdoItemMetas.getItem(e))},e.prototype.getEffect=function(e){return Utils.isDefined(e)&&this.mValidSdoItemMetas.contains(e)?this.mValidSdoItemMetas.getItem(e):0},Object.defineProperty(e.prototype,"Weight",{get:function(){return this.weight},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Quantity",{get:function(){return this.quantity},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Volume",{get:function(){return this.volume},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Amount",{get:function(){return this.amount},enumerable:!1,configurable:!0}),e}();t.HeaderBucket=i;var a="ALL",o="NOT_SELECTABLE",s=function(){function e(e){void 0===e&&(e=new n.Dictionary),this.buckets=new n.Dictionary,this.buckets.add(a,new n.Dictionary),this.buckets.add(o,new n.Dictionary);for(var t=this.buckets.keyValuePairs,r=0;r<t.length;r++)for(var s=t[r].value,c=e.keyValuePairs,u=0;u<c.length;u++){var l=c[u];s.contains(l.key)||s.add(l.key,new i(l.key));for(var d=l.value.keyValuePairs,p=0;p<d.length;p++){var h=d[p];"+"===h.value&&s.getItem(l.key).addSdoItemMeta(h.key,1),"-"===h.value&&s.getItem(l.key).addSdoItemMeta(h.key,-1)}}}return e.prototype.getHeaderBucketGroup=function(e){return this.buckets.getItem(e?o:a)},e.prototype.getHeaderBucketGroupsRelevantForOrderItem=function(e){return e.HasSelectablePromotionReference?[this.buckets.getItem(a)]:this.buckets.keyValuePairs.map((function(e){return e.value}))},e.prototype.getItem=function(e,t){return void 0===t&&(t=!1),this.getHeaderBucketGroup(t).getItem(e)},e.prototype.contains=function(e,t){return void 0===t&&(t=!1),this.getHeaderBucketGroup(t).contains(e)},e.prototype.initializeQuantities=function(e){var t=this.getHeaderBucketGroupsRelevantForOrderItem(e),r=function(t){t.addProduct(e.sSdoItemMetaPKey,e.Qty,0,0)};t.forEach((function(e){e.forEach(r)}))},e.prototype.resetAllBuckets=function(){for(var e=this.buckets.keyValuePairs,t=0;t<e.length;t++)for(var r=e[t].value.keyValuePairs,n=0;n<r.length;n++)r[n].value.reset()},e.prototype.updateBuckets=function(e){var t=this.getHeaderBucketGroupsRelevantForOrderItem(e),r=function(t){t.addProduct(e.sSdoItemMetaPKey,e.Qty,e.Weight,e.Volume)};t.forEach((function(e){e.forEach(r)}))},e.prototype.updateQuantities=function(e,t){var r=this.getHeaderBucketGroupsRelevantForOrderItem(e),n=function(r){r.updateProduct(e.sSdoItemMetaPKey,t,e.Qty,0,0,0,0)};r.forEach((function(e){e.forEach(n)}))},e.prototype.updateOldQuantities=function(e,t){this.updateQuantities(e,t.Qty)},e.prototype.updateWeightAndVolume=function(e,t,r){var n=this.getHeaderBucketGroupsRelevantForOrderItem(e),i=function(n){n.updateProduct(e.sSdoItemMetaPKey,0,0,e.Weight,t,e.Volume,r)};n.forEach((function(e){e.forEach(i)}))},e.prototype.updateAmounts=function(e,t){var r=this.getHeaderBucketGroupsRelevantForOrderItem(e),n=function(r){r.updateProductAmount(e.sSdoItemMetaPKey,e.TotalWithoutPriceEffect,t)};r.forEach((function(e){e.forEach(n)}))},e.prototype.getQuantity=function(e,t){var r=0,n=this.getHeaderBucketGroup(t);return n.contains(e)&&(r=n.getItem(e).Quantity),r},e.prototype.getWeight=function(e,t){var r=0,n=this.getHeaderBucketGroup(t);return n.contains(e)&&(r=n.getItem(e).Weight),r},e.prototype.getVolume=function(e,t){var r=0,n=this.getHeaderBucketGroup(t);return n.contains(e)&&(r=n.getItem(e).Volume),r},e.prototype.getAmount=function(e,t){var r=0,n=this.getHeaderBucketGroup(t);return n.contains(e)&&(r=n.getItem(e).Amount),r},e.prototype.getPriceEffect=function(e,t){var r=0,n=this.buckets.getItem(a);return n.contains(e)&&(r=n.getItem(e).getEffect(t)),r},e}();t.HeaderBucketCollection=s},366:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ItemGroupBucket=void 0;var n=r(346),i=function(){function e(e){this.mItems=new n.List,this.mWeight=0,this.mVolume=0,this.mValue=0,this.mCondition=e}return e.prototype.addItem=function(e,t){switch(t){case-9999:t=e.nPriceEffect;break;case 0:return}this.mItems.add(e),this.mWeight=this.mWeight+e.Weight*t,this.mVolume=this.mVolume+e.Volume*t},Object.defineProperty(e.prototype,"Weight",{get:function(){return this.mWeight},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Volume",{get:function(){return this.mVolume},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Value",{get:function(){return this.mValue},set:function(e){this.mValue=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Condition",{get:function(){return this.mCondition},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Items",{get:function(){return this.mItems},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ItemNames",{get:function(){var e=[];for(var t in this.mItems.toArray()){var r=this.mItems.toArray()[t];e.push(r.sPrdText)}return e},enumerable:!1,configurable:!0}),e}();t.ItemGroupBucket=i},547:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.OrderItem=t.Order=void 0;var n=r(346),i=r(121),a=r(981),o=r(951),s=r(237),c=r(722),u=r(744),l=function(){function e(e,t,r,i,o,s){this.conversionFactor=1,this.conversionFactorAmount=1,this.isInvertedCurrencyConversion=!1,this.dicAttributes=new n.Dictionary,this.dicItems=new n.Dictionary,this.merchandiseValueReceipt=0,this.totalValueReceipt=0,this.dicCustomerAttributes=new n.Dictionary,this.dicAttributes.add("OrdererBpaMainPKey",t),this.dicAttributes.add("SdoMetaPKey",r),this.dicAttributes.add("PricingDate",i),o.length<3&&(o="USD"),this.dicAttributes.add("Currency",o),this.sReceiptCurrency=o,this.isCalculated=!1,this.sOrderMainPKey=e,this.calculationSchemaPKey=s,this.pricingDate=i,this.lItems=new n.List,this.filteredItems=new n.List,this.lPromotions=new n.List,this.dMergedKeyCache=new n.Dictionary,this.rewardCache=new a.RewardCache,this.dicAttributes.add("PricingInfo1",0),this.dicAttributes.add("PricingInfo2",0),this.dicAttributes.add("PricingInfo3",0),this.dicAttributes.add("PricingInfo4",0),this.dicAttributes.add("PricingInfo5",0),this.dicAttributes.add("PricingInfo6",0),this.dicAttributes.add("PricingInfo7",0),this.dicAttributes.add("PricingInfo8",0),this.dicAttributes.add("PricingInfo9",0),this.dicAttributes.add("PricingInfo10",0)}return e.prototype.initRewardCache=function(e,t){return this.rewardCache.init(e,t)},e.prototype.getRewardCache=function(){return this.rewardCache.RewardCache},e.prototype.getSelectedRewards=function(e){return null!==e?this.rewardCache.getSelectedRewards().filter((function(t){return t.promotionPKey==e})):this.rewardCache.getSelectedRewards()},e.prototype.setRewardCache=function(e){this.rewardCache.RewardCache=e},e.prototype.updateRewardCache=function(e,t,r){this.rewardCache.updateRewardCache(e,t,r)},e.prototype.getItem=function(e){return this.dicItems.contains(e)?this.dicItems.getItem(e):null},e.prototype.getAttribute=function(e){return this.dicAttributes.contains(e)?this.dicAttributes.getItem(e).toString():" "},e.prototype.setVariantVariables=function(e){this.dicAttributes.add("VariantMainString1",e.VariantString1),this.dicAttributes.add("VariantMainString2",e.VariantString2),this.dicAttributes.add("VariantMainString3",e.VariantString3),this.dicAttributes.add("VariantMainString4",e.VariantString4),this.dicAttributes.add("VariantMainString5",e.VariantString5),this.dicAttributes.add("VariantMainDecimal1",e.VariantDecimal1),this.dicAttributes.add("VariantMainDecimal2",e.VariantDecimal2),this.dicAttributes.add("VariantMainDecimal3",e.VariantDecimal3),this.dicAttributes.add("VariantMainDecimal4",e.VariantDecimal4),this.dicAttributes.add("VariantMainDecimal5",e.VariantDecimal5)},e.prototype.addItemInternally=function(e,t,r){this.dicItems.add(e.pKey,new d(e.pKey,e.sdoItemMetaPKey,e.quantity,e.prdMainPKey,e.quantityLogisticUnit,e.type,e.prdId,e.text1,e.calculationGroup,parseInt(e.priceEffect,10),e.discount,e.specialPriceReceipt,e.promotionPKey,e.pricingInfo1,e.pricingInfo2,e.pricingInfo3,e.pricingInfo4,e.pricingInfo5,e.pricingInfo6,e.pricingInfo7,e.pricingInfo8,e.pricingInfo9,e.pricingInfo10,t,r)),this.lItems.add(e.pKey),u.CalcMatrix.getInstance().HeaderBuckets.initializeQuantities(this.dicItems.getItem(e.pKey))},e.prototype.addOrderItems=function(e){for(var t,r=null,a=0;a<e.length;a++){for(var o in r=e[a],t=new n.Dictionary,r)r.hasOwnProperty(o)&&("object"==typeof r[o]?t.add(o.toString(),r[o]):r[o]&&Utils.isDefined(r[o].data)?Utils.isDefined(r[o])&&t.add(o.toString(),r[o].toString()):t.add(o.toString(),r[o]&&r[o].toString()));this.lItems.contains(r.pKey)||this.addItemInternally(r,t,!1),s.SETTINGS.LOG_ENABLED&&i.LogHandler.getInstance().message("Product: '"+r.text1+"' ("+r.prdMainPKey+") added. Quantity: "+r.quantity)}},e.prototype.addOrderItem=function(e){var t=new n.Dictionary;for(var r in e)e.hasOwnProperty(r)&&(e[r]&&Utils.isDefined(e[r].data)?Utils.isDefined(e[r])&&t.add(r.toString(),e[r].toString()):t.add(r.toString(),e[r]&&e[r].toString()));this.addItemInternally(e,t,!1),s.SETTINGS.LOG_ENABLED&&i.LogHandler.getInstance().message("Product: '"+e.text1+"' ("+e.prdMainPKey+") added. Quantity: "+e.quantity)},e.prototype.hasNoOrderItems=function(){var e=!0;return this.dicItems.forEach((function(t){t.Qty>0&&(e=!1)})),e},e.prototype.setCustomerAttributes=function(e){for(var t in this.dicCustomerAttributes.clear(),e)this.dicCustomerAttributes.add(t.toString(),e[t].toString())},e.prototype.getCustomerAttribute=function(e){return this.dicCustomerAttributes.contains(e)?this.dicCustomerAttributes.getItem(e):" "},e.prototype.getMergedKeyList=function(e,t,r){return this.dMergedKeyCache.contains(e+t+r)?this.dMergedKeyCache.getItem(e+t+r).MergedKeys:new n.List},e.prototype.addMergedKey=function(e,t,r,n,i,a){var o={};o.CndCpMetaPKey=n,o.KeyTypePKey=i,o.MergedKeys=a,this.dMergedKeyCache.contains(e+t+r)||this.dMergedKeyCache.add(e+t+r,o)},e.prototype.readUnitConversionFactors=function(){for(var e=[],t=[],r=0;this.lItems.length>r;r++){var n=this.getItem(this.lItems.toArray()[r]).PrdMainPKey,i=this.getItem(this.lItems.toArray()[r]).UoM;c.API.getInstance().CACHE_UnitFactorCache.containsFactor(n,i)||(t.push(this.lItems.toArray()[r]),e.push(c.API.getInstance().readUnitConversionFactors(n,i)))}return when.all(e).then((function(){for(var e=0;e<t.length;e++)u.CalcMatrix.getInstance().currentOrder.getItem(t[e]).updateWeightAndVolume()}))},Object.defineProperty(e.prototype,"Attributes",{get:function(){return this.dicAttributes},set:function(e){this.dicAttributes=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Items",{get:function(){return this.dicItems},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"PricingDate",{get:function(){return this.pricingDate},set:function(e){this.pricingDate=e,this.dicAttributes.update("PricingDate",e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"MerchandiseValueReceipt",{get:function(){return this.merchandiseValueReceipt},set:function(e){this.merchandiseValueReceipt=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"TotalValueReceipt",{get:function(){return this.totalValueReceipt},set:function(e){this.totalValueReceipt=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ReceiptCurrency",{get:function(){return this.sReceiptCurrency},set:function(e){this.sReceiptCurrency=e,this.dicAttributes.update("Currency",e)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"MergedKeyCache",{get:function(){return this.dMergedKeyCache},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ItemFilterCallback",{get:function(){return this.itemFilterCallback},set:function(e){null!=e?(this.itemFilterCallback=e,this.createCurrentItemList(),this.refillHeaderBuckets()):(this.filteredItems=this.lItems,this.refillHeaderBuckets())},enumerable:!1,configurable:!0}),e.prototype.setOrderDirty=function(){this.isCalculated=!1,this.dTotalValue=0,this.dGrossValue=0,this.dMerchandiseValue=0;for(var e=0;e<this.lItems.toArray().length;e++)this.getItem(this.lItems.toArray()[e]).setDirty(!1,!0);u.CalcMatrix.getInstance().getConditionsSummedUpForCache()},e.prototype.getOrderAsJSON=function(){return JSON.stringify(this)},e.prototype.createCurrentItemList=function(){var e=new n.List,t=this.itemFilterCallback;this.Items.forEach((function(r){(null==t||t(r))&&e.add(r.SdoItemPKey)})),this.filteredItems=e},e.prototype.refillHeaderBuckets=function(){var e=this;u.CalcMatrix.getInstance().HeaderBuckets.resetAllBuckets();for(var t=0;t<e.filteredItems.toArray().length;t++){var r=e.getItem(e.filteredItems.toArray()[t]);u.CalcMatrix.getInstance().HeaderBuckets.updateBuckets(r)}},e.prototype.setProductsInitialized=function(e){for(var t=this,r=0;t.lItems.length>r;r++){var n=t.getItem(t.lItems.getItem(r)).PrdMainPKey;e.indexOf(n)>=0&&(t.getItem(t.lItems.getItem(r)).bInitialized=!0)}},e}();t.Order=l;var d=function(){function e(e,t,r,i,a,s,c,u,l,d,p,h,g,C,f,I,S,m,y,b,P,E,T,O,L){void 0===L&&(L=!1),this.dicAttributes=new n.Dictionary,this.dTotal=0,this.dTotalWithoutPriceEffect=0,this.dTotalLastCalcStep=0,this.dTotalLastCalcStepWithoutPriceEffect=0,this.dLastTotal=0,this.dVolume=0,this.dWeight=0,this.dV1=0,this.dV2=0,this.dV3=0,this.dV4=0,this.dV5=0,this.dV6=0,this.currentCalcStepDebugData=null,this.conditionFoundInGrouping=!1,this.SdoConditions=[],this.bInitialized=!1,this.dicConditionSearchLogging=new n.List,this.pricingInfo1=0,this.pricingInfo2=0,this.pricingInfo3=0,this.pricingInfo4=0,this.pricingInfo5=0,this.pricingInfo6=0,this.pricingInfo7=0,this.pricingInfo8=0,this.pricingInfo9=0,this.pricingInfo10=0,this.additionalPricingInfo={},this.sSdoItemPkey=e,this.Qty=r,this.sUoM=a,this.sSdoItemMetaPKey=t,this.sPrdMainPKey=i,this.sSdoItemMetaId=s,this.sPrdId=c,this.sPrdText=u,this.sCalculationGroup=l,this.nPriceEffect=d,this.dDiscount=p,this.dSpecialPrice=h,this.sPromotionPKey=g,this.hasSelectablePromotionReference=!Utils.isEmptyString(g),this.dicAttributes=O,this.bDirty=!0,this.bInitialized=L,this.dMergedKeyCache=new n.Dictionary,this.updateQuantity(r,a),this.dicAttributes.add("CarryOver1",0),this.dicAttributes.add("CarryOver2",0),this.dicAttributes.add("CarryOver3",0),this.dicAttributes.add("CarryOver4",0),this.dicAttributes.add("CarryOver5",0),this.dicAttributes.add("CarryOver6",0),this.dicAttributes.add("CopyD",0),this.dicAttributes.add("CopyE",0),this.dicAttributes.add("CopyF",0),this.dicAttributes.add("CopyG",0),this.dicAttributes.add("CopyH",0),this.dicAttributes.add("CopyI",0),this.pricingInfo1=C,this.pricingInfo2=f,this.pricingInfo3=I,this.pricingInfo4=S,this.pricingInfo5=m,this.pricingInfo6=y,this.pricingInfo7=b,this.pricingInfo8=P,this.pricingInfo9=E,this.pricingInfo10=T,this.additionalPricingInfo=this.setAdditionalPricingInfo(this),this.DebugData=o.DebugData.DebugDataFactory.createItemDebugDataInstance(e,i,t,c,u,a,r,h,p,0,s,0,0,0,0,this.dicAttributes)}return e.prototype.setVariantVariables=function(e){this.dicAttributes.add("VariantMainString1",e.VariantItemString1),this.dicAttributes.add("VariantMainString2",e.VariantItemString2),this.dicAttributes.add("VariantMainString3",e.VariantItemString3),this.dicAttributes.add("VariantMainString4",e.VariantItemString4),this.dicAttributes.add("VariantMainString5",e.VariantItemString5),this.dicAttributes.add("VariantMainDecimal1",e.VariantItemDecimal1),this.dicAttributes.add("VariantMainDecimal2",e.VariantItemDecimal2),this.dicAttributes.add("VariantMainDecimal3",e.VariantItemDecimal3),this.dicAttributes.add("VariantMainDecimal4",e.VariantItemDecimal4),this.dicAttributes.add("VariantMainDecimal5",e.VariantItemDecimal5),this.DebugData.addVariantAttributesToJSON(this)},e.prototype.getAttribute=function(e){return this.dicAttributes.contains(e)?this.dicAttributes.getItem(e):this.dicAttributes.contains(e.charAt(0).toLowerCase()+e.slice(1))?this.dicAttributes.getItem(e.charAt(0).toLowerCase()+e.slice(1)):" "},e.prototype.setDirty=function(e,t){void 0===e&&(e=!1),void 0===t&&(t=!1),this.Total=0,this.dicAttributes.update("CarryOver1",0),this.dicAttributes.update("CarryOver2",0),this.dicAttributes.update("CarryOver3",0),this.dicAttributes.update("CarryOver4",0),this.dicAttributes.update("CarryOver5",0),this.dicAttributes.update("CarryOver6",0),this.dicAttributes.update("CopyD",0),this.dicAttributes.update("CopyE",0),this.dicAttributes.update("CopyF",0),this.dicAttributes.update("CopyG",0),this.dicAttributes.update("CopyH",0),this.dicAttributes.update("CopyI",0),this.dV1=0,this.dV2=0,this.dV3=0,this.dV4=0,this.dV5=0,this.dV6=0,u.CalcMatrix.getInstance().resetCalcMatrixForProduct(this.SdoItemPKey),this.SdoConditions=[],this.bDirty=!0,this.dBasePrice=0,this.dPriceReceipt=0,this.dValueReceipt=0,this.dBasePriceReceipt=0,this.dGrossValueReceipt=0,this.dTotalWithoutPriceEffect=0,this.DebugData=o.DebugData.DebugDataFactory.createItemDebugDataInstance(this.SdoItemPKey,this.PrdMainPKey,this.sSdoItemMetaPKey,this.sPrdId,this.sPrdText,this.sUoM,this.iQuantity,this.dSpecialPrice,this.dDiscount,0,this.sSdoItemMetaId,0,0,0,0,this.dicAttributes),this.DebugData.addVariantAttributesToJSON(this),(e||t)&&(this.dMergedKeyCache=new n.Dictionary,e&&u.CalcMatrix.getInstance().getConditionsSummedUpForCache()),this.updateWeightAndVolume()},e.prototype.updateQuantity=function(e,t){var r=this;return u.CalcMatrix.getInstance().HeaderBuckets.updateQuantities(r,e),this.dicAttributes.add("quantity",e),this.dicAttributes.add("quantityLogisticUnit",t),this.iQuantity!==e&&(this.iQuantity=e,r.setDirty(!1)),t!==r.UoM?this.updateUoM(t).then((function(){r.DebugData.setQtyUoM(e,t),r.setDirty(!0)})):when.resolve(void 0)},e.prototype.updateUoM=function(e){return this.dicAttributes.add("quantityLogisticUnit",e),this.sUoM!==e&&(this.sUoM=e),c.API.getInstance().CACHE_UnitFactorCache.containsFactor(this.PrdMainPKey,e)?when.resolve(void 0):c.API.getInstance().readUnitConversionFactors(this.PrdMainPKey,e)},e.prototype.updateWeightAndVolume=function(){if(c.API.getInstance().CACHE_UnitFactorCache.containsFactor(this.PrdMainPKey,this.sUoM)){var e=this.dWeight,t=this.dVolume;this.dWeight=c.API.getInstance().CACHE_UnitFactorCache.getWeight(this.PrdMainPKey,this.sUoM)*this.iQuantity,this.dVolume=c.API.getInstance().CACHE_UnitFactorCache.getVolume(this.PrdMainPKey,this.sUoM)*this.iQuantity,u.CalcMatrix.getInstance().HeaderBuckets.updateWeightAndVolume(this,e,t)}},e.prototype.updateSpecialPrice=function(e){this.SplPrice=e,this.DebugData.pSplPrice=e,this.setDirty()},e.prototype.updateDiscount=function(e){this.Discount=e,this.DebugData.pDiscount=e,this.setDirty()},e.prototype.updateItemTemplate=function(e){this.dicAttributes.add("sdoItemMetaPKey",e.sdoItemMetaPKey),u.CalcMatrix.getInstance().HeaderBuckets.updateOldQuantities(e,this),this.nPriceEffect=parseInt(e.priceEffect,10),this.sSdoItemMetaPKey=e.sdoItemMetaPKey,this.sCalculationGroup=e.calculationGroup,this.sSdoItemMetaId=e.type,this.DebugData.pSdoItemMetaPKey=e.sdoItemMetaPKey,this.setDirty(!0)},e.prototype.updatePricingInfo1=function(e){this.pricingInfo1=e,this.setDirty()},e.prototype.updatePricingInfo2=function(e){this.pricingInfo2=e,this.setDirty()},e.prototype.updatePricingInfo3=function(e){this.pricingInfo3=e,this.setDirty()},e.prototype.updatePricingInfo4=function(e){this.pricingInfo4=e,this.setDirty()},e.prototype.updatePricingInfo5=function(e){this.pricingInfo5=e,this.setDirty()},e.prototype.updatePricingInfo6=function(e){this.pricingInfo6=e,this.setDirty()},e.prototype.updatePricingInfo7=function(e){this.pricingInfo7=e,this.setDirty()},e.prototype.updatePricingInfo8=function(e){this.pricingInfo8=e,this.setDirty()},e.prototype.updatePricingInfo9=function(e){this.pricingInfo9=e,this.setDirty()},e.prototype.updatePricingInfo10=function(e){this.pricingInfo10=e,this.setDirty()},e.prototype.updateAdditionalPricingInfoAttribute=function(e,t){this.additionalPricingInfo[e]=t},e.prototype.updateAdditionalPricingInfo=function(e){this.additionalPricingInfo=e,this.setDirty()},e.prototype.getAttributesForUserExit=function(){return JSON.parse(JSON.stringify(this.dicAttributes)).data},e.prototype.getMergedKeyList=function(e,t,r){return this.dMergedKeyCache.contains(e+t+r)?this.dMergedKeyCache.getItem(e+t+r).MergedKeys:new n.List},e.prototype.addMergedKey=function(e,t,r,n,i,a){var o={};o.CndCpMetaPKey=n,o.KeyTypePKey=i,o.MergedKeys=a,this.dMergedKeyCache.contains(e+t+r)||this.dMergedKeyCache.add(e+t+r,o)},e.prototype.setAttribute=function(e,t){this.dicAttributes.contains(e)?this.dicAttributes.update(e,t):this.dicAttributes.add(e,t)},e.prototype.updateTotalWithPriceEffect=function(e){this.TotalLastCalcStep=this.Total,this.TotalLastCalcStepWithoutPriceEffect=this.TotalWithoutPriceEffect;var t=this.TotalWithoutPriceEffect;this.TotalWithoutPriceEffect=e,this.Total=e*this.nPriceEffect,u.CalcMatrix.getInstance().HeaderBuckets.updateAmounts(this,t)},Object.defineProperty(e.prototype,"Total",{get:function(){return this.dTotal},set:function(e){this.dTotal=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"TotalWithoutPriceEffect",{get:function(){return this.dTotalWithoutPriceEffect},set:function(e){this.dTotalWithoutPriceEffect=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"TotalLastCalcStep",{get:function(){return this.dTotalLastCalcStep},set:function(e){this.dTotalLastCalcStep=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"TotalLastCalcStepWithoutPriceEffect",{get:function(){return this.dTotalLastCalcStepWithoutPriceEffect},set:function(e){this.dTotalLastCalcStepWithoutPriceEffect=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"IsDirty",{get:function(){return this.bDirty},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"UoM",{get:function(){return this.sUoM},set:function(e){this.sUoM=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Qty",{get:function(){return this.iQuantity},set:function(e){this.iQuantity=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"SplPrice",{get:function(){return this.dSpecialPrice},set:function(e){this.dSpecialPrice=e,this.setDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Discount",{get:function(){return this.dDiscount},set:function(e){this.dDiscount=e,this.setDirty()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"LastTotal",{get:function(){return this.dLastTotal},set:function(e){this.dLastTotal=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"SdoItemPKey",{get:function(){return this.sSdoItemPkey},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ProductKey",{get:function(){return this.sPrdMainPKey},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"BasePrice",{get:function(){return this.dBasePrice},set:function(e){this.dBasePrice=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"PriceReceipt",{get:function(){return this.dPriceReceipt},set:function(e){this.dPriceReceipt=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ValueReceipt",{get:function(){return this.dValueReceipt},set:function(e){this.dValueReceipt=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"BasePriceReceipt",{get:function(){return this.dBasePriceReceipt},set:function(e){this.dBasePriceReceipt=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"GrossValueReceipt",{get:function(){return this.dGrossValueReceipt},set:function(e){this.dGrossValueReceipt=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"PrdMainPKey",{get:function(){return this.sPrdMainPKey},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Weight",{get:function(){return this.dWeight},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Volume",{get:function(){return this.dVolume},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"MergedKeyCache",{get:function(){return this.dMergedKeyCache},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"CalculationGroup",{get:function(){return this.sCalculationGroup},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"PromotionPKey",{get:function(){return this.sPromotionPKey},set:function(e){this.sPromotionPKey=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"HasSelectablePromotionReference",{get:function(){return this.hasSelectablePromotionReference},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Dirty",{set:function(e){this.bDirty=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"PricingInfo1",{get:function(){return this.pricingInfo1},set:function(e){this.pricingInfo1=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"PricingInfo2",{get:function(){return this.pricingInfo2},set:function(e){this.pricingInfo2=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"PricingInfo3",{get:function(){return this.pricingInfo3},set:function(e){this.pricingInfo3=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"PricingInfo4",{get:function(){return this.pricingInfo4},set:function(e){this.pricingInfo4=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"PricingInfo5",{get:function(){return this.pricingInfo5},set:function(e){this.pricingInfo5=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"PricingInfo6",{get:function(){return this.pricingInfo6},set:function(e){this.pricingInfo6=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"PricingInfo7",{get:function(){return this.pricingInfo7},set:function(e){this.pricingInfo7=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"PricingInfo8",{get:function(){return this.pricingInfo8},set:function(e){this.pricingInfo8=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"PricingInfo9",{get:function(){return this.pricingInfo9},set:function(e){this.pricingInfo9=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"PricingInfo10",{get:function(){return this.pricingInfo10},set:function(e){this.pricingInfo10=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"AdditionalPricingInfo",{get:function(){return this.additionalPricingInfo},enumerable:!1,configurable:!0}),e.prototype.setAdditionalPricingInfo=function(e){var t={},r=this.getAttribute(s.SETTINGS.ADDITIONAL_PRICING_INFO_ATTRIBUTE);return Utils.isDefined(r)&&!Utils.isEmptyString(r)&&(t=r,this.dicAttributes.remove(s.SETTINGS.ADDITIONAL_PRICING_INFO_ATTRIBUTE)),t},e.prototype.getAdditionalPricingInfoAttribute=function(e){var t=this.additionalPricingInfo[e];return Utils.isDefined(t)&&!Utils.isEmptyString(t)?parseFloat(t):null},e.prototype.getVAttributesForUserExit=function(){return{V1:this.V1,V2:this.V2,V3:this.V3,V4:this.V4,V5:this.V5,V6:this.V6}},e.prototype.setVariantAttributesAfterUserExit=function(e){e&&e.V1&&(this.V1=e.V1),e&&e.V2&&(this.V2=e.V2),e&&e.V3&&(this.V3=e.V3),e&&e.V4&&(this.V4=e.V4),e&&e.V5&&(this.V5=e.V5),e&&e.V6&&(this.V6=e.V6)},Object.defineProperty(e.prototype,"V1",{get:function(){return this.dV1},set:function(e){this.dV1=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"V2",{get:function(){return this.dV2},set:function(e){this.dV2=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"V3",{get:function(){return this.dV3},set:function(e){this.dV3=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"V4",{get:function(){return this.dV4},set:function(e){this.dV4=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"V5",{get:function(){return this.dV5},set:function(e){this.dV5=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"V6",{get:function(){return this.dV6},set:function(e){this.dV6=e},enumerable:!1,configurable:!0}),e}();t.OrderItem=d},852:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Reward=void 0;var r=function(){function e(e,t,r){this._rewardPKey=e,this._promotionPKey=t,this._selected=r}return Object.defineProperty(e.prototype,"rewardPKey",{get:function(){return this._rewardPKey},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"promotionPKey",{get:function(){return this._promotionPKey},enumerable:!1,configurable:!0}),e.prototype.setRewardSelected=function(e){this._selected=e},e.prototype.isRewardSelected=function(){return this._selected},e}();t.Reward=r},981:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.RewardCache=void 0;var n=r(346),i=r(852),a=r(744),o=r(722),s=function(){function e(){this.rewardCache=new n.Dictionary}return Object.defineProperty(e.prototype,"RewardCache",{get:function(){return this.rewardCache},set:function(e){this.rewardCache=e},enumerable:!1,configurable:!0}),e.prototype.init=function(e,t){var r,s,c,u,l,d=new n.Dictionary;return o.API.getInstance().readRelevantPromotionRewards(e,t).then((function(e){for(var t=0;t<e.length;t++)r=e[t].cndCpMetaPKey,s=e[t].promotionPKey,c=e[t].rewardPKey,u=new i.Reward(c,s,!1),d.contains(r)?((l=d.getItem(r)).push(u),d.update(r,l)):d.add(r,[u]);a.CalcMatrix.getInstance().currentOrder.setRewardCache(d)}))},e.prototype.getSelectedRewards=function(){for(var e=new Array,t=this.rewardCache.getSortedKeys(),r=new Array,n=0;n<t.length;n++){r=this.rewardCache.getItem(t[n]);for(var i=0;i<r.length;i++)r[i].isRewardSelected()&&e.push(r[i])}return e},e.prototype.updateRewardCache=function(e,t,r){var n=this.rewardCache.getItem(e);if(Utils.isDefined(n))for(var i=0;i<n.length;i++)n[i].rewardPKey==t&&n[i].setRewardSelected(r)},e}();t.RewardCache=s},237:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SETTINGS=void 0;var n,i,a=r(346);(n=t.SETTINGS||(t.SETTINGS={})).DIC_META_META_COLUMNS=new a.Dictionary,n.DIC_META_META_COLUMNS.add("Price",2),n.DIC_META_META_COLUMNS.add("FixAmount",2),n.DIC_META_META_COLUMNS.add("Percentage",2),n.DIC_META_META_COLUMNS.add("FlatRate",2),n.DIC_META_META_COLUMNS.add("LastVldVal",1),n.DIC_META_META_COLUMNS.add("Summation",1),n.DIC_META_META_COLUMNS.add("Add",1),n.DIC_META_META_COLUMNS.add("Minimum",1),n.DIC_META_META_COLUMNS.add("Maximum",1),n.DIC_META_META_COLUMNS.add("FreeGood",1),n.DIC_META_META_COLUMNS.add("AddFreeItm",1),n.DIC_META_META_COLUMNS.add("MultiBuy",1),n.DIC_META_META_COLUMNS.add("UserExit",1),n.SALES_ORG="0001",n.ADDITIONAL_PRICING_INFO_ATTRIBUTE="additionalPricingInfo",n.UOMROUNDINGFACTOR=3,n.LOG_ENABLED=!0,n.LOG_FLUSH=!1,n.PRICING_DATASOURCE="DsComplexPricing",n.LOG_CONDITION_CACHE_STEP_SIZE=100,(i=n.QueryNames||(n.QueryNames={})).CALCULATIONSTEPS="CndCpReadCalculationSteps",i.CUSTOMERATTRIBUTES="CndCpReadCustomerAttributes",i.CUSTOMERHIERARCHY="CndCpReadCustomerHierarchy",i.CUSTOMERSETS="CndCpReadBpaSets",i.CUSTOMERPROMOTIONS="CndCpReadPromotions",i.CUSTOMERREWARDS="CndCpReadRewards",i.PRODUCTINFORMATION="CndCpReadProductAttributes",i.PRODUCTUNITFACTORS="CpReadUnitFactors",i.ITEMMETARULES="CndCpReadItemMetaUsage",i.KEYTYPES="CndCpReadKeyTypes",i.PRODUCTASSORTMENTS="CndCpReadPrdAssortments",i.CURRENCYCONVERSION="CndCpReadCurrencyConversionFactor"},346:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.parseReference=t.isDefined=t.isEmptyString=t.arrayToCommaSeperatedList=t.listToCommaSeperatedList=t.round=t.List=t.Dictionary=void 0;var r=function(){function e(){this.data={},this.len=0,this.keyList=new n}return Object.defineProperty(e.prototype,"length",{get:function(){return this.len},enumerable:!1,configurable:!0}),e.prototype.fill=function(e,t,r){this.data=e,this.len=t,this.keyList=r},e.prototype.add=function(e,t){void 0!==this.data[e]?this.data[e]=t:(this.len++,this.data[e]=t,this.keyList.add(e))},e.prototype.update=function(e,t){this.data[e]=t},e.prototype.getItem=function(e){return void 0===this.data[e]?null:this.data[e]},e.prototype.getSortedKeys=function(){return Object.keys(this.data).sort()},e.prototype.getKeysSortedByValueDesc=function(){var e=this;return Object.keys(this.data).sort((function(t,r){return e.data[t]>e.data[r]?-1:e.data[t]<e.data[r]?1:0}))},e.prototype.getItems=function(){return this.data},e.prototype.remove=function(e){this.data[e]=void 0,this.len--;for(var t=new n,r=0;r<this.keyList.length;r++)this.keyList.toArray()[r]!==e&&t.add(this.keyList.toArray()[r]);this.keyList=t},e.prototype.contains=function(e){return void 0!==this.data[e]},e.prototype.forEach=function(e){for(var t in this.data)void 0!==this.data[t]&&e(this.data[t])},Object.defineProperty(e.prototype,"keyValuePairs",{get:function(){var e=[];for(var t in this.data){var r={};r.key=t,r.value=this.data[t],e.push(r)}return e},enumerable:!1,configurable:!0}),e.prototype.clear=function(){this.len=0,this.data={},this.keyList=new n},e}();t.Dictionary=r;var n=function(){function e(e){this.list=[],this.list=e||[]}return Object.defineProperty(e.prototype,"length",{get:function(){return this.list.length},enumerable:!1,configurable:!0}),e.prototype.add=function(e){this.list.push(e)},e.prototype.addRange=function(e){if(arguments.length>1){for(var t=[],r=0;r<arguments.length-0;r++)t[r]=arguments[r+0];e=t}for(var n=0;n<e.length;n++)this.list.push(e[n])},e.prototype.clear=function(){this.list=[]},e.prototype.contains=function(e){for(var t=0;t<this.list.length;t++)if(this.list[t]===e)return!0;return!1},e.prototype.convertAll=function(t){for(var r=new e,n=0;n<this.list.length;n++)r.add(t(this.list[n]));return r},e.prototype.find=function(e){for(var t=0;t<this.list.length;t++)if(e(this.list[t]))return this.list[t];return null},e.prototype.findAll=function(t){for(var r=new e,n=0;n<this.list.length;n++)t(this.list[n])&&r.add(this.list[n]);return r},e.prototype.findIndex=function(e,t){void 0===t&&(t=0);for(var r=t||0;r<this.list.length;r++)if(e(this.list[r]))return r;return-1},e.prototype.findLastIndex=function(e,t){void 0===t&&(t=this.length-1);for(var r=t;r>-1;r--)if(e(this.list[r]))return r;return-1},e.prototype.forEach=function(e){for(var t=0;t<this.list.length;t++)e(this.list[t])},e.prototype.getItem=function(e){if(this.list[e])return this.list[e]},e.prototype.setItem=function(e,t){this.list[e]=t},e.prototype.toArray=function(){for(var e=[],t=0;t<this.list.length;t++)e.push(this.list[t]);return e},e.prototype.trueForAll=function(t){new e;for(var r=0;r<this.list.length;r++)if(!t(this.list[r]))return!1;return!0},e.prototype.sortList=function(e){var t,r;this.list.sort((r=1,"-"===(t=e)[0]&&(r=-1,t=t.substr(1)),function(e,n){return(e[t]<n[t]?-1:e[t]>n[t]?1:0)*r}))},e}();function i(e){return!a(e)||("string"==typeof e&&(e=e.trim()),""===e)}function a(e){return void 0!==e&&null!=e}t.List=n,t.round=function(e,t,r){var n=e,i=!1;switch(e<0&&"0"!==r&&(i=!0,e=Math.abs(e)),r){case"1":n=+(Math.floor(+(e*Math.pow(10,t)+.5).toFixed(8))/Math.pow(10,t)).toFixed(t);break;case"2":n=+(Math.ceil(+(e*Math.pow(10,t)).toFixed(8))*Math.pow(10,-1*t)).toFixed(t);break;case"3":n=+(Math.floor(+(e*Math.pow(10,t)).toFixed(8))*Math.pow(10,-1*t)).toFixed(t)}return i&&(n*=-1),n},t.listToCommaSeperatedList=function(e,t){void 0===t&&(t="','");var r=new Array;return e.forEach((function(e){r.push(e)})),"'"+r.join(t)+"'"},t.arrayToCommaSeperatedList=function(e,t){return void 0===t&&(t="','"),"'"+e.join(t)+"'"},t.isEmptyString=i,t.isDefined=a,t.parseReference=function(e,t){var r=new n;if(i(e))return r;for(var a=e.split(","),o=0;o<a.length;o++)if(a[o].indexOf("-")>-1){var s=a[o].split("-"),c=0,u=0;if(!i(s[0])&&!i(s[1])&&+s[0]<+s[1]){c=+s[0],u=+s[1];for(var l=c;l<=u;l++)t.contains(l.toString())&&r.add(l)}}else t.contains(a[o])&&r.add(+a[o]);return r}},601:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ScaleType=t.UoMConversionFactorCache=t.UoMConversionFactor=t.ConditionXMLContent=t.Scale=t.FreeItemScale=t.Condition=t.ConditionContainer=void 0;var n=r(121),i=r(346),a=r(237),o=function(){function e(){if(this.MODULE_NAME="ConditionContainer",this.lConditions=new i.List,e._instance)throw new Error("Error: Instantiation failed: Use API.getInstance() instead of new.");e._instance=this}return e.getInstance=function(){return null===e._instance&&(e._instance=new e),e._instance},e.prototype.setStepInformation=function(e,t,r,n){this.lConditions.length>0&&(this.lConditions.getItem(this.lConditions.length-1).keyType=e,this.lConditions.getItem(this.lConditions.length-1).sKeyTypePKey=t,this.lConditions.getItem(this.lConditions.length-1).sMergedKey=r,this.lConditions.getItem(this.lConditions.length-1).origCondition=n.condition,this.lConditions.getItem(this.lConditions.length-1).runtime=n.runtime)},Object.defineProperty(e.prototype,"Condition",{get:function(){return this.lConditions},set:function(e){this.lConditions=e},enumerable:!1,configurable:!0}),e.prototype.addNewCondition=function(e,t,r,i,o,c,u,l){void 0===c&&(c=!1),void 0===u&&(u=!1),void 0===l&&(l=null),a.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("addNewCondition",this.MODULE_NAME),this.lConditions.add(new s(e,t,r,i,o,c,u,l)),a.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("addNewCondition",this.MODULE_NAME)},e.prototype.addCondition=function(e){a.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("addCondition",this.MODULE_NAME),this.lConditions.add(e),this.lConditions.sortList("SortOn"),a.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("addCondition",this.MODULE_NAME)},e.prototype.clear=function(){this.lConditions.clear()},e._instance=null,e}();t.ConditionContainer=o;var s=function(){function e(e,t,r,n,i,a,o,s,c){void 0===e&&(e=" "),void 0===t&&(t=" "),void 0===r&&(r=" "),void 0===n&&(n=" "),void 0===i&&(i=0),void 0===a&&(a=!1),void 0===o&&(o=!1),void 0===s&&(s=!1),void 0===c&&(c=[]),this.MODULE_NAME="ConditionContainer.Condition",this.sMergedKey="",this.origCondition=null,this.lScales=[],this.bValidScaleFound=!1,this.dTotal=0,this.runtime=0,this.dCBase=0,this.dCResult=0,this.dGroupingRefValue=0,this.manual=!1,this.bConditionFound=!0,this.graduatedSteps=null,this.graduatedResults=[],this.sSortOn="",this.bFreeItem=s,this.sKeyTypePKey=e,this.sOriginalCurrency=t,this.sOriginalUnit=r,this.sUnit=this.sOriginalUnit,this.unitFactor=1,this.bCurrencyConverted=a,this.bUnitConverted=o,this.sOriginalConditionValue=n,this.dCValue=i,this.lScales=c}return e.prototype.addSearchData=function(e,t,r,i){a.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().start("parseConditionContent",this.MODULE_NAME),this.sNo=e,this.KeyTypeID=t,this.sMergedKey=r,this.runtime=i,a.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().end("parseConditionContent",this.MODULE_NAME)},e.prototype.addGraduatedCalculation=function(e,t,r,n){this.graduatedResults.push({CBase:e,CValue:t,CResult:r,Total:n})},e.prototype.clone=function(){return JSON.parse(JSON.stringify(this))},Object.defineProperty(e.prototype,"ScaleCompareValue",{get:function(){return this.dScaleCompareValue},set:function(e){this.dScaleCompareValue=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ValidScaleFound",{get:function(){return this.bValidScaleFound},set:function(e){this.bValidScaleFound=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Unit",{get:function(){return this.sUnit},set:function(e){this.sUnit=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ScaleList",{get:function(){return this.lScales},set:function(e){this.lScales=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"GroupingRefValue",{get:function(){return this.dGroupingRefValue},set:function(e){this.dGroupingRefValue=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"UnitFactor",{get:function(){return this.unitFactor},set:function(e){this.unitFactor=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"IsFreeItem",{get:function(){return this.bFreeItem},set:function(e){this.bFreeItem=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"IsCurrencyConverted",{get:function(){return this.bCurrencyConverted},set:function(e){this.bCurrencyConverted=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"CBase",{get:function(){return this.dCBase},set:function(e){this.dCBase=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"CValue",{get:function(){return this.dCValue},set:function(e){this.dCValue=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"CResult",{get:function(){return this.dCResult},set:function(e){this.dCResult=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Total",{get:function(){return this.dTotal},set:function(e){this.dTotal=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"UserExitId",{get:function(){return this.sUserExit},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"V1",{get:function(){return this.dV1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"V2",{get:function(){return this.dV2},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"V3",{get:function(){return this.dV3},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"V4",{get:function(){return this.dV4},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"V5",{get:function(){return this.dV5},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"V6",{get:function(){return this.dV6},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Manual",{get:function(){return this.manual},set:function(e){this.manual=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ThresholdUnit",{get:function(){return this.sThresholdUnit},set:function(e){this.sThresholdUnit=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"OriginalUnit",{get:function(){return this.sOriginalUnit},set:function(e){this.sOriginalUnit=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Denominator",{get:function(){return this.iDenominator},set:function(e){this.iDenominator=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"SortOn",{get:function(){return this.sSortOn},set:function(e){this.sSortOn=e},enumerable:!1,configurable:!0}),e}();t.Condition=s;t.FreeItemScale=function(e,t,r,n,i,a){this.ItemCompareValue=e,this.FreeItemScaleValue=t,this.FreeItemPrdMainPKey=n,this.FreeItemUnit=i,this.FreeItemQuantity=r,this.OriginalFreeItemQuantity=a};var c=function(){function e(){this.bXMLRelevat=!1,this.dScaleRate=0,this.dOrigScaleResult=0,this.iScaleValue=0}return e.prototype.setCalculationResult=function(e,t,r,n,a,o){this.bXMLRelevat=!0,this.dCBase=e,this.dCResult=r,this.dCValue=i.round(t,a,o),this.dTotal=i.round(n,a,o)},Object.defineProperty(e.prototype,"PrdMainPKey",{get:function(){return this.sPrdMainPKey},set:function(e){this.sPrdMainPKey=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"CBase",{get:function(){return this.dCBase},set:function(e){this.dCBase=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"CValue",{get:function(){return this.dCValue},set:function(e){this.dCValue=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"CResult",{get:function(){return this.dCResult},set:function(e){this.dCResult=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Total",{get:function(){return this.dTotal},set:function(e){this.dTotal=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"XMLRelevant",{get:function(){return this.bXMLRelevat},set:function(e){this.bXMLRelevat=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"UnitFreeItem",{get:function(){return this.sUnitFreeItem},set:function(e){this.sUnitFreeItem=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ScaleValue",{get:function(){return this.iScaleValue},set:function(e){this.iScaleValue=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"ScaleRate",{get:function(){return this.dScaleRate},set:function(e){this.dScaleRate=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"OrigScaleResult",{get:function(){return this.dOrigScaleResult},set:function(e){this.dOrigScaleResult=e},enumerable:!1,configurable:!0}),e}();t.Scale=c;t.ConditionXMLContent=function(){this.bIsScale=!1,this.lScales=new i.List};var u=function(){function e(){this.unitTypeOrderUnit="UNDEFINED",this.unitTypeConsumerUnit="UNDEFINED",this.isPDARelevantUOM=!1,this.dicFactors=new i.Dictionary}return e.prototype.addFactor=function(e,t){this.dicFactors.contains(e)||this.dicFactors.add(e,t)},e.prototype.getFactor=function(e){return this.dicFactors.contains(e)?this.dicFactors.getItem(e):-1},Object.defineProperty(e.prototype,"FactorPriceUnit",{get:function(){return this.factorPriceUnit},set:function(e){this.factorPriceUnit=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"FactorOrderUnit",{get:function(){return this.factorOrderUnit},set:function(e){this.factorOrderUnit=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"FactorConsumerUnit",{get:function(){return this.factorConsumerUnit},set:function(e){this.factorConsumerUnit=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"FactorStockTackingUnit",{get:function(){return this.factorStockTackingUnit},set:function(e){this.factorStockTackingUnit=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"UnitTypeOrderUnit",{set:function(e){this.unitTypeOrderUnit=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"UnitTypeConsumerUnit",{set:function(e){this.unitTypeConsumerUnit=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Weight",{get:function(){return this.weight},set:function(e){this.weight=e},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"Volume",{get:function(){return this.volume},set:function(e){this.volume=e},enumerable:!1,configurable:!0}),e.prototype.PDARelevant=function(e){return e===this.unitTypeOrderUnit||e===this.unitTypeConsumerUnit},e}();t.UoMConversionFactor=u;var l,d=function(){function e(){this.dicUoMFactors=new i.Dictionary}return e.prototype.addProduct=function(e,t,r){var i,o;a.SETTINGS.LOG_ENABLED&&n.LogHandler.getInstance().message("Add Product to UnitFactorCache - PrdMainPKey: "+e+" - UoM: "+t);for(var s,c=0,l=0;l<r.length;l++){o=(i=r[l]).UnitType,c=+i.PiecesPerSmallestUnit;for(var d=new u,p=0;p<r.length;p++){var h=r[p];s=c/+h.PiecesPerSmallestUnit,d.addFactor(h.UnitType,s),"1"==h.IsPriceUnit&&(d.FactorPriceUnit=s,d.Weight=s*h.CndCpWeight,d.Volume=s*h.CndCpVolume),"1"==h.IsConsumerUnit&&(d.FactorConsumerUnit=s,d.UnitTypeConsumerUnit=h.UnitType),"1"==h.IsOrderUnit&&(d.FactorOrderUnit=s,d.UnitTypeOrderUnit=h.UnitType)}this.dicUoMFactors.contains(e+o)||this.dicUoMFactors.add(e+o,d)}},e.prototype.containsFactor=function(e,t){return this.dicUoMFactors.contains(e+t)},e.prototype.getPriceUnitFactor=function(e,t){return this.dicUoMFactors.contains(e+t)?this.dicUoMFactors.getItem(e+t).FactorPriceUnit:-1},e.prototype.getConsumerUnitFactor=function(e,t){return this.dicUoMFactors.contains(e+t)?this.dicUoMFactors.getItem(e+t).FactorConsumerUnit:-1},e.prototype.getConsumerOrderFactor=function(e,t){return this.dicUoMFactors.contains(e+t)?this.dicUoMFactors.getItem(e+t).FactorOrderUnit:-1},e.prototype.getStocktackingFactor=function(e,t){return this.dicUoMFactors.contains(e+t)?this.dicUoMFactors.getItem(e+t).FactorStockTackingUnit:-1},e.prototype.getUnitFactor=function(e,t,r){return this.dicUoMFactors.contains(e+t)?this.dicUoMFactors.getItem(e+t).getFactor(r):-1},e.prototype.getPDARelevanceOfUnit=function(e,t,r){return!!this.dicUoMFactors.contains(e+t)&&this.dicUoMFactors.getItem(e+t).PDARelevant(r)},e.prototype.getWeight=function(e,t){return this.dicUoMFactors.contains(e+t)?this.dicUoMFactors.getItem(e+t).Weight:-1},e.prototype.getVolume=function(e,t){return this.dicUoMFactors.contains(e+t)?this.dicUoMFactors.getItem(e+t).Volume:-1},e}();t.UoMConversionFactorCache=d,(l=t.ScaleType||(t.ScaleType={}))[l.NoScale=0]="NoScale",l[l.FromScale=1]="FromScale",l[l.ToScale=2]="ToScale",l[l.Graduated=3]="Graduated"}},t={},r=function r(n){var i=t[n];if(void 0!==i)return i.exports;var a=t[n]={exports:{}};return e[n](a,a.exports,r),a.exports}(510);CP=r})();]]>
</Code>
</Plugin>